<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù‚Ø¹Ø¯Ø© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ù‚Ø¹Ø¯Ø©">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ²</text></svg>">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#f43f5e">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="gameData.js"></script>
    <style>
        * { 
            font-family: 'Cairo', sans-serif; 
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #f8f9fa;
            background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px), radial-gradient(#cbd5e1 1.5px, #f8f9fa 1.5px);
            background-size: 24px 24px;
            background-position: 0 0, 12px 12px;
            overscroll-behavior: none; /* Controlled bounce - prevents pull-to-refresh */
            user-select: none;
            margin: 0;
            padding: 0;
        }
        
        #app {
            min-height: 100vh; /* Allow natural rubber band effect */
        }
        
        /* Hide scrollbars */
        ::-webkit-scrollbar { 
            width: 0px; 
            background: transparent; 
        }
        
        /* Smooth iOS scrolling for scroll containers */
        .scroll-container {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Page Transitions - Snappy Entry Animation */
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(10px) scale(0.98); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        .animate-enter {
            animation: slideIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        
        /* Legacy Animation Support */
        .animate-in { animation: slideIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .animate-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .rotate-90-text { transform: rotate(90deg); white-space: nowrap; }
        .bomb-pulse { animation: bomb 0.5s infinite; }
        @keyframes bomb { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        /* Floating Point Animation */
        .floating-point {
            position: fixed;
            font-size: 2.5rem;
            font-weight: 900;
            color: #10b981;
            text-shadow: 0 2px 8px rgba(16, 185, 129, 0.5);
            pointer-events: none;
            z-index: 9999;
            animation: floatUp 1.5s ease-out forwards;
        }
        @keyframes floatUp {
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(-40px) scale(1.2);
            }
            100% { 
                opacity: 0; 
                transform: translateY(-100px) scale(0.8);
            }
        }
        
        /* Confetti Particle */
        .confetti-particle {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 9998;
            animation: confettiFall 2s ease-out forwards;
        }
        @keyframes confettiFall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        /* Surprise Me Button Gradient */
        .surprise-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen">
        <div class="max-w-md mx-auto min-h-screen shadow-2xl bg-white/95 backdrop-blur-sm relative overflow-hidden border-x-2 border-slate-100 flex flex-col">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-rose-500 via-amber-400 to-indigo-500 z-50"></div>
            
            <!-- Global Controls - Vertical Glass Bar -->
            <div id="control-bar" class="fixed top-4 left-4 z-50 flex flex-col items-center bg-white/25 backdrop-blur-lg border border-white/30 shadow-lg rounded-full p-2 gap-2 transition-all hover:bg-white/35">
                <!-- Sound Button (Top) -->
                <button onclick="toggleMute()" id="muteBtn" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/50 hover:scale-110 hover:bg-white/70 transition-all shadow-sm text-gray-800">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
                </button>
                
                <!-- Home Button (Bottom) -->
                <button onclick="goHome()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/50 hover:scale-110 hover:bg-white/70 transition-all shadow-sm text-gray-800">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                </button>
            </div>

            <div id="screen-container" class="flex-1 flex flex-col h-full overflow-hidden"></div>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let gameInterval = null; 

        // ===== STATE =====
        let state = {
            screen: 'home',
            isMuted: false,
            daresEnabled: false,
            teamMode: false, // ÙˆØ¶Ø¹ Ø§Ù„ÙØ±Ù‚
            teamsSetupTab: 'A', // Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø· ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØ±Ù‚
            players: [
                { id: 1, name: 'Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù¡', score: 0 },
                { id: 2, name: 'Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù¢', score: 0 },
                { id: 3, name: 'Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù£', score: 0 }
            ],
            teams: [
                { id: 'A', name: 'ÙØ±ÙŠÙ‚ Ø£', score: 0, color: 'text-rose-600', members: [] },
                { id: 'B', name: 'ÙØ±ÙŠÙ‚ Ø¨', score: 0, color: 'text-indigo-600', members: [] }
            ],
            turnQueue: [], // For fair distribution
            usedItems: {}, // Track used content per category (No-Repeat System)
            currentGame: null
        };

        // ===== LOCAL STORAGE FUNCTIONS =====
        function saveState() {
            try {
                localStorage.setItem('party_game_v1', JSON.stringify(state));
            } catch (e) {
                console.error('Save failed:', e);
            }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('party_game_v1');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Merge saved state with defaults to ensure all fields exist
                    state = { ...state, ...parsed };
                    
                    // Fix: Check if there's an active game in progress
                    const hasActiveGame = state.currentGame && 
                                         state.currentGame.phase && 
                                         state.currentGame.phase !== 'result';
                    
                    if (hasActiveGame) {
                        // Show confirm dialog to user
                        const continueGame = confirm('Ù‡Ù†Ø§Ùƒ Ù„Ø¹Ø¨Ø© Ø¬Ø§Ø±ÙŠØ©ØŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙƒÙ…Ø§Ù„Ù‡Ø§ØŸ');
                        
                        if (!continueGame) {
                            // User chose not to continue - reset to home
                    state.screen = 'home';
                            state.currentGame = null;
                        }
                        // else: keep current screen and game state as-is
                    } else {
                        // No active game - always start at home
                        state.screen = 'home';
                        state.currentGame = null;
                    }
                    
                    // Recalculate team scores from player scores (ensures data integrity)
                    if (state.teamMode) {
                        recalculateTeamScores();
                    }
                    
                    // Ensure queues are properly restored
                    if (!state.turnQueue) state.turnQueue = [];
                    if (!state.usedItems) state.usedItems = {};
                    if (!state.shuffledQueue) state.shuffledQueue = [];
                    if (state.turnIndex === undefined) state.turnIndex = 0;
                }
            } catch (e) {
                console.error('Load failed:', e);
            }
        }

        // ===== AUDIO =====
        // Initialize Audio Context (singleton pattern to prevent memory leaks)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playTone(freq, type, duration) {
            if (state.isMuted) return;
            
            // Fix race condition: Check if audioCtx is valid
            if (!audioCtx) return;
            
            try {
            if (audioCtx.state === 'suspended') audioCtx.resume(); // Fix for Chrome autoplay policy

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = type; // 'sine', 'square', 'sawtooth', 'triangle'
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start();
            osc.stop(audioCtx.currentTime + duration);
                
                // Ensure garbage collection: disconnect nodes after use
                setTimeout(() => {
                    osc.disconnect();
                    gain.disconnect();
                }, (duration * 1000) + 100);
            } catch (e) {
                // Silently fail if audio context issues occur
                console.warn('Audio playback failed:', e);
            }
        }

        function playSound(type) {
            if (state.isMuted) return;

            switch (type) {
                case 'tick':
                    playTone(800, 'square', 0.05); // Short tick
                    break;
                case 'click':
                    playTone(600, 'sine', 0.05); // Soft click
                    break;
                case 'success':
                    // High pitch "Ding"
                    playTone(1200, 'sine', 0.1);
                    setTimeout(() => playTone(1800, 'sine', 0.2), 100);
                    break;
                case 'fail':
                    // Low pitch "Buzz"
                    playTone(300, 'sawtooth', 0.3);
                    setTimeout(() => playTone(250, 'sawtooth', 0.3), 150);
                    break;
                case 'bomb':
                    // Rapid warning beeps
                    playTone(800, 'square', 0.1);
                    setTimeout(() => playTone(600, 'square', 0.3), 100);
                    break;
                case 'bomb_tick':
                    // Short urgent beep for bomb timer
                    playTone(1000, 'square', 0.08);
                    break;
                case 'explode':
                    // Explosion effect - descending noise
                    playTone(200, 'sawtooth', 0.5);
                    setTimeout(() => playTone(100, 'sawtooth', 0.5), 100);
                    break;
                case 'win':
                    // Victory melody
                    playTone(500, 'sine', 0.2);
                    setTimeout(() => playTone(700, 'sine', 0.2), 200);
                    setTimeout(() => playTone(1000, 'sine', 0.4), 400);
                    break;
            }
        }

        // ===== HELPERS =====
        // XSS Prevention: Sanitize user input before rendering
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleMute() {
            state.isMuted = !state.isMuted;
            const btn = document.getElementById('muteBtn');
            
            if (state.isMuted) {
                // Muted: Red background with X icon
                btn.className = 'p-2 bg-red-100 rounded-full shadow-md text-red-500 hover:bg-red-200 transition';
                btn.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>';
            } else {
                // Unmuted: Normal style with speaker icon
                btn.className = 'p-2 bg-white rounded-full shadow-md text-slate-600 hover:bg-slate-50 transition';
                btn.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>';
            }
            
            saveState();
            playSound('click');
        }
        function goHome() { 
            playSound('click'); 
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
            // Fix memory leak: Clear tips interval
            if (window.tipsInterval) {
                clearInterval(window.tipsInterval);
                window.tipsInterval = null;
            }
            state.currentGame = null; 
            saveState();
            navigate('home'); 
        }
        // Navigate with instant snappy transition
        function navigate(screen) { 
            playSound('click'); 
            // âš ï¸ CRITICAL: Stop any running game timers immediately
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
            // Fix memory leak: Clear tips interval when navigating away
            if (window.tipsInterval) {
                clearInterval(window.tipsInterval);
                window.tipsInterval = null;
            }
            state.screen = screen; 
            render(); // Immediate render with entry animation
        }

        // Random Game Selector
        function surpriseMe() {
            // DYNAMIC GAME DISCOVERY: Query the DOM for actual game buttons
            const gameButtons = document.querySelectorAll('button[onclick*="navigate("]');
            const allGames = [];
            
            gameButtons.forEach(button => {
                try {
                    // Extract game ID from onclick attribute
                    const onclickAttr = button.getAttribute('onclick');
                    const match = onclickAttr.match(/navigate\(['"]([^'"]+)['"]\)/);
                    
                    if (!match) return;
                    const gameId = match[1];
                    
                    // Skip non-game screens (players, scores, etc.)
                    if (!gameId.includes('_setup')) return;
                    
                    // Extract emoji from the button (first div with large text)
                    const emojiDiv = button.querySelector('div.text-5xl, div[style*="font-size: 40px"]');
                    const emoji = emojiDiv ? emojiDiv.textContent.trim() : 'ğŸ®';
                    
                    // Extract title (look for the bold text/span)
                    const titleSpan = button.querySelector('span.text-lg, span[style*="font-weight: bold"]');
                    const name = titleSpan ? titleSpan.textContent.trim() : gameId;
                    
                    // Extract color from button classes
                    const classList = button.className;
                    const colorMatch = classList.match(/(bg-[a-z]+-\d+)/);
                    const color = colorMatch ? colorMatch[1] : 'bg-slate-700';
                    
                    allGames.push({
                        id: gameId,
                        name: name,
                        emoji: emoji,
                        color: color
                    });
                } catch (e) {
                    console.warn('Failed to parse game button:', e);
                }
            });
            
            // Ensure we have games
            if (allGames.length === 0) {
                console.error('No valid games found in DOM!');
                return;
            }
            
            console.log('âœ… Discovered games:', allGames.length, allGames.map(g => g.id));
            
            // Fisher-Yates shuffle for true randomness
            function shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
            
            // Pick the winner FIRST
            const winner = allGames[Math.floor(Math.random() * allGames.length)];
            console.log('ğŸ¯ Winner selected:', winner.id, winner.name);
            
            // Shuffle and pick 9 UNIQUE games for the grid
            const shuffled = shuffleArray(allGames);
            let gridGames = [];
            
            // Add winner first
            gridGames.push(winner);
            
            // Add 8 more unique games (different from winner)
            for (let i = 0; i < shuffled.length && gridGames.length < 9; i++) {
                if (shuffled[i].id !== winner.id) {
                    gridGames.push(shuffled[i]);
                }
            }
            
            // Final shuffle of the grid so winner isn't always first
            gridGames = shuffleArray(gridGames);
            
            console.log('ğŸ“‹ Grid games:', gridGames.map(g => g.id));
            
            // Create lightweight overlay (solid background, no blur)
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(255, 255, 255, 0.95);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease-out;
            `;
            
            // Create container
            const container = document.createElement('div');
            container.style.cssText = `
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 24px;
                padding: 24px;
            `;
            
            // Add title
            const title = document.createElement('div');
            title.style.cssText = `
                font-size: 28px;
                font-weight: 900;
                color: #1e293b;
                text-align: center;
            `;
            title.textContent = 'ğŸ² ÙØ§Ø¬Ø¦Ù†ÙŠ ğŸ²';
            container.appendChild(title);
            
            // Create 3x3 grid
            const grid = document.createElement('div');
            grid.style.cssText = `
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                width: 320px;
            `;
            
            // Create game cards with lightweight styling
            gridGames.forEach((game, index) => {
                const card = document.createElement('div');
                card.className = `roulette-card ${game.color}`;
                card.style.cssText = `
                    width: 100px;
                    height: 100px;
                    border-radius: 16px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    border: 4px solid transparent;
                    transition: border-color 0.15s ease;
                `;
                card.dataset.index = index;
                card.innerHTML = `
                    <div style="font-size: 40px; margin-bottom: 4px;">${game.emoji}</div>
                    <div style="font-size: 12px; font-weight: bold; text-align: center; padding: 0 8px; line-height: 1.2;">${game.name}</div>
                `;
                grid.appendChild(card);
            });
            
            container.appendChild(grid);
            
            // Result text (hidden initially)
            const resultText = document.createElement('div');
            resultText.style.cssText = `
                font-size: 22px;
                font-weight: bold;
                color: #1e293b;
                text-align: center;
                min-height: 32px;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            container.appendChild(resultText);
            
            overlay.appendChild(container);
            document.body.appendChild(overlay);
            
            // Trigger fade-in
            requestAnimationFrame(() => {
                overlay.style.opacity = '1';
            });
            
            // Roulette animation logic (optimized)
            let currentIndex = -1;
            let iterations = 0;
            const totalIterations = 20; // Reduced for better performance
            const startDelay = 100; // Start at 100ms (not faster)
            const maxDelay = 300; // End at 300ms
            
            const cards = grid.querySelectorAll('.roulette-card');
            const winnerIndex = gridGames.findIndex(g => g.id === winner.id);
            
            function setActiveCard(index) {
                // Remove active state from all cards (lightweight operation)
                cards.forEach(card => {
                    card.style.borderColor = 'transparent';
                    card.style.backgroundColor = '';
                });
                
                // Add active state to current card (simple border change only)
                if (index >= 0) {
                    const card = cards[index];
                    card.style.borderColor = '#fcd34d'; // Yellow border
                    card.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                    
                    // Play tick sound (only if not near end)
                    if (iterations < totalIterations - 3) {
                        playTone(700, 'sine', 0.03);
                    }
                }
            }
            
            function animate() {
                iterations++;
                
                // Calculate delay with linear slowdown (simpler math)
                const progress = iterations / totalIterations;
                const delay = startDelay + (maxDelay - startDelay) * progress;
                
                // Decide next index
                if (iterations < totalIterations - 3) {
                    // Random jump
                    currentIndex = Math.floor(Math.random() * 9);
                } else if (iterations < totalIterations) {
                    // Last few jumps, hover near winner
                    const neighbors = [
                        winnerIndex,
                        (winnerIndex + 1) % 9,
                        (winnerIndex - 1 + 9) % 9
                    ];
                    currentIndex = neighbors[Math.floor(Math.random() * neighbors.length)];
                } else {
                    // Final stop on winner
                    currentIndex = winnerIndex;
                    stopAnimation();
                    return;
                }
                
                setActiveCard(currentIndex);
                setTimeout(animate, delay);
            }
            
            function stopAnimation() {
                // Final highlight on winner
                setActiveCard(winnerIndex);
                
                // Winner effects (lightweight)
                setTimeout(() => {
                    const winnerCard = cards[winnerIndex];
                    
                    // Simple flash effect (toggle border thickness)
                    let flashCount = 0;
                    const flashInterval = setInterval(() => {
                        if (flashCount % 2 === 0) {
                            winnerCard.style.borderWidth = '6px';
                            winnerCard.style.borderColor = '#fbbf24';
                        } else {
                            winnerCard.style.borderWidth = '4px';
                            winnerCard.style.borderColor = '#fcd34d';
                        }
                        flashCount++;
                        if (flashCount >= 6) {
                            clearInterval(flashInterval);
                            winnerCard.style.borderWidth = '6px';
                            winnerCard.style.borderColor = '#fbbf24';
                        }
                    }, 150);
                    
                    // Play success sound
                    playSound('correct');
                    
                    // Show confetti
                    createConfetti();
                    
                    // Show result text
                    resultText.textContent = winner.name;
                    resultText.style.opacity = '1';
                    
                    // Navigate after delay
                    setTimeout(() => {
                        overlay.style.opacity = '0';
                        setTimeout(() => {
                            document.body.removeChild(overlay);
                            
                            // ROBUST NAVIGATION: Verify winner ID before navigating
                            console.log('ğŸš€ Navigating to winner:', winner.id, '(' + winner.name + ')');
                            
                            // Double-check the ID is valid
                            if (!winner.id || !winner.id.includes('_setup')) {
                                console.error('âŒ Invalid winner ID:', winner.id);
                                navigate('home');
                                return;
                            }
                            
                            // Navigate using the exact ID extracted from DOM
                            navigate(winner.id);
                        }, 300);
                    }, 1000);
                }, 100);
            }
            
            // Start animation after brief delay
            setTimeout(() => {
                animate();
            }, 400);
        }

        // Create floating +1 animation
        function createFloatingPoint(x, y, points) {
            const el = document.createElement('div');
            el.className = 'floating-point';
            el.textContent = `+${points}`;
            el.style.left = `${x}px`;
            el.style.top = `${y}px`;
            document.body.appendChild(el);
            
            // Remove after animation
            setTimeout(() => el.remove(), 1500);
        }

        // Create confetti burst
        function createConfetti() {
            const colors = ['#f43f5e', '#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899'];
            const confettiCount = 30;
            
            for (let i = 0; i < confettiCount; i++) {
                const el = document.createElement('div');
                el.className = 'confetti-particle';
                el.style.left = `${Math.random() * 100}%`;
                el.style.top = '-10px';
                el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                el.style.animationDelay = `${Math.random() * 0.5}s`;
                el.style.animationDuration = `${1.5 + Math.random()}s`;
                document.body.appendChild(el);
                
                // Remove after animation
                setTimeout(() => el.remove(), 3000);
            }
        }

        // Dynamic Team Score Calculation
        function recalculateTeamScores() {
            state.teams.forEach(team => {
                let total = 0;
                team.members.forEach(member => {
                    // Find the up-to-date player object from the master list
                    const realPlayer = state.players.find(p => p.id === member.id);
                    if (realPlayer) {
                        total += realPlayer.score;
                    }
                });
                team.score = total;
            });
        }

        function updateScore(id, isTeam, points = 1) {
            // 1. Update Player Score (Master Record)
            const playerIndex = state.players.findIndex(p => p.id === id);
            if (playerIndex !== -1) {
                state.players[playerIndex].score += points;
                
                // Visual feedback: Floating point animation
                const x = window.innerWidth / 2;
                const y = window.innerHeight / 2;
                createFloatingPoint(x, y, points);
                
                // Fix: Only trigger confetti for POSITIVE milestones
                if (points > 0 && state.players[playerIndex].score > 0 && state.players[playerIndex].score % 5 === 0) {
                    createConfetti();
                }
            }

            // 2. Recalculate Team Scores based on new player totals
            if (state.teamMode) {
                recalculateTeamScores();
                
                // Check for Team Confetti (Milestones)
                // Fix: Only trigger confetti for POSITIVE point gains
                state.teams.forEach(t => {
                    if (points > 0 && t.score > 0 && t.score % 5 === 0) {
                        // Team milestone reached
                        createConfetti();
                    }
                });
            }

            // Fix: Play appropriate sound based on points
            if (points > 0) {
            playSound('success');
            } else if (points < 0) {
                playSound('fail');
            }
            
            saveState();
            render(); // Update UI to show new scores
        }
        function showDare() {
            const dare = getUniqueItem('dares', DARES_LIST);
            playSound('fail');
            const modal = `<div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center border-4 border-red-500"><h2 class="text-2xl font-black text-red-600 mb-2">Ø¹Ù‚Ù€Ù€Ù€Ù€Ø§Ø¨!</h2><p class="text-xl font-bold text-slate-800 mb-6">"${dare}"</p><button onclick="this.closest('.fixed').remove()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">Ù†ÙØ°Øª Ø®Ù„Ø§Øµ</button></div></div>`;
            document.body.insertAdjacentHTML('beforeend', modal);
        }
        function getTimer(time) {
            if (time >= 60) { const mins = Math.floor(time / 60); const secs = time % 60; return `${mins}:${secs < 10 ? '0' : ''}${secs}`; }
            return time;
        }
        function header(title, backTo) {
            let teamBadge = '';
            if (state.teamMode && state.currentGame && state.currentGame.player) {
                const playerId = state.currentGame.player.id;
                const currentTeam = state.teams.find(t => t.members.some(m => m.id === playerId));
                if (currentTeam) {
                    const isTeamA = currentTeam.id === 'A';
                    const bgClass = isTeamA ? 'bg-rose-50 border-rose-200 text-rose-700' : 'bg-indigo-50 border-indigo-200 text-indigo-700';
                    teamBadge = `<div class="px-3 py-1.5 rounded-lg border ${bgClass} flex items-center gap-2 shadow-sm animate-in"><span class="text-xs font-black">Ø¯ÙˆØ± ${currentTeam.name}</span></div>`;
                }
            }
            return `<div class="flex flex-col gap-2 py-3 mb-2 border-b border-slate-100/80"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><button onclick="navigate('${backTo}')" class="p-2.5 bg-slate-50 rounded-xl hover:bg-slate-100 text-slate-600 transition active:scale-95"><svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button><h1 class="text-xl font-black text-slate-800 tracking-tight">${title}</h1></div>${teamBadge}</div></div>`;
        }

        // --- Fair Turn Logic (Persistent Queue System) ---
        function getFairPlayer() {
            // Safety check
            if (!state.players || state.players.length === 0) return { id: 0, name: 'Ù„Ø§Ø¹Ø¨' };

            // Initialize persistent queue system if needed
            if (!state.shuffledQueue) state.shuffledQueue = [];
            if (state.turnIndex === undefined) state.turnIndex = 0;

            // Check if we need to reshuffle (queue is empty, invalid, or index reached the end)
            const needsReshuffle = state.shuffledQueue.length === 0 || 
                                  state.turnIndex >= state.shuffledQueue.length ||
                                  state.shuffledQueue.length !== state.players.length;

            if (needsReshuffle) {
                // Create a new shuffled deck of all players
                let newQueue = [...state.players];
                
                // Fisher-Yates Shuffle for true randomness
                for (let i = newQueue.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newQueue[i], newQueue[j]] = [newQueue[j], newQueue[i]];
                }
                
                state.shuffledQueue = newQueue;
                state.turnIndex = 0;
            }

            // Get the current player and advance the index
            const currentPlayer = state.shuffledQueue[state.turnIndex];
            state.turnIndex++;

            // Save state to persist the queue across game switches
            saveState();

            return currentPlayer;
        }

        // --- No-Repeat Content System (Deck Logic) ---
        function getUniqueItem(categoryKey, sourceArray) {
            if (!state.usedItems) state.usedItems = {};
            if (!state.usedItems[categoryKey]) state.usedItems[categoryKey] = [];

            // Safety check: Prevent infinite loop if sourceArray is empty
            if (!sourceArray || sourceArray.length === 0) {
                console.error('getUniqueItem: sourceArray is empty for category:', categoryKey);
                return null; // Return null instead of recursing infinitely
            }

            // Filter available items
            // If items are objects, we use a unique property (like 'word' or 'id'), otherwise use the item itself
            const used = state.usedItems[categoryKey];
            
            // Helper to get ID/String for comparison
            const getId = (item) => (typeof item === 'object' ? (item.word || item.text || item.quote || JSON.stringify(item)) : item);

            let available = sourceArray.filter(item => !used.includes(getId(item)));

            if (available.length === 0) {
                // Deck exhausted! Reset.
                state.usedItems[categoryKey] = [];
                
                // Safety check: After reset, verify we have items to pick from
                available = sourceArray.filter(item => !state.usedItems[categoryKey].includes(getId(item)));
                
                if (available.length === 0) {
                    // This should never happen, but prevents infinite recursion
                    console.error('getUniqueItem: No items available after reset for category:', categoryKey);
                    // Return first item as fallback
                    return sourceArray[0];
                }
            }

            // Pick random from available
            const picked = available[Math.floor(Math.random() * available.length)];
            
            // Mark as used
            state.usedItems[categoryKey].push(getId(picked));
            
            return picked;
        }

        // --- NEW: Unified Game Start Screen ---
        function renderGameStartScreen(title, description, emoji, buttonText, startAction, colorClass) {
            return `
                <div class="p-6 h-screen flex flex-col ${colorClass} bg-opacity-10">
                    ${header(title, 'home')}
                    <div class="flex-1 flex flex-col justify-center items-center text-center">
                        <div class="text-6xl mb-6">${emoji}</div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-4">${title}</h2>
                        <p class="text-slate-600 max-w-sm mb-8 font-medium leading-relaxed">${description}</p>
                        <button onclick="${startAction}" class="w-full py-4 ${colorClass.replace('bg-opacity-10', '')} text-white rounded-xl font-bold text-xl shadow-lg transition transform active:scale-95 hover:brightness-110">
                            ${buttonText}
                        </button>
                    </div>
                </div>
            `;
        }

        // ===== RENDER =====
        function render() {
            const container = document.getElementById('screen-container');
            
            // Render the appropriate screen
            if (state.screen === 'home') container.innerHTML = renderHome();
            else if (state.screen === 'players') container.innerHTML = renderPlayers();
            else if (state.screen === 'scores') container.innerHTML = renderScores();
            else if (state.screen === 'teams_setup') container.innerHTML = renderTeamsSetup();
            // Games Setup
            else if (state.screen === 'lawyer_setup') container.innerHTML = renderLawyerSetup();
            else if (state.screen === 'indian_setup') container.innerHTML = renderIndianSetup();
            else if (state.screen === 'bomb_setup') container.innerHTML = renderBombSetup();
            else if (state.screen === 'taboo_setup') container.innerHTML = renderTabooSetup();
            else if (state.screen === 'story_setup') container.innerHTML = renderStorySetup();
            else if (state.screen === 'morph_setup') container.innerHTML = renderMorphSetup();
            else if (state.screen === 'artist_setup') container.innerHTML = renderArtistSetup();
            else if (state.screen === 'whisper_setup') container.innerHTML = renderWhisperSetup();
            else if (state.screen === 'never_setup') container.innerHTML = renderNeverSetup();
            else if (state.screen === 'debate_setup') container.innerHTML = renderDebateSetup();
            else if (state.screen === 'heads_up_setup') container.innerHTML = renderHeadsUpSetup();
            else if (state.screen === 'emoji_setup') container.innerHTML = renderEmojiSetup();
            else if (state.screen === 'lyrics_setup') container.innerHTML = renderLyricsSetup();
            else if (state.screen === 'unscramble_setup') container.innerHTML = renderUnscrambleSetup();
            else if (state.screen === 'spy_setup') container.innerHTML = renderSpySetup();
            else if (state.screen === 'charades_setup') container.innerHTML = renderCharadesSetup();
            else if (state.screen === 'quotes_setup') container.innerHTML = renderQuotesSetup();
            else if (state.screen === 'five_second_setup') container.innerHTML = renderFiveSecondSetup();
            else if (state.screen === 'bus_setup') container.innerHTML = renderBusSetup();
            else if (state.screen === 'liar_setup') container.innerHTML = renderLiarSetup();
            else if (state.screen === 'auction_setup') container.innerHTML = renderAuctionSetup();
            else if (state.screen === 'gibberish_setup') container.innerHTML = renderGibberishSetup();
            else if (state.screen === 'hum_setup') container.innerHTML = renderHumSetup();
            else if (state.screen === 'likely_setup') container.innerHTML = renderLikelySetup();
            
            // Force animation replay on every render
            container.classList.remove('animate-enter');
            void container.offsetWidth; // Trigger reflow (magic!)
            container.classList.add('animate-enter');
        }

        function renderHome() {
            return `
                <div class="flex flex-col h-full w-full bg-slate-50 relative">
                    
                    <div class="text-center pb-4 px-4 shrink-0 z-10 w-full" style="padding-top: calc(2rem + env(safe-area-inset-top));">
                        <h1 class="text-4xl font-black text-slate-800 mb-1">Ù„Ø¹Ø¨Ø© Ø§Ù„Ù‚Ø¹Ø¯Ø©</h1>
                        <p class="text-slate-500 font-medium">Ø§Ù„Ù„Ù…Ø© Ù…ØªØ­Ù„Ø§Ø´ ØºÙŠØ± Ø¨ÙŠÙ‡Ø§</p>
                    </div>
                    
                    <div class="px-4 mb-2 shrink-0 z-10">
                        <button onclick="surpriseMe()" class="w-full py-4 surprise-gradient text-white rounded-2xl font-black text-xl shadow-xl transition transform active:scale-95 flex items-center justify-center gap-3">
                            <span class="text-3xl">ğŸ²</span>
                            <span>ÙØ§Ø¬Ø¦Ù†ÙŠ! (Ù„Ø¹Ø¨Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©)</span>
                        </button>
                    </div>
                    
                    <div class="flex-1 w-full overflow-y-auto scroll-container px-4 pb-4">
                        <div class="grid grid-cols-2 gap-3 pb-2">
                            ${menuButton('lawyer_setup', 'ğŸ‘¨â€âš–ï¸', 'Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ Ø§Ù„Ù„Ø¹ÙŠÙ†', 'Ø¯Ø§ÙØ¹ Ø¹Ù† Ø§Ù„Ù…ØµÙŠØ¨Ø©', 'bg-slate-700')}
                            ${menuButton('indian_setup', 'ğŸ¬', 'Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ù‡Ù†Ø¯ÙŠ', 'ØªÙ…Ø«ÙŠÙ„ ÙˆØ£ÙˆÙØ±Ø©', 'bg-orange-600')}
                            ${menuButton('bomb_setup', 'ğŸ’£', 'Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©', 'Ø¨Ø§ØµÙŠ Ø¨Ø³Ø±Ø¹Ø©', 'bg-red-700')}
                            ${menuButton('taboo_setup', 'ğŸš«', 'Ø£ÙˆØ¹Ù‰ ØªÙ‚ÙˆÙ„Ù‡Ø§', 'Ù…Ù…Ù†ÙˆØ¹Ø§Øª ÙƒØªÙŠØ±', 'bg-rose-900')}
                            ${menuButton('story_setup', 'ğŸ“–', 'Ø­ÙƒØ§ÙŠØ© ÙÙŠ ÙƒÙ„Ù…ØªÙŠÙ†', 'Ø£Ù„ÙÙˆØ§ Ù‚ØµØ©', 'bg-amber-600')}
                            ${menuButton('artist_setup', 'ğŸ¨', 'Ø§Ù„Ø±Ø³Ø§Ù… Ø§Ù„Ø£Ø¹Ù…Ù‰', 'Ø§Ø±Ø³Ù… ÙˆØ®Ù…Ù†', 'bg-fuchsia-600')}
                            ${menuButton('morph_setup', 'ğŸ”¤', 'Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…ØªØ­ÙˆÙ„Ø©', 'ØºÙŠØ± Ø­Ø±Ù', 'bg-cyan-700')}
                            ${menuButton('whisper_setup', 'ğŸ§', 'Ø¥Ù‚Ø±Ø£ Ø´ÙØ§ÙŠÙÙŠ', 'Ø¹Ù„ÙŠ Ø§Ù„ØµÙˆØª', 'bg-pink-500')}
                            ${menuButton('debate_setup', 'âš–ï¸', 'Ù…Ø­ÙƒÙ…Ø©', 'Ø¥Ù‚Ù†Ø§Ø¹ ÙˆØ¬Ø¯Ø§Ù„', 'bg-amber-700')}
                            ${menuButton('never_setup', 'âœ‹', 'Ø£Ù†Ø§ Ø¹Ù…Ø±ÙŠ Ù…Ø§', 'Ù…ÙŠÙ† Ø¹Ù…Ù„ØŸ', 'bg-rose-800')}
                            ${menuButton('heads_up_setup', 'ğŸ¤¯', 'Ø¹Ù„Ù‰ Ø±Ø§Ø³ÙŠ', 'Ø­Ø· Ù…ÙˆØ¨Ø§ÙŠÙ„Ùƒ', 'bg-blue-600')}
                            ${menuButton('emoji_setup', 'ğŸ§©', 'ÙÙƒ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ', 'Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…ØŸ', 'bg-yellow-500')}
                            ${menuButton('lyrics_setup', 'ğŸ¤', 'ÙƒÙ…Ù„ Ø§Ù„Ø£ØºÙ†ÙŠØ©', 'Ø­Ø§ÙØ¸ØŸ', 'bg-purple-500')}
                            ${menuButton('unscramble_setup', 'ğŸ”€', 'Ø±ØªØ¨Ù‡Ø§ ØµØ­', 'ÙƒÙ„Ù…Ø© Ù…ØªÙ„Ø®Ø¨Ø·Ø©', 'bg-green-600')}
                            ${menuButton('five_second_setup', 'â±ï¸', 'Ø®Ù…Ø³Ø© Ø¹Ù„ÙŠÙƒ', '3 Ø­Ø§Ø¬Ø§Øª', 'bg-teal-600')}
                            ${menuButton('spy_setup', 'ğŸ•µï¸', 'Ø§Ù„Ø¬Ø§Ø³ÙˆØ³', 'Ù…ÙŠÙ† Ø§Ù„ØºØ±ÙŠØ¨ØŸ', 'bg-indigo-600')}
                            ${menuButton('charades_setup', 'ğŸ­', 'Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ø§Ù…', 'ØªÙ…Ø«ÙŠÙ„', 'bg-rose-600')}
                            ${menuButton('quotes_setup', 'ğŸ¬', 'Ø§Ù„Ø§ÙÙŠÙ‡Ø§Øª', 'Ø³Ù…Ù‘Ø¹', 'bg-emerald-600')}
                            ${menuButton('bus_setup', 'ğŸšŒ', 'Ø£ÙˆØªÙˆØ¨ÙŠØ³', 'Ø­Ø±Ù ÙˆÙØ¦Ø©', 'bg-purple-600')}
                            ${menuButton('liar_setup', 'ğŸƒ', 'Ø§Ù„ÙƒØ¯Ø§Ø¨', 'Ø§Ù…Ø³Ùƒ Ø§Ù„ÙƒØ°Ø¨Ø©', 'bg-orange-600')}
                            ${menuButton('auction_setup', 'ğŸ”¨', 'Ø§Ù„Ù…Ø²Ø§Ø¯', 'Ù…ÙŠÙ† ÙŠØ²ÙˆØ¯', 'bg-cyan-600')}
                            ${menuButton('gibberish_setup', 'ğŸ—£ï¸', 'ÙÙƒ Ø§Ù„Ø´ÙØ±Ø©', 'ÙƒÙ„Ø§Ù… ØºØ±ÙŠØ¨', 'bg-pink-600')}
                            ${menuButton('hum_setup', 'ğŸµ', 'Ø·Ø±Ø¨Ù†ÙŠ', 'Ù‡Ù…Ù‡Ù…Ø©', 'bg-yellow-600')}
                            ${menuButton('likely_setup', 'ğŸ‘‰', 'Ù…ÙŠÙ† Ø§Ù„ÙƒØ§Ø±Ø«Ø©', 'ØªÙˆÙ‚Ø¹Ø§Øª', 'bg-red-600')}
                        </div>
                    </div>
                    
                    <div class="shrink-0 flex gap-3 w-full p-4 pt-2 bg-slate-50 border-t border-slate-200 z-20 relative" style="padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));">
                        <button onclick="navigate('players')" class="flex-1 p-3 bg-white border border-slate-200 rounded-xl font-bold text-slate-600 flex items-center justify-center gap-2 shadow-sm active:scale-95 transition">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                            Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
                        </button>
                        <button onclick="navigate('scores')" class="flex-1 p-3 bg-white border border-slate-200 rounded-xl font-bold text-slate-600 flex items-center justify-center gap-2 shadow-sm active:scale-95 transition">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>
                            Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                        </button>
                    </div>
                </div>`;
        }

        function menuButton(screen, emoji, title, subtitle, color) { return `<button onclick="navigate('${screen}')" class="w-full aspect-square p-3 rounded-2xl shadow-lg text-white flex flex-col items-center justify-center text-center transition transform active:scale-95 hover:scale-[1.02] ${color}"><div class="text-5xl mb-2">${emoji}</div><div><span class="text-lg font-bold block leading-tight">${title}</span><span class="text-xs opacity-90 block mt-1 leading-tight">${subtitle}</span></div></button>`; }
        function renderPlayers() {
            const teamActive = state.teamMode;
            return `
                <div class="p-6 h-screen flex flex-col">
                    ${header('Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†', 'home')}
                    
                    <!-- Team Setup Row (Ø·Ø¨Ù‚Ø§Ù‹ Ù„Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯) -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-2xl px-3 py-2">
                            <button onclick="navigate('teams_setup')" class="px-3 py-1 bg-white rounded-xl font-bold text-xs text-slate-800 shadow-sm border border-slate-200">
                                Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØ±Ù‚
                            </button>
                            <button onclick="${teamActive ? 'deactivateTeamMode()' : 'activateTeamMode()'}" class="flex items-center gap-1 text-sm font-bold ${teamActive ? 'text-emerald-600' : 'text-slate-600'}">
                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full ${teamActive ? 'bg-emerald-500 text-white' : 'bg-red-500 text-white'}">
                                    ${teamActive ? 'âœ“' : 'âœ•'}
                                </span>
                                <span>ÙØ±Ù‚</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Player Input Section -->
                    <form onsubmit="addPlayer(event)" class="flex items-stretch gap-3 mb-6 h-14">
                        <button type="submit" class="bg-amber-500 text-white h-full w-14 rounded-2xl font-bold flex items-center justify-center shadow-lg hover:bg-amber-600 active:scale-95 transition">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                        <input type="text" id="newPlayerName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨..." class="flex-1 h-full px-5 border-2 border-slate-200 rounded-2xl text-lg font-bold focus:outline-none focus:border-amber-500 focus:ring-4 focus:ring-amber-500/20 transition">
                    </form>
                    
                    <!-- Players List -->
                    <div class="flex-1 overflow-y-auto space-y-3">
                        ${state.players.map(p => `
                            <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                                <span class="font-bold text-lg text-slate-700">${escapeHtml(p.name)}</span>
                                <button onclick="removePlayer(${p.id})" class="text-red-400 hover:text-red-600 transition">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Clear All / New Game Button -->
                    ${state.players.length > 0 ? `
                        <div class="mt-4 pt-4 border-t-2 border-slate-100">
                            <button onclick="clearAllPlayers()" class="w-full py-4 bg-red-500 hover:bg-red-600 active:scale-95 text-white rounded-2xl font-bold text-lg shadow-lg transition flex items-center justify-center gap-2">
                                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                <span>Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ / Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        function renderTeamsSetup() {
            const teamA = state.teams[0];
            const teamB = state.teams[1];
            return `
                <div class="flex flex-col h-screen bg-slate-50">
                    ${header('Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØ±Ù‚', 'players')}
                    <div class="flex-1 overflow-y-auto p-4 pb-32">
                        <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 mb-6">
                            <div class="flex items-center gap-2 mb-4 justify-center opacity-50"><span class="text-xs font-bold">ØªØ³Ù…ÙŠØ© Ø§Ù„ÙØ±Ù‚</span></div>
                            <div class="flex gap-4">
                                <div class="flex-1"><input type="text" value="${teamA.name}" onchange="updateTeamName('A', this.value)" class="w-full p-4 text-center font-black text-lg border-b-4 border-rose-500 rounded-2xl bg-rose-50/50 text-rose-700 focus:outline-none focus:bg-white focus:shadow-lg transition placeholder-rose-300" placeholder="ÙØ±ÙŠÙ‚ Ø£"></div>
                                <div class="flex-1"><input type="text" value="${teamB.name}" onchange="updateTeamName('B', this.value)" class="w-full p-4 text-center font-black text-lg border-b-4 border-indigo-500 rounded-2xl bg-indigo-50/50 text-indigo-700 focus:outline-none focus:bg-white focus:shadow-lg transition placeholder-indigo-300" placeholder="ÙØ±ÙŠÙ‚ Ø¨"></div>
                            </div>
                        </div>
                        <h3 class="px-2 text-slate-400 text-xs font-bold mb-3">Ø§Ø¶ØºØ· Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h3>
                        <div class="space-y-3">
                            ${state.players.map(p => {
                                const inA = teamA.members.some(m => m.id === p.id);
                                const inB = teamB.members.some(m => m.id === p.id);
                                return `<div class="flex items-center justify-between bg-white p-3 pr-5 rounded-2xl shadow-sm border border-slate-100 transition hover:shadow-md"><span class="font-bold text-lg text-slate-700">${escapeHtml(p.name)}</span><div class="flex gap-3"><button onclick="assignPlayerToTeam('A', ${p.id})" class="w-12 h-12 rounded-xl font-black text-lg transition-all duration-200 flex items-center justify-center ${inA ? 'bg-rose-600 text-white shadow-lg shadow-rose-200 transform scale-110 ring-2 ring-offset-2 ring-rose-100' : 'bg-slate-50 text-slate-300 hover:bg-rose-50 hover:text-rose-400'}">Ø£</button><button onclick="assignPlayerToTeam('B', ${p.id})" class="w-12 h-12 rounded-xl font-black text-lg transition-all duration-200 flex items-center justify-center ${inB ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200 transform scale-110 ring-2 ring-offset-2 ring-indigo-100' : 'bg-slate-50 text-slate-300 hover:bg-indigo-50 hover:text-indigo-400'}">Ø¨</button></div></div>`;
                            }).join('')}
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-white via-white/95 to-transparent z-50">
                        ${state.teamMode ? `<button onclick="deactivateTeamMode()" class="w-full py-4 bg-red-500 text-white rounded-2xl font-black text-xl shadow-xl shadow-red-200 hover:bg-red-600 active:scale-95 transition flex items-center justify-center gap-2"><span>Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ÙØ±Ù‚</span></button>` : `<button onclick="activateTeamMode()" class="w-full py-4 bg-emerald-500 text-white rounded-2xl font-black text-xl shadow-xl shadow-emerald-200 hover:bg-emerald-600 active:scale-95 transition flex items-center justify-center gap-2"><span>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø¨Ø§Ù„ÙØ±Ù‚</span></button>`}
                    </div>
                </div>
            `;
        }
        function shareResults() {
            let shareText = 'ğŸ”¥ Ù…Ù„ÙˆÙƒ Ø§Ù„Ù‚Ø¹Ø¯Ø© ÙˆØµÙ„ÙˆØ§.. ÙˆØ³Ø¹ Ù„Ù„Ù†ØªØ§ÙŠØ¬!\n\nğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ:\n';
            
            if (state.teamMode) {
                const sortedTeams = [...state.teams].sort((a, b) => b.score - a.score);
                sortedTeams.forEach((t, i) => {
                    const emoji = i === 0 ? '1ï¸âƒ£' : i === 1 ? '2ï¸âƒ£' : '3ï¸âƒ£';
                    shareText += `${emoji} ${escapeHtml(t.name)}: ${t.score} Ù†Ù‚Ø·Ø©\n`;
                });
            } else {
                const sortedPlayers = [...state.players].sort((a, b) => b.score - a.score);
                sortedPlayers.slice(0, 5).forEach((p, i) => {
                    const emoji = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£'][i];
                    shareText += `${emoji} ${escapeHtml(p.name)}: ${p.score} Ù†Ù‚Ø·Ø©\n`;
                });
            }
            
            shareText += '\nğŸ² Ø§Ù„Ø¹Ø¨Ù‡Ø§ Ù…Ø¹Ø§Ù†Ø§ Ø¯Ù„ÙˆÙ‚ØªÙŠ: [Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚]';
            
            // Try Web Share API first (mobile)
            if (navigator.share) {
                navigator.share({
                    title: 'Ù„Ø¹Ø¨Ø© Ø§Ù„Ù‚Ø¹Ø¯Ø© - Ø§Ù„Ù†ØªØ§Ø¦Ø¬',
                    text: shareText
                }).catch(() => {
                    // If share cancelled or failed, fallback to clipboard
                    copyToClipboard(shareText);
                });
            } else {
                // Fallback: Copy to clipboard
                copyToClipboard(shareText);
            }
        }
        
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®! Ø§Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ø£ÙŠ Ù…Ø­Ø§Ø¯Ø«Ø©');
                    playSound('success');
                });
            } else {
                // Older fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®! Ø§Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ø£ÙŠ Ù…Ø­Ø§Ø¯Ø«Ø©');
                playSound('success');
            }
        }
        
        function renderScores() {
            if (state.teamMode) {
                const sortedTeams = [...state.teams].sort((a, b) => b.score - a.score);
                return `
                    <div class="p-6 h-screen flex flex-col">
                        ${header('Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù - Ø§Ù„ÙØ±Ù‚', 'home')}
                        
                        <!-- Share Button -->
                        <button onclick="shareResults()" class="w-full py-3 mb-4 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                            <span>Ø´Ø§Ø±Ùƒ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</span>
                        </button>
                        
                        <div class="flex-1 overflow-y-auto space-y-4">
                            ${sortedTeams.map((t, i) => `
                                <div class="flex items-center p-4 rounded-xl shadow-sm border border-slate-100 bg-white">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ml-4 ${i === 0 ? 'bg-yellow-400 text-white' : 'bg-slate-200 text-slate-600'}">${i + 1}</div>
                                    <div class="flex-1">
                                        <div class="font-bold text-lg text-slate-800">${escapeHtml(t.name)}</div>
                                        <div class="text-sm text-slate-500 mt-1">${(t.members && t.members.length > 0) ? t.members.map(m => escapeHtml(m.name)).join(', ') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡'}</div>
                                    </div>
                                    <div class="font-black text-2xl ${t.id === 'A' ? 'text-rose-600' : 'text-indigo-600'}">${t.score}</div>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="resetScores()" class="mt-4 w-full py-4 bg-slate-800 text-white rounded-xl font-bold">ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯</button>
                    </div>
                `;
            } else {
                const sortedPlayers = [...state.players].sort((a, b) => b.score - a.score);
                return `
                    <div class="p-6 h-screen flex flex-col">
                        ${header('Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù', 'home')}
                        
                        <!-- Share Button -->
                        <button onclick="shareResults()" class="w-full py-3 mb-4 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                            <span>Ø´Ø§Ø±Ùƒ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</span>
                        </button>
                        
                        <div class="flex-1 overflow-y-auto space-y-4">
                            ${sortedPlayers.map((p, i) => `
                                <div class="flex items-center p-4 rounded-xl shadow-sm border border-slate-100 bg-white">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ml-4 ${i === 0 ? 'bg-yellow-400 text-white' : 'bg-slate-200 text-slate-600'}">${i + 1}</div>
                                    <div class="flex-1 font-bold text-lg text-slate-800">${escapeHtml(p.name)}</div>
                                    <div class="font-black text-2xl text-indigo-600">${p.score}</div>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="resetScores()" class="mt-4 w-full py-4 bg-red-600 text-white rounded-xl font-bold border-2 border-red-700 hover:bg-red-700 transition">âš ï¸ ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯</button>
                    </div>
                `;
            }
        }
        function addPlayer(e) { e.preventDefault(); const input = document.getElementById('newPlayerName'); if(input.value.trim()){ state.players.push({id: Date.now(), name: input.value.trim(), score: 0}); saveState(); render(); } }
        function removePlayer(id) {
            // Fix: Check if player is currently playing in an active game
            if (state.currentGame && state.currentGame.player && state.currentGame.player.id === id) {
                alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø£Ø«Ù†Ø§Ø¡ Ø¯ÙˆØ±Ù‡');
                playSound('fail');
                return; // Block deletion
            }
            
            // Confirmation dialog before deletion
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ØŸ')) {
                return; // User cancelled
            }
            
            // Remove from players list
            state.players = state.players.filter(p => p.id !== id);
            
            // Fix: Remove from turnQueue to prevent ghost player selection
            if (state.turnQueue && state.turnQueue.length > 0) {
                state.turnQueue = state.turnQueue.filter(p => p.id !== id);
            }
            
            // Fix: Remove from shuffledQueue for getFairPlayer
            if (state.shuffledQueue && state.shuffledQueue.length > 0) {
                state.shuffledQueue = state.shuffledQueue.filter(p => p.id !== id);
                // Reset turnIndex if it's now out of bounds
                if (state.turnIndex >= state.shuffledQueue.length) {
                    state.turnIndex = 0;
                }
            }
            
            // Remove from all teams
            state.teams.forEach(team => {
                team.members = team.members.filter(m => m.id !== id);
            });
            
            // Recalculate team scores (deduct removed player's score)
            recalculateTeamScores();
            
            // âš ï¸ CRITICAL: Save state to persist the deletion
            saveState();
            render();
        }
        function clearAllPlayers() {
            // Confirm before clearing
            if (state.players.length > 0 && !confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØ¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù:\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·\nâ€¢ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ±Ù‚')) {
                return;
            }
            // Clear players array
            state.players = [];
            // Clear turn queue
            state.turnQueue = [];
            // Reset teams
            state.teams.forEach(team => {
                team.members = [];
                team.score = 0;
            });
            // Clear used items
            state.usedItems = {};
            // Clear current game
            state.currentGame = null;
            // Clear gameInterval if running
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
            // Update localStorage
            saveState();
            // Play sound feedback
            playSound('click');
            // Update UI
            render();
        }
        function resetScores() { 
            // Confirmation dialog for safety
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†ØŸ')) return;
            
            state.players = state.players.map(p => ({...p, score: 0}));
            state.teams = state.teams.map(t => ({...t, score: 0}));
            playSound('click');
            saveState();
            render(); 
        }
        function updateTeamName(teamId, newName) {
            const team = state.teams.find(t => t.id === teamId);
            if (team && newName.trim()) {
                team.name = newName.trim();
                playSound('click');
                saveState();
            }
        }
        function assignPlayerToTeam(teamId, playerId) {
            // 1. Find the player object
            const player = state.players.find(p => p.id === playerId);
            if (!player) return;

            // 2. Remove player from ALL teams first (to avoid duplicates)
            state.teams.forEach(team => {
                team.members = team.members.filter(m => m.id !== playerId);
            });

            // 3. Add to the new target team
            const targetTeam = state.teams.find(t => t.id === teamId);
            if (targetTeam) {
                targetTeam.members.push(player);
            }

            // 4. Update the "teamId" property on the player object itself (for redundancy/safety)
            player.teamId = teamId;

            // 5. Recalculate team scores (player's score moves with them)
            recalculateTeamScores();

            // 6. âš ï¸ CRITICAL: Save and Render
            playSound('click');
            saveState(); // <--- This ensures the assignment persists on refresh
            render();
        }
        function activateTeamMode() {
            const teamA = state.teams[0];
            const teamB = state.teams[1];
            
            if (teamA.members.length === 0 || teamB.members.length === 0) {
                alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„ÙƒÙ„ ÙØ±ÙŠÙ‚ Ù„Ø§Ø¹Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!');
                return;
            }
            
            state.teamMode = true;
            
            // Recalculate team scores when activating team mode
            recalculateTeamScores();
            
            playSound('success');
            saveState();
            render();
        }
        function deactivateTeamMode() {
            // UX Fix: Add confirmation to prevent accidental loss of team setup
            const confirmDeactivate = confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¹Ø·ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ÙØ±Ù‚ØŸ\n\nØ³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ±Ù‚ØŒ Ù„ÙƒÙ† Ø§Ù„Ù†Ù‚Ø§Ø· Ø³ØªÙØ­Ø³Ø¨ Ø¨Ø´ÙƒÙ„ ÙØ±Ø¯ÙŠ.');
            
            if (!confirmDeactivate) {
                return; // User cancelled
            }
            
            state.teamMode = false;
            playSound('click');
            saveState();
            render();
        }

        // ============================================
        // =========== ALL GAME LOGIC =================
        // ============================================

        // --- LAWYER ---
        function startLawyerGame() {
            const data = getUniqueItem('lawyer', LAWYER_DATA);
            const player = getFairPlayer();
            state.currentGame = { type: 'lawyer', phase: 'prepare', data, player, revealed: false, timeLeft: 30 };
            playSound('click');
            saveState();
            render();
        }
        function startLawyerRound() {
            state.currentGame.phase = 'playing';
            state.currentGame.revealed = true;
            playSound('click');
            saveState();
            render();
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                state.currentGame.timeLeft--;
                // DOM update for no flickering
                const timerEl = document.getElementById('game-timer');
                if (timerEl) timerEl.innerText = getTimer(state.currentGame.timeLeft);
                
                if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); state.currentGame.phase = 'result'; playSound('fail'); saveState(); render(); }
                else if (state.currentGame.timeLeft <= 10) playSound('tick');
            }, 1000);
        }
        function lawyerSuccess() { updateScore(state.currentGame.player.id, false, 1); startLawyerGame(); }
        function renderLawyerSetup() {
            if (!state.currentGame || state.currentGame.type !== 'lawyer') return renderGameStartScreen('Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ Ø§Ù„Ù„Ø¹ÙŠÙ†', 'Ù…ØµÙŠØ¨Ø© Ù‡ØªØ­ØµÙ„ÙƒØŒ ÙˆÙ„Ø§Ø²Ù… ØªØ¨Ø±Ø±Ù‡Ø§ ÙˆØªØ®Ø±Ø¬ Ù…Ù†Ù‡Ø§ ÙˆØªØ³ØªØ®Ø¯Ù… 3 ÙƒÙ„Ù…Ø§Øª Ù…Ù„Ù‡Ù…Ø´ Ø¹Ù„Ø§Ù‚Ø© Ø¨Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø¹Ø´Ø§Ù† ØªÙ‚Ù†Ø¹ Ø§Ù„Ù…Ø­ÙƒÙ…Ø©!', 'ğŸ‘¨â€âš–ï¸', 'ÙˆØ±Ø·Ù†ÙŠ!', 'startLawyerGame()', 'bg-slate-700');
            const game = state.currentGame;
            if (game.phase === 'prepare') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-700 text-white text-center animate-in"><p class="text-xl opacity-80 mb-2">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰</p><h1 class="text-4xl font-black mb-8">${escapeHtml(game.player.name)}</h1><div class="bg-white/10 p-6 rounded-2xl border-2 border-white/20 w-full mb-8 relative overflow-hidden">${!game.revealed ? `<div onclick="state.currentGame.revealed = true; render()" class="absolute inset-0 bg-slate-800 z-10 flex items-center justify-center cursor-pointer hover:bg-slate-900 transition"><span class="text-xl font-bold animate-pulse">Ø¯ÙˆØ³ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø§Ù„Ù…ØµÙŠØ¨Ø©</span></div>` : ''}<p class="text-sm mb-2 opacity-75">Ø§Ù„Ù…ØµÙŠØ¨Ø©:</p><h2 class="text-2xl font-bold text-yellow-300 leading-relaxed mb-4">${game.data.disaster}</h2><div class="border-t border-white/20 pt-4"><p class="text-sm mb-2 opacity-75">ÙƒÙ„Ù…Ø§Øª Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©:</p><div class="flex flex-wrap gap-2 justify-center">${game.data.words.map(w=>`<span class="bg-slate-600 px-3 py-1 rounded-lg">${w}</span>`).join('')}</div></div></div><button onclick="startLawyerRound()" class="w-full py-4 bg-white text-slate-800 rounded-xl font-bold text-xl" ${!game.revealed ? 'disabled opacity-50' : ''}>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø±Ø§ÙØ¹Ø©</button></div>`;
            if (game.phase === 'playing') return `<div class="h-screen flex flex-col p-6 bg-white"><div class="text-center mt-4 mb-4"><p class="text-lg font-bold opacity-80">Ø§Ù„Ù…ØªÙ‡Ù…: <span class="text-slate-800">${escapeHtml(game.player.name)}</span></p></div><div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6 text-center"><h1 class="text-3xl font-black leading-relaxed text-center text-slate-800 mb-2">${game.data.disaster}</h1><div class="flex flex-wrap gap-2 justify-center mt-4">${game.data.words.map(w=>`<span class="bg-slate-200 px-2 py-1 rounded text-sm font-bold text-slate-700">${w}</span>`).join('')}</div></div><div class="flex-1 flex flex-col justify-center items-center"><div class="text-8xl font-black text-slate-800" id="game-timer">${getTimer(game.timeLeft)}</div></div><div class="space-y-3"><button onclick="lawyerSuccess()" class="w-full py-4 bg-green-500 text-white rounded-xl font-bold text-xl shadow-lg">âœ“ Ø¨Ø±Ø§Ø¡Ø© (Ø£Ù‚Ù†Ø¹Ù†Ø§)</button><button onclick="state.currentGame.phase='result'; render()" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold">âœ— Ø¥Ø¹Ø¯Ø§Ù… (ÙØ´Ù„)</button></div></div>`;
            if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-slate-900 text-white text-center"><h2 class="text-3xl font-bold mb-4">Ø±ÙØ¹Øª Ø§Ù„Ø¬Ù„Ø³Ø©!</h2><button onclick="startLawyerGame()" class="w-full py-4 bg-slate-600 rounded-xl font-bold text-xl mb-3">Ù‚Ø¶ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button><button onclick="goHome()" class="w-full py-3 bg-slate-800 rounded-xl font-bold">Ø®Ø±ÙˆØ¬</button></div>`;
        }

        // --- INDIAN ACTION ---
        function startIndianGame() {
            const data = getUniqueItem('indian', INDIAN_DATA);
            const player = getFairPlayer();
            state.currentGame = { type: 'indian', phase: 'prepare', data, player, revealed: false, timeLeft: 60 };
            playSound('click');
            saveState();
            render();
        }
        function startIndianRound() {
            state.currentGame.phase = 'playing';
            state.currentGame.revealed = true;
            playSound('click');
            saveState();
            render();
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                state.currentGame.timeLeft--;
                const timerEl = document.getElementById('game-timer');
                if (timerEl) timerEl.innerText = getTimer(state.currentGame.timeLeft);
                
                if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); state.currentGame.phase = 'result'; playSound('fail'); saveState(); render(); }
                else if (state.currentGame.timeLeft <= 10) playSound('tick');
            }, 1000);
        }
        function indianSuccess() { updateScore(state.currentGame.player.id, false, 1); startIndianGame(); }
        function indianFail() { 
            if (gameInterval) clearInterval(gameInterval);
            state.currentGame.phase = 'result'; 
            playSound('fail');
            saveState();
            render(); 
        }
        function renderIndianSetup() {
            if (!state.currentGame || state.currentGame.type !== 'indian') return renderGameStartScreen('Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ù‡Ù†Ø¯ÙŠ', 'Ù…Ø«Ù„ Ù…Ø´Ù‡Ø¯ Ø¯Ø±Ø§Ù…ÙŠ Ù…Ø¹ Ø´Ø±Ø· Ø¥Ø®Ø±Ø§Ø¬ ØºØ±ÙŠØ¨! Ø£ÙˆÙØ± Ø¹Ù„Ù‰ Ù‚Ø¯ Ù…Ø§ ØªÙ‚Ø¯Ø±!', 'ğŸ¬', 'Ø£ÙƒØ´Ù†!', 'startIndianGame()', 'bg-orange-600');
            const game = state.currentGame;
            if (game.phase === 'prepare') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-orange-600 text-white text-center animate-in"><p class="text-xl opacity-80 mb-2">Ø§Ù„Ø¨Ø·Ù„ Ø§Ù„ÙŠÙˆÙ…</p><h1 class="text-4xl font-black mb-8">${escapeHtml(game.player.name)}</h1><div class="bg-white/10 p-6 rounded-2xl border-2 border-white/20 w-full mb-8 relative overflow-hidden">${!game.revealed ? `<div onclick="state.currentGame.revealed = true; render()" class="absolute inset-0 bg-orange-700 z-10 flex items-center justify-center cursor-pointer hover:bg-orange-800 transition"><span class="text-xl font-bold animate-pulse">ğŸ¬ Ø¯ÙˆØ³ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ</span></div>` : ''}<p class="text-sm mb-2 opacity-75">Ø§Ù„Ù…Ø´Ù‡Ø¯:</p><h2 class="text-2xl font-bold text-yellow-300 leading-relaxed mb-4">${game.data.scene}</h2><div class="border-t border-white/20 pt-4"><p class="text-sm mb-2 opacity-75">Ø´Ø±Ø· Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬:</p><div class="bg-orange-500 px-4 py-3 rounded-lg font-bold text-lg">${game.data.condition}</div></div></div><button onclick="startIndianRound()" class="w-full py-4 bg-white text-orange-600 rounded-xl font-bold text-xl" ${!game.revealed ? 'disabled opacity-50' : ''}>ğŸ¬ Ø£ÙƒØ´Ù† ÙŠØ§ ÙÙ†Ø§Ù†!</button></div>`;
            if (game.phase === 'playing') return `<div class="h-screen flex flex-col p-6 bg-white"><div class="text-center mt-4 mb-4"><p class="text-lg font-bold opacity-80">Ø§Ù„Ø¨Ø·Ù„: <span class="text-orange-600">${escapeHtml(game.player.name)}</span></p></div><div class="bg-orange-50 p-4 rounded-xl border-2 border-orange-200 mb-4 text-center"><p class="text-xs text-orange-600 font-bold mb-2 uppercase">Ø§Ù„Ù…Ø´Ù‡Ø¯</p><h1 class="text-2xl font-black leading-relaxed text-center text-orange-900 mb-4">${game.data.scene}</h1><div class="border-t-2 border-orange-200 pt-3"><p class="text-xs text-orange-600 font-bold mb-2 uppercase">Ø´Ø±Ø· Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬</p><div class="bg-orange-600 text-white px-4 py-2 rounded-lg font-bold text-base">${game.data.condition}</div></div></div><div class="flex-1 flex flex-col justify-center items-center"><div class="text-8xl font-black text-orange-600" id="game-timer">${getTimer(game.timeLeft)}</div></div><div class="space-y-3"><button onclick="indianSuccess()" class="w-full py-4 bg-green-500 text-white rounded-xl font-bold text-xl shadow-lg">ğŸ† Ø¬Ø§Ø¨Ù‡Ø§! (Ø£ÙˆØ³ÙƒØ§Ø±)</button><button onclick="indianFail()" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold">ğŸ˜… Ø£ÙˆÙØ± Ø£ÙˆÙŠ (ÙØ´Ù„)</button></div></div>`;
            if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-orange-900 text-white text-center"><h2 class="text-3xl font-bold mb-4">ğŸ¬ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØµÙˆÙŠØ±!</h2><button onclick="startIndianGame()" class="w-full py-4 bg-orange-600 rounded-xl font-bold text-xl mb-3">Ù…Ø´Ù‡Ø¯ Ø¬Ø¯ÙŠØ¯</button><button onclick="goHome()" class="w-full py-3 bg-orange-800 rounded-xl font-bold">Ø®Ø±ÙˆØ¬</button></div>`;
        }

        // --- BOMB ---
        function startBombGame() {
            const category = BOMB_DATA[Math.floor(Math.random() * BOMB_DATA.length)];
            const count = Math.floor(Math.random() * 3) + 3; // Ø¹Ø¯Ø¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† 3 Ù„Ù€ 5
            const time = Math.floor(Math.random() * (60 - 10 + 1) + 10);
            const player = getFairPlayer();
            state.currentGame = { type: 'bomb', phase: 'playing', category, count, player, timeLeft: time, exploded: false };
            playSound('click');
            render();
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                state.currentGame.timeLeft--;
                playSound('bomb_tick');
                if (state.currentGame.timeLeft <= 0) {
                    clearInterval(gameInterval);
                    state.currentGame.exploded = true;
                    state.currentGame.phase = 'result';
                    // Deduct point from current player
                    updateScore(state.currentGame.player.id, false, -1);
                    playSound('explode');
                    saveState();
                    render();
                }
            }, 1000);
        }
        function passBomb() { 
            if(state.currentGame && state.currentGame.phase === 'playing') {
                // Fix race condition: Stop current timer and ensure it's cleared
                if (gameInterval) {
                    clearInterval(gameInterval);
                    gameInterval = null;
                }
                
                // Change category and player
                const newCategory = BOMB_DATA[Math.floor(Math.random() * BOMB_DATA.length)];
                const newCount = Math.floor(Math.random() * 3) + 3; // Ø¹Ø¯Ø¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† 3 Ù„Ù€ 5
                const newPlayer = getFairPlayer();
                const newTime = Math.floor(Math.random() * (60 - 10 + 1) + 10);
                
                state.currentGame.category = newCategory;
                state.currentGame.count = newCount;
                state.currentGame.player = newPlayer;
                state.currentGame.timeLeft = newTime;
                
                playSound('click');
                render();
                
                // Fix race condition: Small delay to ensure previous interval is fully cleared
                setTimeout(() => {
                    // Double-check gameInterval is still null before starting new one
                    if (gameInterval) {
                        clearInterval(gameInterval);
                    }
                
                // Start new timer
                gameInterval = setInterval(() => {
                    state.currentGame.timeLeft--;
                    playSound('bomb_tick');
                    if (state.currentGame.timeLeft <= 0) {
                        clearInterval(gameInterval);
                            gameInterval = null;
                        state.currentGame.exploded = true;
                        state.currentGame.phase = 'result';
                        updateScore(state.currentGame.player.id, false, -1);
                        playSound('explode');
                        saveState();
                        render();
                    }
                }, 1000);
                }, 50);
            }
        }
        function renderBombSetup() {
            if (!state.currentGame || state.currentGame.type !== 'bomb') return renderGameStartScreen('Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©', 'Ø³Ø¤Ø§Ù„ Ù‡ÙŠØ¸Ù‡Ø±ØŒ Ø¬Ø§ÙˆØ¨ ÙˆØ¨Ø§ØµÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¨Ø³Ø±Ø¹Ø© Ù„Ù„ÙŠ Ø¬Ù†Ø¨Ùƒ. Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© Ù‡ØªÙØ±Ù‚Ø¹ ÙÙŠ ÙˆÙ‚Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠØŒ Ø§Ù„Ù„ÙŠ ÙÙŠ Ø¥ÙŠØ¯Ù‡ Ø¨ÙŠØ®Ø³Ø±!', 'ğŸ’£', 'Ø´ØºÙ„ Ø§Ù„ÙØªÙŠÙ„', 'startBombGame()', 'bg-red-700');
            const game = state.currentGame;
            if (game.phase === 'playing') return `<div class="h-screen flex flex-col p-6 bg-red-600 text-white animate-in"><div class="text-center mt-4 mb-4"><p class="text-slate-200 mb-1">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰:</p><h2 class="text-2xl font-bold">${escapeHtml(game.player.name)}</h2></div><div class="text-center mt-4"><p class="text-white/80 font-bold mb-4">Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</p><h1 class="text-4xl font-black mb-12">${game.count} ${game.category}</h1></div><div class="flex-1 flex items-center justify-center"><div class="text-9xl mb-8 bomb-pulse">ğŸ’£</div></div><p class="text-center mb-8 font-bold text-lg">Ø¬Ø§ÙˆØ¨ ÙˆØ¨Ø§ØµÙŠ Ø¨Ø³Ø±Ø¹Ø©!</p><button onclick="passBomb()" class="w-full py-6 bg-white text-red-700 rounded-2xl font-black text-2xl shadow-xl active:scale-95 transition">Ø¨Ø§ØµÙŠ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©! ğŸ’¨</button></div>`;
            if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-black text-white text-center animate-in"><div class="text-9xl mb-6">ğŸ’¥</div><h2 class="text-4xl font-black text-red-500 mb-4">Ø¨ÙˆÙˆÙˆÙˆÙ…!</h2><p class="text-xl mb-2">Ø§Ù„Ù„Ø§Ø¹Ø¨: <span class="font-bold text-yellow-300">${escapeHtml(game.player.name)}</span></p><p class="text-lg mb-8 opacity-80">ØªÙ… Ø®ØµÙ… Ù†Ù‚Ø·Ø© (-1)</p><button onclick="startBombGame()" class="w-full py-4 bg-red-700 rounded-xl font-bold text-xl mb-3">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button><button onclick="goHome()" class="w-full py-3 bg-slate-800 rounded-xl font-bold">Ø®Ø±ÙˆØ¬</button></div>`;
        }

        // --- TABOO ---
        function startTabooGame() {
            const card = getUniqueItem('taboo', TABOO_DATA);
            const player = getFairPlayer();
            state.currentGame = { type: 'taboo', phase: 'prepare', card, player, revealed: false, timeLeft: 60, score: 0 };
            playSound('click');
            render();
        }
        function startTabooRound() {
            state.currentGame.phase = 'playing';
            state.currentGame.revealed = true;
            playSound('click');
            saveState();
            render();
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                state.currentGame.timeLeft--;
                const timerEl = document.getElementById('game-timer');
                if (timerEl) timerEl.innerText = getTimer(state.currentGame.timeLeft);
                if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); state.currentGame.phase = 'result'; playSound('fail'); saveState(); render(); }
                else if (state.currentGame.timeLeft <= 10) playSound('tick');
            }, 1000);
        }
        function tabooCorrect() { 
            // Ø³Ø¬Ù„ Ø§Ù„Ù†Ù‚Ø·Ø© Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¨Ù„ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±
            updateScore(state.currentGame.player.id, false, 1);
            state.currentGame.score++; 
            playSound('success'); 
            // Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ
            const nextPlayer = getFairPlayer();
            state.currentGame.player = nextPlayer;
            state.currentGame.card = getUniqueItem('taboo', TABOO_DATA);
            saveState();
            render(); 
        }
        function tabooSkip() { 
            playSound('click'); 
            // Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ
            const nextPlayer = getFairPlayer();
            state.currentGame.player = nextPlayer;
            state.currentGame.card = getUniqueItem('taboo', TABOO_DATA);
            saveState();
            render(); 
        }
        function tabooFail() { 
            state.currentGame.score--; 
            playSound('fail'); 
            // Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ
            const nextPlayer = getFairPlayer();
            state.currentGame.player = nextPlayer;
            state.currentGame.card = getUniqueItem('taboo', TABOO_DATA);
            saveState();
            render(); 
        }
        function renderTabooSetup() {
            if (!state.currentGame || state.currentGame.type !== 'taboo') return renderGameStartScreen('Ø£ÙˆØ¹Ù‰ ØªÙ‚ÙˆÙ„Ù‡Ø§', 'Ø§Ø´Ø±Ø­ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ Ù…Ù† ØºÙŠØ± Ù…Ø§ ØªÙ‚ÙˆÙ„ Ø£ÙŠ ÙƒÙ„Ù…Ø© Ù…Ù† Ø§Ù„Ù…Ù…Ù†ÙˆØ¹Ø§Øª Ø§Ù„Ù„ÙŠ ØªØ­ØªÙ‡Ø§!', 'ğŸš«', 'Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ', 'startTabooGame()', 'bg-rose-900');
            const game = state.currentGame;
            if (game.phase === 'prepare') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-rose-900 text-white text-center animate-in"><p class="text-xl opacity-80 mb-2">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰</p><h1 class="text-4xl font-black mb-8">${escapeHtml(game.player.name)}</h1><div class="bg-white/10 p-6 rounded-2xl border-2 border-white/20 w-full mb-8 relative overflow-hidden">${!game.revealed ? `<div onclick="state.currentGame.revealed = true; render()" class="absolute inset-0 bg-rose-950 z-10 flex items-center justify-center cursor-pointer hover:bg-rose-900 transition"><span class="text-xl font-bold animate-pulse">Ø¯ÙˆØ³ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø§Ù„ÙƒÙ„Ù…Ø©</span></div>` : ''}<p class="text-sm mb-2 opacity-75">Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</p><h2 class="text-3xl font-bold text-yellow-300">${game.card.word}</h2></div><button onclick="startTabooRound()" class="w-full py-4 bg-white text-rose-900 rounded-xl font-bold text-xl" ${!game.revealed ? 'disabled opacity-50' : ''}>Ø¬Ø§Ù‡Ø²! Ø§Ø¨Ø¯Ø£</button></div>`;
            if (game.phase === 'playing') return `<div class="h-screen flex flex-col p-6 bg-white"><div class="relative mb-4"><p class="text-center text-lg font-bold opacity-80">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰: <span class="text-rose-600">${escapeHtml(game.player.name)}</span></p><div class="absolute right-0 top-0 text-xl font-bold text-rose-900 bg-rose-50 px-3 py-1 rounded-lg">Ø§Ù„Ù†Ù‚Ø§Ø·: ${game.score}</div></div><div class="relative mb-6"><div class="text-center"><div class="inline-block text-3xl font-black text-rose-600 px-4 py-1 bg-rose-50 rounded-full" id="game-timer">${getTimer(game.timeLeft)}</div></div></div><div class="flex-1 flex flex-col justify-center items-center"><div class="w-full bg-rose-50 border-2 border-rose-200 rounded-2xl p-6 text-center mb-4"><h1 class="text-3xl font-black leading-relaxed text-center text-rose-900 mb-6">${game.card.word}</h1><div class="bg-white rounded-xl p-4 shadow-inner"><p class="text-sm text-red-500 font-bold mb-3">ğŸš« Ù…Ù…Ù†ÙˆØ¹ ØªÙ‚ÙˆÙ„:</p>${game.card.taboo.map(t => `<div class="text-lg font-bold text-slate-700 border-b border-slate-100 last:border-0 py-1">${t}</div>`).join('')}</div></div></div><div class="grid grid-cols-3 gap-2 h-20"><button onclick="tabooFail()" class="bg-red-600 text-white rounded-xl font-bold text-lg">ØºÙ„Ø·Ø©</button><button onclick="tabooSkip()" class="bg-slate-500 text-white rounded-xl font-bold text-lg">ØªØ®Ø·ÙŠ</button><button onclick="tabooCorrect()" class="bg-green-600 text-white rounded-xl font-bold text-lg">ØµØ­</button></div></div>`;
            if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-rose-900 text-white text-center"><h2 class="text-3xl font-bold mb-4">Ø®Ù„Øµ Ø§Ù„ÙˆÙ‚Øª!</h2><div class="text-6xl font-black text-yellow-300 mb-4">${game.score}</div><p class="text-xl mb-8">Ù†Ù‚Ø·Ø©</p><button onclick="startTabooGame()" class="w-full py-4 bg-rose-700 rounded-xl font-bold text-xl mb-3">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button><button onclick="goHome()" class="w-full py-3 bg-slate-800 rounded-xl font-bold">Ø®Ø±ÙˆØ¬</button></div>`;
        }

        // --- STORY ---
        function startStoryGame() { 
            const story = getUniqueItem('story', STORY_DATA);
            const currentPlayer = getFairPlayer();
            state.currentGame = { type: 'story', phase: 'ready', story, revealed: false, timeLeft: 60, currentPlayer }; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function startStoryRound() { 
            state.currentGame.phase = 'playing'; 
            state.currentGame.revealed = true; 
            playSound('click'); 
            render(); 
            if (gameInterval) clearInterval(gameInterval); 
            gameInterval = setInterval(() => { 
                state.currentGame.timeLeft--; 
                const t = document.getElementById('game-timer'); 
                if(t) t.innerText = state.currentGame.timeLeft; 
                if (state.currentGame.timeLeft <= 0) { 
                    clearInterval(gameInterval); 
                    state.currentGame.phase = 'result'; 
                    playSound('fail'); 
                    render(); 
                } else if (state.currentGame.timeLeft <= 10) playSound('tick'); 
            }, 1000); 
        }
        function storyNextPlayer() {
            // Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… turnQueue
            const nextPlayer = getFairPlayer();
            state.currentGame.currentPlayer = nextPlayer;
            saveState();
            render();
        }
        function storySuccess() { 
            // Ø§Ù„Ù†Ù‚Ø·Ø© Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ (ØµØ§Ø­Ø¨ Ø§Ù„Ø¯ÙˆØ±)
            if(state.currentGame.currentPlayer) updateScore(state.currentGame.currentPlayer.id, false, 1); 
            startStoryGame(); 
        }
        function storyFail() { 
            if (state.daresEnabled) showDare(); 
            startStoryGame(); 
        }
        function renderStorySetup() { 
            if (!state.currentGame || state.currentGame.type !== 'story') return renderGameStartScreen('Ø­ÙƒØ§ÙŠØ© ÙÙŠ ÙƒÙ„Ù…ØªÙŠÙ†', 'Ø¨Ø¯Ø§ÙŠØ© Ù‚ØµØ© ÙˆÙ†Ù‡Ø§ÙŠØ© Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©. ÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙŠÙ‚ÙˆÙ„ ÙƒÙ„Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø³ Ø¹Ø´Ø§Ù† ØªÙˆØµÙ„ÙˆØ§ Ù„Ù„Ù†Ù‡Ø§ÙŠØ© Ø¯ÙŠ ÙÙŠ Ø®Ù„Ø§Ù„ 60 Ø«Ø§Ù†ÙŠØ©!', 'ğŸ“–', 'Ø§ÙØªØ­ Ø§Ù„ÙƒØªØ§Ø¨', 'startStoryGame()', 'bg-amber-600'); 
            const game = state.currentGame; 
            if (game.phase === 'ready') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-amber-700 text-white text-center animate-in"><div class="text-6xl mb-6">ğŸ“œ</div><h2 class="text-3xl font-bold mb-8">Ø¬Ø§Ù‡Ø²ÙŠÙ† Ù„Ù„ØªØ£Ù„ÙŠÙØŸ</h2><div onclick="startStoryRound()" class="w-full py-8 bg-white text-amber-900 rounded-2xl font-black text-2xl shadow-xl cursor-pointer hover:bg-amber-50 transition border-4 border-amber-200">Ø¯ÙˆØ³ ÙˆØ§ÙƒØ´Ù Ø§Ù„Ù‚ØµØ©</div></div>`; 
            if (game.phase === 'playing') return `<div class="h-screen flex flex-col p-6 bg-white animate-in"><div class="text-center mb-4"><p class="text-lg font-bold opacity-80">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰: <span class="text-amber-600">${game.currentPlayer ? game.currentPlayer.name : 'Ù„Ø§Ø¹Ø¨'}</span></p></div><div class="flex-1 flex flex-col justify-center items-center space-y-6"><div class="bg-amber-50 p-6 rounded-2xl border-l-4 border-amber-500 w-full"><p class="text-sm text-amber-600 font-bold mb-2">Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</p><h1 class="text-3xl font-black leading-relaxed text-center text-slate-800">"${game.story.start}"</h1></div><div class="bg-amber-50 p-6 rounded-2xl border-l-4 border-red-500 w-full"><p class="text-sm text-red-600 font-bold mb-2">Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©:</p><h1 class="text-3xl font-black leading-relaxed text-center text-slate-800">"${game.story.end}"</h1></div><div class="text-center mt-4"><div class="text-6xl font-black text-amber-600" id="game-timer">${game.timeLeft}</div></div></div><div class="space-y-3 mt-auto"><button onclick="storySuccess()" class="w-full py-4 bg-green-500 text-white rounded-xl font-bold text-xl shadow-lg">âœ“ ÙˆØµÙ„ØªÙˆØ§ Ù„Ù„Ù†Ù‡Ø§ÙŠØ©!</button><button onclick="storyNextPlayer()" class="w-full py-3 bg-blue-500 text-white rounded-xl font-bold">Ø§Ù„ØªØ§Ù„ÙŠ (Ø¯ÙˆØ± Ø¬Ø¯ÙŠØ¯)</button><button onclick="storyFail()" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold">âœ— Ø§Ù„ÙˆÙ‚Øª Ø®Ù„Øµ (Ø¹Ù‚Ø§Ø¨)</button></div></div>`; 
            if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-amber-900 text-white text-center"><h2 class="text-3xl font-bold mb-4">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‚ØµØ©!</h2><button onclick="startStoryGame()" class="w-full py-4 bg-amber-600 rounded-xl font-bold text-xl mb-3">Ù‚ØµØ© Ø¬Ø¯ÙŠØ¯Ø©</button><button onclick="goHome()" class="w-full py-3 bg-slate-800 rounded-xl font-bold">Ø®Ø±ÙˆØ¬</button></div>`; 
        }

        // --- MORPH ---
        function startMorphGame() { 
            const word = getUniqueItem('morph', MORPH_DATA);
            const startingPlayer = getFairPlayer();
            state.currentGame = { type: 'morph', phase: 'ready', word, timeLeft: 45, startingPlayer, losers: [] }; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function startMorphRound() { 
            state.currentGame.phase = 'playing'; 
            playSound('click'); 
            render(); 
            if (gameInterval) clearInterval(gameInterval); 
            gameInterval = setInterval(() => { 
                state.currentGame.timeLeft--; 
                const t = document.getElementById('game-timer'); 
                if(t) t.innerText = state.currentGame.timeLeft; 
                if (state.currentGame.timeLeft <= 0) { 
                    clearInterval(gameInterval); 
                    state.currentGame.phase = 'result'; 
                    playSound('fail'); 
                    render(); 
                } else if (state.currentGame.timeLeft <= 10) playSound('tick'); 
            }, 1000); 
        }
        function toggleMorphLoser(playerId) {
            if (!state.currentGame.losers) state.currentGame.losers = [];
            const index = state.currentGame.losers.indexOf(playerId);
            if (index > -1) {
                state.currentGame.losers.splice(index, 1);
            } else {
                state.currentGame.losers.push(playerId);
            }
            render();
        }
        function morphSuccess() {
            // Round ended successfully - all players succeeded
            // Optional: Award point to starting player
            if (state.currentGame.startingPlayer) {
                updateScore(state.currentGame.startingPlayer.id, false, 1);
            }
            playSound('success');
            startMorphGame();
        }
        function morphFail() {
            // Someone failed - go to result phase to select losers
            if (gameInterval) clearInterval(gameInterval);
            state.currentGame.phase = 'result';
            playSound('fail');
            saveState();
            render();
        }
        function morphConfirmResult() {
            // ÙƒÙ„ Ø®Ø§Ø³Ø± ÙŠØªØ®ØµÙ… Ù…Ù†Ù‡ (-1)
            state.currentGame.losers.forEach(loserId => {
                updateScore(loserId, false, -1);
            });
            // Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ÙˆØ­ÙŠØ¯ Ø§Ù„Ù„ÙŠ Ù…ØªÙ…Ø´ Ø§Ø®ØªÙŠØ§Ø±Ù‡ ÙƒØ®Ø§Ø³Ø± ÙŠØ§Ø®Ø¯ (+2)
            const allPlayerIds = state.players.map(p => p.id);
            const winners = allPlayerIds.filter(id => !state.currentGame.losers.includes(id));
            if (winners.length === 1) {
                updateScore(winners[0], false, 2);
            }
            startMorphGame();
        }
        function renderMorphSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'morph') return renderGameStartScreen('Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…ØªØ­ÙˆÙ„Ø©', 'ÙƒÙ„Ù…Ø© Ù‡ØªØ¸Ù‡Ø±. ÙƒÙ„ Ù„Ø§Ø¹Ø¨ ÙŠØºÙŠØ± Ø­Ø±Ù ÙˆØ§Ø­Ø¯ Ø¨Ø³ Ø¹Ø´Ø§Ù† ÙŠØ¹Ù…Ù„ ÙƒÙ„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ÙŠÙ‡Ø§ Ù…Ø¹Ù†Ù‰. Ù„Ùˆ Ø­Ø¯ ÙˆÙ‚Ù Ø£Ùˆ Ø§Ù„ÙˆÙ‚Øª Ø®Ù„Øµ Ø¨ÙŠØ®Ø³Ø±!', 'ğŸ”¤', 'Ù‡Ø§Øª Ø§Ù„ÙƒÙ„Ù…Ø©', 'startMorphGame()', 'bg-cyan-700'); 
            const game = state.currentGame; 
            if (game.phase === 'ready') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-cyan-700 text-white text-center animate-in"><div class="text-6xl mb-6">ğŸ²</div><h2 class="text-3xl font-bold mb-8">Ø¬Ø§Ù‡Ø²ÙŠÙ† Ù„Ù„ØªØºÙŠÙŠØ±ØŸ</h2><div class="mb-4"><p class="text-lg opacity-80 mb-2">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰:</p><h3 class="text-2xl font-bold text-yellow-300">${game.startingPlayer ? game.startingPlayer.name : 'Ù„Ø§Ø¹Ø¨'}</h3></div><div onclick="startMorphRound()" class="w-full py-8 bg-white text-cyan-900 rounded-2xl font-black text-2xl shadow-xl cursor-pointer hover:bg-cyan-50 transition border-4 border-cyan-200">Ø¯ÙˆØ³ ÙˆØ§ÙƒØ´Ù Ø§Ù„ÙƒÙ„Ù…Ø©</div></div>`; 
            if (game.phase === 'playing') return `<div class="h-screen flex flex-col p-6 bg-white animate-in"><div class="text-center mb-4"><p class="text-lg font-bold opacity-80">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰: <span class="text-cyan-600">${game.startingPlayer ? game.startingPlayer.name : 'Ù„Ø§Ø¹Ø¨'}</span></p></div><div class="flex-1 flex flex-col justify-center items-center text-center"><p class="text-lg text-slate-500 mb-4">ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</p><div class="bg-cyan-100 p-8 rounded-3xl w-full mb-8 shadow-inner"><h1 class="text-3xl font-black leading-relaxed text-center text-cyan-800">${game.word}</h1></div><div class="text-8xl font-black text-cyan-600" id="game-timer">${game.timeLeft}</div></div><div class="space-y-3 mt-auto"><button onclick="morphSuccess()" class="w-full py-4 bg-green-500 text-white rounded-xl font-bold text-xl shadow-lg">âœ“ Ù†Ø¬Ø­ (+1 Ù†Ù‚Ø·Ø©)</button><button onclick="morphFail()" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold">âœ— ÙØ´Ù„</button></div></div>`; 
            if (game.phase === 'result') {
                if (!game.losers) game.losers = [];
                return `<div class="h-screen flex flex-col p-6 bg-cyan-900 text-white"><h2 class="text-3xl font-bold mb-6 text-center">Ø§Ù„Ø¬ÙˆÙ„Ø© Ø®Ù„ØµØª!</h2><p class="text-lg mb-4 text-center opacity-80">Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ Ø®Ø³Ø±ÙˆØ§ØŸ (Ø§Ø®ØªØ± ÙƒÙ„ Ø§Ù„Ø®Ø§Ø³Ø±ÙŠÙ†)</p><div class="flex-1 overflow-y-auto mb-4">${state.players.map(p => `<label class="flex items-center p-4 bg-white/10 rounded-xl mb-2 cursor-pointer hover:bg-white/20 transition"><input type="checkbox" ${game.losers.includes(p.id) ? 'checked' : ''} onchange="toggleMorphLoser(${p.id})" class="w-6 h-6 mr-3"><span class="text-xl font-bold">${escapeHtml(p.name)}</span></label>`).join('')}</div><button onclick="morphConfirmResult()" class="w-full py-4 bg-cyan-600 rounded-xl font-bold text-xl mb-3">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button><button onclick="goHome()" class="w-full py-3 bg-slate-800 rounded-xl font-bold">Ø®Ø±ÙˆØ¬</button></div>`; 
            }
        }

        // --- ARTIST ---
        function startArtistGame() { 
            // Edge case fix: Need at least 2 players for this game
            if (state.players.length < 2) { 
                alert("Ù…Ø­ØªØ§Ø¬ÙŠÙ† Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!"); 
                return; 
            } 
            
            const word = getUniqueItem('artist', ARTIST_DATA); 
            const artist = getFairPlayer(); 
            
            // Optimized: Filter array to exclude artist, then pick randomly - O(n) guaranteed
            const otherPlayers = state.players.filter(p => p.id !== artist.id);
            
            // Safety check: Should always have at least 1 other player due to length check above
            if (otherPlayers.length === 0) {
                console.error('No other players available');
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†. Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ.');
                return;
            }
            
            const guesser = otherPlayers[Math.floor(Math.random() * otherPlayers.length)];
            
            state.currentGame = { 
                type: 'artist', 
                phase: 'setup', 
                word, 
                artist, 
                guesser, 
                timeLeft: 60, 
                revealed: false 
            }; 
            
            playSound('click'); 
            saveState();
            render(); 
        }
        function revealArtistWord() { state.currentGame.revealed = true; playSound('click'); saveState(); render(); }
        function startArtistDrawing() { state.currentGame.phase = 'drawing'; playSound('click'); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); state.currentGame.phase = 'result'; playSound('fail'); saveState(); render(); } else if (state.currentGame.timeLeft <= 10) playSound('tick'); }, 1000); }
        function artistSuccess() { updateScore(state.currentGame.guesser.id, false, 1); updateScore(state.currentGame.artist.id, false, 1); startArtistGame(); }
        function renderArtistSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'artist') return renderGameStartScreen('Ø§Ù„Ø±Ø³Ø§Ù… Ø§Ù„Ø£Ø¹Ù…Ù‰', 'Ø§Ù„Ø±Ø³Ø§Ù… ÙŠØ´ÙˆÙ Ø§Ù„ÙƒÙ„Ù…Ø©. Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ØªØ§Ù†ÙŠ ÙŠØ­Ø· Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø³Ù‡ Ø£Ùˆ Ù…ÙŠØ¨ØµØ´. Ø§Ù„Ø±Ø³Ø§Ù… ÙŠØ±Ø³Ù…ØŒ ÙˆØ§Ù„ØªØ§Ù†ÙŠ ÙŠØ®Ù…Ù† Ù…Ù† ÙˆØµÙ Ø§Ù„Ù†Ø§Ø³ Ù„Ù„Ø±Ø³Ù…Ø©!', 'ğŸ¨', 'Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙÙ†', 'startArtistGame()', 'bg-fuchsia-600'); 
            const game = state.currentGame; 
            if (game.phase === 'setup') {
                if (!game.revealed) {
                    return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-fuchsia-800 text-white text-center animate-in"><h2 class="text-2xl font-bold mb-4">ÙŠØ§ <span class="text-yellow-300">${escapeHtml(game.artist.name)}</span></h2><p class="mb-8">Ø®Ø¯ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆÙ…Ø³ÙƒÙ‡ ÙƒÙˆÙŠØ³!</p><div class="bg-white/20 p-8 rounded-3xl mb-8 border border-white/30 relative overflow-hidden"><div class="absolute inset-0 bg-fuchsia-800 blur-md flex items-center justify-center"><span class="text-4xl font-black opacity-50">ğŸ¨</span></div><p class="text-sm opacity-75 mb-2 relative z-10" style="filter: blur(8px); user-select: none;">Ù…Ø·Ù„ÙˆØ¨ ØªØ±Ø³Ù…:</p><h1 class="text-4xl font-black relative z-10" style="filter: blur(8px); user-select: none;">${game.word}</h1></div><button onclick="revealArtistWord()" class="w-full py-4 bg-white text-fuchsia-900 rounded-xl font-bold text-xl shadow-xl">Ø§Ø¶ØºØ· Ù„Ù„ÙƒØ´Ù</button></div>`;
                }
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-fuchsia-800 text-white text-center animate-in"><h2 class="text-2xl font-bold mb-4">ÙŠØ§ <span class="text-yellow-300">${escapeHtml(game.artist.name)}</span></h2><p class="mb-8">Ø®Ø¯ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆÙ…Ø³ÙƒÙ‡ ÙƒÙˆÙŠØ³!</p><div class="bg-white/20 p-8 rounded-3xl mb-8 border border-white/30"><p class="text-sm opacity-75 mb-2">Ù…Ø·Ù„ÙˆØ¨ ØªØ±Ø³Ù…:</p><h1 class="text-4xl font-black">${game.word}</h1></div><p class="mb-4 text-sm opacity-80">Ø¯Ù„ÙˆÙ‚ØªÙŠ Ø®Ø¨ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø© ÙˆØ§Ø¯ÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù„Ù€ ${escapeHtml(game.guesser.name)}</p><button onclick="startArtistDrawing()" class="w-full py-4 bg-white text-fuchsia-900 rounded-xl font-bold text-xl shadow-xl">ÙŠÙ„Ø§ Ù†Ø±Ø³Ù…!</button></div>`;
            }
            if (game.phase === 'drawing') return `<div class="h-screen flex flex-col p-6 bg-white animate-in"><div class="text-center mt-4 mb-4"><p class="text-lg font-bold opacity-80">Ø§Ù„Ø±Ø³Ø§Ù…: <span class="text-fuchsia-600">${escapeHtml(game.artist.name)}</span></p><p class="text-lg font-bold opacity-80">Ø¨ÙŠØ®Ù…Ù†: <span class="text-fuchsia-600">${escapeHtml(game.guesser.name)}</span></p></div><div class="flex-1 flex flex-col justify-center items-center"><div class="text-9xl font-black text-fuchsia-600 mb-8" id="game-timer">${game.timeLeft}</div><p class="text-center text-slate-600 px-4">Ø§Ù„Ø±Ø³Ø§Ù… Ø¨ÙŠØ±Ø³Ù… Ø¯Ù„ÙˆÙ‚Øª.. ÙˆØ§Ù„Ù†Ø§Ø³ Ø¨ØªÙˆØµÙ Ø§Ù„Ø±Ø³Ù…Ø© (Ù…Ù† ØºÙŠØ± Ù…Ø§ ÙŠÙ‚ÙˆÙ„ÙˆØ§ Ø§Ù„ÙƒÙ„Ù…Ø©!)</p></div><div class="space-y-3 mt-auto"><button onclick="artistSuccess()" class="w-full py-4 bg-green-500 text-white rounded-xl font-bold text-xl shadow-lg">âœ“ Ø¹Ø±ÙÙ‡Ø§!</button><button onclick="state.currentGame.phase='result'; render()" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold">âœ— Ù…Ø¹Ø±ÙØ´</button></div></div>`; 
            if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-fuchsia-900 text-white text-center"><h2 class="text-3xl font-bold mb-4">Ø®Ù„Øµ Ø§Ù„ÙˆÙ‚Øª!</h2><p class="mb-4 text-xl">Ø§Ù„ÙƒÙ„Ù…Ø© ÙƒØ§Ù†Øª: <span class="text-yellow-300 font-bold">${game.word}</span></p><button onclick="startArtistGame()" class="w-full py-4 bg-fuchsia-600 rounded-xl font-bold text-xl mb-3">Ø±Ø³Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</button><button onclick="goHome()" class="w-full py-3 bg-slate-800 rounded-xl font-bold">Ø®Ø±ÙˆØ¬</button></div>`; 
        }

        // --- WHISPER ---
        function startWhisperGame() { 
            // Edge case fix: Need at least 2 players
            if (state.players.length < 2) { 
                alert("Ù…Ø­ØªØ§Ø¬ÙŠÙ† Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!"); 
                return; 
            } 
            
            const phrase = getUniqueItem('whisper', WHISPER_DATA); 
            const listener = getFairPlayer(); 
            
            // Safety fix: Prevent infinite loop with max iterations
            let speakerIndex = Math.floor(Math.random() * state.players.length);
            let attempts = 0;
            const maxAttempts = 100;
            
            while (state.players[speakerIndex].id === listener.id && attempts < maxAttempts) {
                speakerIndex = Math.floor(Math.random() * state.players.length);
                attempts++;
            }
            
            // Final safety check
            if (state.players[speakerIndex].id === listener.id) {
                console.error('Could not find different speaker');
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†. Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ.');
                return;
            }
            
            state.currentGame = { 
                type: 'whisper', 
                phase: 'setup', 
                phrase: phrase, 
                listener, 
                speaker: state.players[speakerIndex], 
                timeLeft: 60, 
                revealed: false 
            }; 
            
            playSound('click'); 
            saveState();
            render(); 
        }
        function startWhisperRound() { state.currentGame.phase = 'playing'; state.currentGame.revealed = true; playSound('click'); saveState(); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); state.currentGame.phase = 'result'; playSound('fail'); saveState(); render(); } else if (state.currentGame.timeLeft <= 10) playSound('tick'); }, 1000); }
        function whisperSuccess() { updateScore(state.currentGame.listener.id, false, 1); startWhisperGame(); }
        function whisperFail() { if (state.daresEnabled) showDare(); startWhisperGame(); }
        function renderWhisperSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'whisper') return renderGameStartScreen('Ø¥Ù‚Ø±Ø£ Ø´ÙØ§ÙŠÙÙŠ', 'ÙˆØ§Ø­Ø¯ ÙŠÙ„Ø¨Ø³ Ø³Ù…Ø§Ø¹Ø© ÙÙŠÙ‡Ø§ Ø£ØºÙ†ÙŠØ© Ø¨ØµÙˆØª Ø¹Ø§Ù„ÙŠØŒ ÙˆØ§Ù„ØªØ§Ù†ÙŠ ÙŠÙ‚Ø±Ø£ Ø¬Ù…Ù„Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©. Ø­Ø§ÙˆÙ„ ØªØ®Ù…Ù† Ø§Ù„Ø¬Ù…Ù„Ø© Ù…Ù† Ø­Ø±ÙƒØ© Ø§Ù„Ø´ÙØ§ÙŠÙ!', 'ğŸ§', 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©', 'startWhisperGame()', 'bg-pink-500'); 
            const game = state.currentGame; 
            if (game.phase === 'setup') { 
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-pink-600 text-white text-center animate-in"><div class="mb-8"><p class="text-lg opacity-80">ÙŠÙ„Ø¨Ø³ Ø§Ù„Ø³Ù…Ø§Ø¹Ø©:</p><h1 class="text-4xl font-black text-yellow-300 mb-4">${game.listener.name}</h1><div class="w-full h-1 bg-white/20 rounded-full mb-4"></div><p class="text-lg opacity-80">ÙŠÙ‚Ø±Ø£ Ø§Ù„Ø¬Ù…Ù„Ø©:</p><h1 class="text-3xl font-bold">${game.speaker.name}</h1></div><div class="bg-white/10 p-6 rounded-2xl border border-white/20 mb-8"><p class="text-sm">ÙŠØ§ ${game.listener.name}ØŒ Ø¹Ù„ÙŠ Ø§Ù„ØµÙˆØª Ø¹Ø§Ù„Ø§Ø®Ø±! ğŸµ</p></div><button onclick="startWhisperRound()" class="w-full py-4 bg-white text-pink-700 rounded-xl font-bold text-xl shadow-xl">Ø¬Ø§Ù‡Ø²ÙŠÙ†! Ø§ÙƒØ´Ù Ø§Ù„Ø¬Ù…Ù„Ø©</button></div>`; 
            } 
            if (game.phase === 'playing') { 
                return `<div class="h-screen flex flex-col p-6 bg-white animate-in"><div class="text-center mt-4 mb-8"><p class="text-lg font-bold opacity-80">Ø§Ù„Ù…ØªØ­Ø¯Ø«: <span class="text-pink-600">${game.speaker.name}</span></p></div><div class="flex-1 flex flex-col justify-center items-center"><div class="text-9xl font-black text-pink-600 mb-8" id="game-timer">${game.timeLeft}</div><div class="bg-pink-50 p-6 rounded-2xl border-2 border-pink-100 w-full text-center"><p class="text-sm text-pink-400 mb-2">Ø§Ù„Ø¬Ù…Ù„Ø© Ù‡ÙŠ:</p><h1 class="text-3xl font-black leading-relaxed text-center text-slate-800">${game.phrase}</h1></div></div><div class="space-y-3 mt-auto"><button onclick="whisperSuccess()" class="w-full py-4 bg-green-500 text-white rounded-xl font-bold text-xl shadow-lg">âœ“ Ø¹Ø±ÙÙ‡Ø§! (+Ù†Ù‚Ø·Ø©)</button><button onclick="whisperFail()" class="w-full py-3 bg-slate-200 text-slate-600 rounded-xl font-bold">Ù…Ø¹Ø±ÙØ´ (ØªØ®Ø·ÙŠ)</button></div></div>`; 
            } 
            if (game.phase === 'result') { 
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-pink-900 text-white text-center"><h2 class="text-3xl font-bold mb-4">Ø®Ù„Øµ Ø§Ù„ÙˆÙ‚Øª!</h2><p class="text-xl mb-8">Ø§Ù„Ø¬Ù…Ù„Ø© ÙƒØ§Ù†Øª: <br><span class="text-yellow-300 font-bold">${game.phrase}</span></p><button onclick="startWhisperGame()" class="w-full py-4 bg-pink-600 rounded-xl font-bold text-xl mb-3">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button><button onclick="goHome()" class="w-full py-3 bg-slate-800 rounded-xl font-bold">Ø®Ø±ÙˆØ¬</button></div>`; 
            } 
        }

        // --- NEVER ---
        function startNeverGame() { const statement = getUniqueItem('never', NEVER_DATA); state.currentGame = { type: 'never', phase: 'ready', statement: statement, revealed: false }; playSound('click'); render(); }
        function revealNeverCard() { state.currentGame.phase = 'playing'; state.currentGame.revealed = true; playSound('click'); render(); }
        function neverScoreSelect() { state.currentGame.phase = 'scoring'; saveState(); render(); }
        function renderNeverSetup() { if (!state.currentGame || state.currentGame.type !== 'never') return renderGameStartScreen('Ø£Ù†Ø§ Ø¹Ù…Ø±ÙŠ Ù…Ø§', 'Ø§Ø±ÙØ¹ÙˆØ§ 5 Ø£ØµØ§Ø¨Ø¹. Ø¬Ù…Ù„Ø© Ù‡ØªØ¸Ù‡Ø±ØŒ Ù„Ùˆ Ø¹Ù…Ù„Øª Ø§Ù„Ø­Ø§Ø¬Ø© Ø¯ÙŠ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡ØŒ Ù†Ø²Ù„ ØµØ¨Ø§Ø¹. Ø¢Ø®Ø± ÙˆØ§Ø­Ø¯ ÙŠÙØ¶Ù„ Ø±Ø§ÙØ¹ ØµØ¨Ø§Ø¹Ù‡ Ù‡Ùˆ Ø§Ù„ÙƒØ³Ø¨Ø§Ù†!', 'âœ‹', 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©', 'startNeverGame()', 'bg-rose-800'); const game = state.currentGame; if (game.phase === 'ready') { return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-rose-800 text-white text-center animate-in"><div class="text-6xl mb-6">âœ‹</div><h2 class="text-3xl font-bold mb-8">Ø¬Ø§Ù‡Ø²ÙŠÙ†ØŸ</h2><p class="text-lg opacity-80 mb-8">Ø§Ø±ÙØ¹ÙˆØ§ Ø¥ÙŠØ¯ÙŠÙƒÙ… (5 Ø£ØµØ§Ø¨Ø¹) Ø¯Ù„ÙˆÙ‚ØªÙŠ!</p><div onclick="revealNeverCard()" class="w-full py-8 bg-white text-rose-900 rounded-2xl font-black text-2xl shadow-xl cursor-pointer hover:bg-rose-50 transition border-4 border-rose-200">Ø¯ÙˆØ³ ÙˆØ§ÙƒØ´Ù Ø§Ù„ÙƒØ§Ø±Øª</div></div>`; } if (game.phase === 'playing') { return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-rose-800 text-white text-center animate-in"><p class="text-xl font-bold opacity-75 mb-4">Ø£Ù†Ø§ Ø¹Ù…Ø±ÙŠ Ù…Ø§...</p><div class="bg-white text-slate-900 p-8 rounded-3xl w-full mb-8 shadow-2xl"><h1 class="text-3xl font-black leading-relaxed">${game.statement}</h1></div><div class="w-full space-y-3"><button onclick="startNeverGame()" class="w-full py-4 bg-yellow-500 text-rose-900 rounded-xl font-bold text-xl shadow-lg">Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡</button><button onclick="neverScoreSelect()" class="w-full py-3 bg-rose-900/50 text-white border border-rose-400 rounded-xl font-bold">ØªÙˆØ²ÙŠØ¹ Ù†Ù‚Ø§Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</button><button onclick="goHome()" class="w-full py-3 bg-transparent text-rose-200 font-bold">Ø®Ø±ÙˆØ¬</button></div></div>`; } if (game.phase === 'scoring') { return `<div class="h-screen flex flex-col p-6 bg-rose-900 text-white text-center"><h2 class="text-2xl font-bold mb-6">Ù…ÙŠÙ† ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ù†Ù‚Ø·Ø©ØŸ</h2><div class="grid grid-cols-2 gap-3 w-full mb-8 flex-1 overflow-y-auto content-start">${state.players.map(p => `<button onclick="updateScore(${p.id}, false, 1); startNeverGame()" class="p-4 bg-white/10 border border-white/20 rounded-xl font-bold hover:bg-white/20">${escapeHtml(p.name)}</button>`).join('')}</div><button onclick="startNeverGame()" class="w-full py-3 bg-slate-700 rounded-xl font-bold">ØªØ®Ø·ÙŠ (Ø¨Ø¯ÙˆÙ† Ù†Ù‚Ø§Ø·)</button></div>`; } }

        // --- DEBATE ---
        function startDebateGame() { if (state.players.length < 2) { alert("Ù…Ø­ØªØ§Ø¬ÙŠÙ† Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!"); return; } const topic = getUniqueItem('debate', DEBATE_DATA); const p1 = getFairPlayer(); let p2 = state.players[Math.floor(Math.random() * state.players.length)]; while (p2.id === p1.id) p2 = state.players[Math.floor(Math.random() * state.players.length)]; state.currentGame = { type: 'debate', phase: 'assign', topic, p1, p2, timeLeft: 60, revealed: false }; playSound('click'); render(); }
        function startDebateRound() { state.currentGame.phase = 'playing'; state.currentGame.revealed = true; playSound('click'); saveState(); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); state.currentGame.phase = 'voting'; playSound('fail'); saveState(); render(); } else if (state.currentGame.timeLeft <= 10) playSound('tick'); }, 1000); }
        function endDebateEarly() { if (gameInterval) clearInterval(gameInterval); state.currentGame.phase = 'voting'; playSound('fail'); saveState(); render(); }
        function debateVote(winnerId) { updateScore(winnerId, false, 1); state.currentGame.phase = 'result'; saveState(); render(); }
        function renderDebateSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'debate') return renderGameStartScreen('Ù…Ø­ÙƒÙ…Ø©', 'Ù…ÙˆØ¶ÙˆØ¹ Ø¬Ø¯Ù„ÙŠ ØªØ§ÙÙ‡ Ù‡ÙŠØ·Ù„Ø¹. Ø§Ù„Ù„Ø¹Ø¨Ø© Ù‡ØªØ®ØªØ§Ø± "Ù…Ø­Ø§Ù…ÙŠ" Ùˆ "Ù†ÙŠØ§Ø¨Ø©". ÙƒÙ„ ÙˆØ§Ø­Ø¯ Ù…Ø¹Ø§Ù‡ Ø¯Ù‚ÙŠÙ‚Ø© ÙŠÙ‚Ù†Ø¹ Ø§Ù„Ù‚Ø¹Ø¯Ø© Ø¨ÙˆØ¬Ù‡Ø© Ù†Ø¸Ø±Ù‡!', 'âš–ï¸', 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø³Ø©', 'startDebateGame()', 'bg-amber-700'); 
            const game = state.currentGame; 
            if (game.phase === 'assign') { 
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-amber-800 text-white text-center animate-in"><h2 class="text-3xl font-bold mb-8">Ø£Ø·Ø±Ø§Ù Ø§Ù„Ù‚Ø¶ÙŠØ©</h2><div class="w-full bg-white/10 p-4 rounded-xl mb-4 border-r-4 border-green-400"><p class="text-sm opacity-75">Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ (Ø¯ÙØ§Ø¹)</p><h1 class="text-2xl font-black">${game.p1.name}</h1></div><div class="text-2xl font-bold mb-4">VS</div><div class="w-full bg-white/10 p-4 rounded-xl mb-8 border-r-4 border-red-400"><p class="text-sm opacity-75">Ø¶Ø¯ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ (Ù†ÙŠØ§Ø¨Ø©)</p><h1 class="text-2xl font-black">${game.p2.name}</h1></div><button onclick="startDebateRound()" class="w-full py-4 bg-white text-amber-900 rounded-xl font-bold text-xl shadow-xl">Ø§ÙƒØ´Ù Ø§Ù„Ù‚Ø¶ÙŠØ© ÙˆØ§Ø¨Ø¯Ø£</button></div>`; 
            } 
            if (game.phase === 'playing') { 
                return `<div class="h-screen flex flex-col p-6 bg-white animate-in"><div class="text-center mt-4 mb-4"><p class="text-lg font-bold opacity-80">Ø§Ù„Ù‚Ø¶ÙŠØ© Ø±Ù‚Ù… #99</p></div><div class="bg-amber-50 p-6 rounded-2xl border-2 border-amber-100 w-full text-center mb-6 shadow-sm"><h1 class="text-3xl font-black leading-relaxed text-center text-slate-800">${game.topic}</h1></div><div class="flex-1 flex flex-col justify-center items-center"><div class="text-9xl font-black text-amber-600" id="game-timer">${game.timeLeft}</div></div><div class="flex justify-between gap-4 mt-auto mb-4"><div class="text-center w-1/2"><div class="font-bold text-green-600 mb-1">Ù…Ø¹</div><div class="p-2 bg-green-50 rounded-lg font-bold text-sm">${game.p1.name}</div></div><div class="text-center w-1/2"><div class="font-bold text-red-600 mb-1">Ø¶Ø¯</div><div class="p-2 bg-red-50 rounded-lg font-bold text-sm">${game.p2.name}</div></div></div><button onclick="endDebateEarly()" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold text-lg shadow-lg">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙˆØ±Ø§Ù‹</button></div>`; 
            } 
            if (game.phase === 'voting') { 
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-amber-900 text-white text-center animate-in"><div class="text-6xl mb-6">ğŸ‘¨â€âš–ï¸</div><h2 class="text-3xl font-bold mb-8">Ø­ÙƒÙ… Ø§Ù„Ù…Ø­ÙƒÙ…Ø©!</h2><p class="text-lg opacity-80 mb-6">Ù…ÙŠÙ† Ø£Ù‚Ù†Ø¹ÙƒÙ… Ø£ÙƒØªØ±ØŸ</p><div class="w-full space-y-4"><button onclick="debateVote(${game.p1.id})" class="w-full py-4 bg-green-600 text-white rounded-xl font-bold text-xl shadow-lg hover:bg-green-700">${game.p1.name} (Ù…Ø¹)</button><button onclick="debateVote(${game.p2.id})" class="w-full py-4 bg-red-600 text-white rounded-xl font-bold text-xl shadow-lg hover:bg-red-700">${game.p2.name} (Ø¶Ø¯)</button></div></div>`; 
            } 
            if (game.phase === 'result') { 
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-amber-900 text-white text-center"><h2 class="text-3xl font-bold mb-4">ØªÙ… Ø§Ù„Ø­ÙƒÙ…!</h2><p class="mb-8">ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø·Ø© Ù„Ù„ÙØ§Ø¦Ø².</p><button onclick="startDebateGame()" class="w-full py-4 bg-amber-600 rounded-xl font-bold text-xl mb-3">Ù‚Ø¶ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button><button onclick="goHome()" class="w-full py-3 bg-slate-800 rounded-xl font-bold">Ø®Ø±ÙˆØ¬</button></div>`; 
            } 
        }

        // --- HEADS UP (FIXED) ---
        function startHeadsUpGame(category) {
            const words = HEADS_UP_DATA[category];
            const player = getFairPlayer();
            state.currentGame = {
                type: 'heads_up',
                phase: 'ready_check',
                category: category,
                pool: [...words],
                currentWord: null,
                score: 0,
                timeLeft: 60,
                skipped: 0,
                currentPlayer: player,
                wordHidden: true
            };
            playSound('click');
            saveState();
            render();
        }

        function startHeadsUpMix() {
            console.log('ğŸ”€ Mix Button Clicked for [Heads Up - Ø¹Ù„Ù‰ Ø±Ø§Ø³ÙŠ]');
            
            // Combine all categories into one mixed array
            let allWords = Object.values(HEADS_UP_DATA).flat();
            
            // Remove duplicates
            allWords = [...new Set(allWords)];
            
            console.log(`âœ… Total Items found: ${allWords.length}`);
            console.log(`ğŸ“ Sample Items: [${allWords.slice(0, 5).join(', ')}...]`);
            
            // Shuffle using Fisher-Yates
            for (let i = allWords.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allWords[i], allWords[j]] = [allWords[j], allWords[i]];
            }
            const player = getFairPlayer();
            state.currentGame = {
                type: 'heads_up',
                phase: 'ready_check',
                category: 'ÙƒÙˆÙƒØªÙŠÙ„ ğŸ”€',
                pool: allWords,
                currentWord: null,
                score: 0,
                timeLeft: 60,
                skipped: 0,
                currentPlayer: player,
                wordHidden: true
            };
            playSound('click');
            saveState();
            render();
        }

        function headsUpReady() {
            const words = state.currentGame.pool;
            state.currentGame.currentWord = words[Math.floor(Math.random() * words.length)];
            state.currentGame.phase = 'playing';
            state.currentGame.wordHidden = true;
            playSound('click');
            render();
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                state.currentGame.timeLeft--;
                const t = document.getElementById('hu-timer');
                if(t) t.innerText = state.currentGame.timeLeft;
                if (state.currentGame.timeLeft <= 0) {
                    clearInterval(gameInterval);
                    updateScore(state.currentGame.currentPlayer.id, false, state.currentGame.score);
                    state.currentGame.phase = 'result';
                    playSound('fail');
                    saveState();
                    render();
                } else if (state.currentGame.timeLeft <= 10) playSound('tick');
            }, 1000);
        }

        function revealHeadsUpWord() {
            state.currentGame.wordHidden = false;
            playSound('click');
            render();
        }

        function headsUpCorrect() {
            // Validation: Must reveal card first
            if (state.currentGame.wordHidden) {
                playSound('fail');
                
                // Create Warning Toast (Same style/text as Spy Game)
                const warning = document.createElement('div');
                warning.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-red-600 text-white px-8 py-3 rounded-full font-bold shadow-2xl z-[100] animate-in border-2 border-red-400 whitespace-nowrap';
                warning.innerText = '( Ø·Ø¨ Ø®Ø¯ ÙÙƒØ±Ù‡ Ø´ÙˆÙ Ø§Ù„ÙƒÙ„Ù…Ù‡ .. ÙÙˆÙˆÙˆÙˆÙ‚Ùˆ Ø¨Ù‚ÙŠ ğŸ˜¡ )';
                document.body.appendChild(warning);
                
                // Fade out and remove
                setTimeout(() => {
                    warning.style.opacity = '0';
                    warning.style.transition = 'opacity 0.3s';
                    setTimeout(() => warning.remove(), 300);
                }, 2000);
                
                return; // Stop execution
            }

            state.currentGame.score++;
            playSound('success');
            headsUpNextWord();
        }

        function headsUpPass() {
            // Validation: Must reveal card first
            if (state.currentGame.wordHidden) {
                playSound('fail');
                
                // Create Warning Toast (Same style/text as Spy Game)
                const warning = document.createElement('div');
                warning.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-red-600 text-white px-8 py-3 rounded-full font-bold shadow-2xl z-[100] animate-in border-2 border-red-400 whitespace-nowrap';
                warning.innerText = '( Ø·Ø¨ Ø®Ø¯ ÙÙƒØ±Ù‡ Ø´ÙˆÙ Ø§Ù„ÙƒÙ„Ù…Ù‡ .. ÙÙˆÙˆÙˆÙˆÙ‚Ùˆ Ø¨Ù‚ÙŠ ğŸ˜¡ )';
                document.body.appendChild(warning);
                
                // Fade out and remove
                setTimeout(() => {
                    warning.style.opacity = '0';
                    warning.style.transition = 'opacity 0.3s';
                    setTimeout(() => warning.remove(), 300);
                }, 2000);
                
                return; // Stop execution
            }

            state.currentGame.skipped++;
            playSound('fail');
            headsUpNextWord();
        }

        function headsUpNextWord() {
            const words = state.currentGame.pool;
            state.currentGame.currentWord = words[Math.floor(Math.random() * words.length)];
            state.currentGame.wordHidden = true;
            saveState();
            render();
        }

        function headsUpNewRound() {
            // CRITICAL FIX: Properly restart game with new player
            // Clear any existing interval
            if (gameInterval) clearInterval(gameInterval);
            
            // Get the category from current game
            const category = state.currentGame.category;
            
            // Start completely fresh game with new player (Fair Play rotation)
            const words = HEADS_UP_DATA[category];
            const newPlayer = getFairPlayer();
            
            state.currentGame = {
                type: 'heads_up',
                phase: 'ready_check',
                category: category,
                pool: [...words],
                currentWord: null,
                score: 0,
                timeLeft: 60,
                skipped: 0,
                currentPlayer: newPlayer,
                wordHidden: true
            };
            
            playSound('click');
            saveState();
            render();
        }

        function renderHeadsUpSetup() {
            if (!state.currentGame || state.currentGame.type !== 'heads_up') {
                const categories = Object.keys(HEADS_UP_DATA);
                return `
                    <div class="p-6 h-screen flex flex-col bg-blue-50">
                        ${header('ğŸ¤¯ Ø¹Ù„Ù‰ Ø±Ø§Ø³ÙŠ', 'home')}
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">ğŸ¤¯</div>
                            <h3 class="font-bold text-blue-800 mb-2">Ø§Ø®ØªØ§Ø± Ø§Ù„Ù‚Ø³Ù…:</h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4 flex-1 overflow-y-auto content-start pb-32">
                            ${categories.map(cat => {
                                // Format category name: put text in parentheses on new line with smaller/lighter text
                                let displayName = cat;
                                if (cat.includes('(')) {
                                    displayName = cat.replace('(', '<br/><span class="text-sm opacity-90">(') + '</span>';
                                }
                                return `
                                <button onclick="startHeadsUpGame('${cat}')" class="w-full min-h-[80px] flex items-center justify-center py-6 rounded-2xl font-black text-xl shadow-md border-b-4 bg-white border-blue-500 text-blue-600 hover:bg-blue-50 transition active:scale-95 text-center break-words leading-tight">
                                    ${displayName}
                                </button>
                            `;
                            }).join('')}
                        </div>
                        <button onclick="startHeadsUpMix()" class="fixed bottom-6 left-4 right-4 bg-gradient-to-r from-orange-500 via-pink-500 to-purple-600 text-white font-black text-xl py-4 rounded-2xl shadow-[0_4px_15px_rgba(0,0,0,0.3)] hover:scale-105 transition-transform z-50 flex justify-center items-center gap-2 active:scale-95">
                            <span>ğŸ”€</span> ÙƒÙˆÙƒØªÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                        </button>
                    </div>
                `;
            }

            const game = state.currentGame;

            if (game.phase === 'ready_check') {
                return `
                    <div class="h-screen flex flex-col items-center justify-center p-6 bg-blue-600 text-white text-center animate-in">
                        <p class="text-xl opacity-80 mb-2">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰</p>
                        <h1 class="text-5xl font-black mb-10 text-yellow-300">${escapeHtml(game.currentPlayer.name)}</h1>
                        <div class="bg-white/10 p-6 rounded-2xl mb-8 border border-white/20">
                            <p class="text-lg">Ø­Ø· Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¹Ù„Ù‰ Ø¬Ø¨Ù‡ØªÙƒ ğŸ“²</p>
                            <p class="text-sm opacity-75 mt-2">Ø®Ù„ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ù†Ø§Ø­ÙŠØ© ØµØ­Ø§Ø¨Ùƒ</p>
                        </div>
                        <button onclick="headsUpReady()" class="w-full py-4 bg-white text-blue-700 rounded-xl font-bold text-2xl shadow-xl">
                            Ø¬Ø§Ù‡Ø²! Ø§Ø¨Ø¯Ø£
                        </button>
                    </div>
                `;
            }

            if (game.phase === 'playing') {
                return `
                    <div class="h-screen flex relative overflow-hidden">
                        <!-- UX Fix: Entire Left Half = Pass (Red) -->
                        <div onclick="headsUpPass()" class="absolute inset-0 w-1/2 left-0 bg-red-500/20 z-10 cursor-pointer active:bg-red-500/40 transition-colors"></div>
                        
                        <!-- UX Fix: Entire Right Half = Correct (Green) -->
                        <div onclick="headsUpCorrect()" class="absolute inset-0 w-1/2 right-0 bg-green-500/20 z-10 cursor-pointer active:bg-green-500/40 transition-colors"></div>

                        <!-- Content Layer (non-interactive, above background) -->
                        <div class="absolute inset-0 flex flex-col p-4 bg-blue-600 pointer-events-none z-20">
                        <!-- Player Name - Glass Frame (Top-Right) -->
                            <div class="absolute top-4 right-4 bg-white/20 backdrop-blur-md border border-white/30 rounded-xl px-4 py-2 text-white font-bold text-lg">
                                ${escapeHtml(game.currentPlayer.name)}
                        </div>

                        <!-- Timer (Centered) -->
                        <div class="text-center mb-4 text-white pt-2">
                            <div class="text-4xl font-black text-yellow-300" id="hu-timer">${game.timeLeft}</div>
                        </div>

                        <!-- Main Card Area -->
                        <div class="flex-1 flex items-center justify-center relative mb-4">
                                <div class="w-full h-full bg-white rounded-3xl shadow-2xl flex items-center justify-center relative overflow-hidden">
                                ${game.wordHidden ? `
                                        <div class="text-center animate-pulse pointer-events-auto cursor-pointer z-30" onclick="revealHeadsUpWord()">
                                        <div class="text-8xl text-blue-200 font-black mb-4">?</div>
                                        <p class="text-blue-500 font-bold text-xl">Ø¯ÙˆØ³ Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± Ø§Ù„ÙƒÙ„Ù…Ø©</p>
                                    </div>
                                ` : `
                                    <!-- Rotated Text Container -->
                                    <div class="rotate-90-text flex items-center justify-center" style="width: 85vh; max-width: 90vh;">
                                        <h1 class="text-6xl md:text-8xl font-black text-slate-800 leading-tight whitespace-normal break-words text-center w-full">
                                            ${game.currentWord}
                                        </h1>
                                    </div>
                                `}
                            </div>
                        </div>

                            <!-- UX Instructions (Bottom Center) -->
                            <div class="text-center pb-4">
                                <div class="bg-white/90 backdrop-blur-sm rounded-2xl px-6 py-3 inline-block shadow-lg">
                                    <p class="text-blue-900 font-black text-lg leading-tight">
                                        Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù‡Ù…Ø§ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ¯ÙˆØ³ÙˆØ§!
                                    </p>
                                    <p class="text-blue-700 font-bold text-sm mt-1">
                                        ÙŠÙ…ÙŠÙ† âœ“ ØµØ­ | Ø´Ù…Ø§Ù„ âœ— ØºÙ„Ø·
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Visual Indicators (Bottom Corners) -->
                        <div class="absolute bottom-6 left-6 z-30 pointer-events-none">
                            <div class="bg-red-500 rounded-full w-16 h-16 flex items-center justify-center shadow-xl">
                                <span class="text-white text-3xl font-black">âœ—</span>
                            </div>
                        </div>
                        <div class="absolute bottom-6 right-6 z-30 pointer-events-none">
                            <div class="bg-green-500 rounded-full w-16 h-16 flex items-center justify-center shadow-xl">
                                <span class="text-white text-3xl font-black">âœ“</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (game.phase === 'result') {
                return `
                    <div class="h-screen flex flex-col items-center justify-center p-6 bg-blue-900 text-white text-center animate-in">
                        <h2 class="text-3xl font-bold mb-2">Ø®Ù„Øµ Ø§Ù„ÙˆÙ‚Øª!</h2>
                        <h1 class="text-4xl font-black text-yellow-300 mb-6">${game.currentPlayer.name}</h1>
                        
                        <div class="grid grid-cols-2 gap-4 w-full mb-8">
                            <div class="bg-green-500/20 p-4 rounded-xl border border-green-500/50">
                                <div class="text-4xl font-black text-green-400">${game.score}</div>
                                <div class="text-sm opacity-80">Ø¥Ø¬Ø§Ø¨Ø© ØµØ­</div>
                            </div>
                            <div class="bg-red-500/20 p-4 rounded-xl border border-red-500/50">
                                <div class="text-4xl font-black text-red-400">${game.skipped}</div>
                                <div class="text-sm opacity-80">ØªØ®Ø·ÙŠ</div>
                            </div>
                        </div>

                        <button onclick="headsUpNewRound()" class="w-full py-4 bg-yellow-500 hover:bg-yellow-600 text-blue-900 rounded-xl font-bold text-xl shadow-lg mb-3 active:scale-95 transition">
                            ğŸ”„ Ø±Ø§Ø³ Ø¬Ø¯ÙŠØ¯Ø©
                        </button>
                        
                        <button onclick="goHome()" class="w-full py-3 bg-slate-700 hover:bg-slate-800 rounded-xl font-bold active:scale-95 transition">Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    </div>
                `;
            }
        }

        // ================== OTHER GAMES ==================
        function startEmojiMix() {
            console.log('ğŸ”€ Mix Button Clicked for [Emoji Quiz - ÙÙƒ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ]');
            
            // Combine all categories into one mixed array
            let allItems = Object.values(EMOJI_QUIZ_DATA).flat();
            
            // Remove duplicates (by emoji signature)
            const seen = new Set();
            allItems = allItems.filter(item => {
                const key = item.emoji;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
            
            console.log(`âœ… Total Items found: ${allItems.length}`);
            console.log(`ğŸ“ Sample Items: [${allItems.slice(0, 3).map(i => i.emoji).join(', ')}...]`);
            
            // Shuffle using Fisher-Yates
            for (let i = allItems.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allItems[i], allItems[j]] = [allItems[j], allItems[i]];
            }
            const roundData = getUniqueItem('emoji_mix', allItems);
            state.currentGame = { type: 'emoji', phase: 'playing', category: 'ÙƒÙˆÙƒØªÙŠÙ„ ğŸ”€', data: roundData, revealed: false }; 
            playSound('click'); 
            saveState();
            render();
        }
        
        function startEmojiGame(category) {
            const categoryData = EMOJI_QUIZ_DATA[category] || EMOJI_QUIZ_DATA['Ø£ÙÙ„Ø§Ù… Ø¹Ø±Ø¨ÙŠ'];
            const roundData = getUniqueItem('emoji_' + category, categoryData);
            state.currentGame = { type: 'emoji', phase: 'playing', category, data: roundData, revealed: false }; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function revealEmojiAnswer() { state.currentGame.revealed = true; playSound('click'); saveState(); render(); }
        function emojiPlayerWins(playerId) { 
            updateScore(playerId, false, 1); 
            startEmojiGame(state.currentGame.category); 
        }
        function emojiSkip() { 
            startEmojiGame(state.currentGame.category); 
        }
        function renderEmojiSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'emoji') {
                const categories = Object.keys(EMOJI_QUIZ_DATA);
                return `
                    <div class="p-6 h-screen flex flex-col bg-yellow-50">
                        ${header('ğŸ§© ÙÙƒ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ', 'home')}
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">ğŸ§©</div>
                            <h3 class="font-bold text-yellow-800 mb-2">Ø§Ø®ØªØ§Ø± Ø§Ù„ÙØ¦Ø©:</h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4 flex-1 overflow-y-auto content-start pb-32">
                            ${categories.map(cat => `
                                <button onclick="startEmojiGame('${cat}')" class="py-6 rounded-2xl font-black text-xl shadow-md border-b-4 bg-white border-yellow-500 text-yellow-600 hover:bg-yellow-50 transition active:scale-95">
                                    ${cat}
                                </button>
                            `).join('')}
                        </div>
                        <button onclick="startEmojiMix()" class="fixed bottom-6 left-4 right-4 bg-gradient-to-r from-orange-500 via-pink-500 to-purple-600 text-white font-black text-xl py-4 rounded-2xl shadow-[0_4px_15px_rgba(0,0,0,0.3)] hover:scale-105 transition-transform z-50 flex justify-center items-center gap-2 active:scale-95">
                            <span>ğŸ”€</span> ÙƒÙˆÙƒØªÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                        </button>
                    </div>
                `;
            }
            const game = state.currentGame; 
            return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-yellow-500 text-white text-center animate-in"><div class="bg-white p-8 rounded-3xl shadow-xl w-full mb-8"><div class="text-6xl mb-4 leading-relaxed">${game.data.emojis}</div></div>${!game.revealed ? `<button onclick="revealEmojiAnswer()" class="w-full py-4 bg-slate-800 text-white rounded-xl font-bold text-xl shadow-lg">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>` : `<div class="mb-8 animate-in w-full"><p class="text-lg text-yellow-900 opacity-80 mb-2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</p><h2 class="text-4xl font-black text-yellow-900">${game.data.answer}</h2></div><p class="text-lg text-yellow-900 font-bold mb-4">Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ Ø¹Ø±Ù Ø§Ù„Ø­Ù„ØŸ</p><div class="grid grid-cols-2 gap-3 w-full mb-4">${state.players.map(p => `<button onclick="emojiPlayerWins(${p.id})" class="py-3 bg-white text-yellow-600 rounded-xl font-bold text-lg shadow-lg hover:bg-yellow-50">${escapeHtml(p.name)}</button>`).join('')}</div><button onclick="emojiSkip()" class="w-full py-3 bg-slate-500 text-white rounded-xl font-bold mb-3">Ù…Ø­Ø¯Ø´ Ø¹Ø±Ù (ØªØ®Ø·ÙŠ)</button><button onclick="goHome()" class="w-full py-3 bg-yellow-700 text-white rounded-xl font-bold">Ø®Ø±ÙˆØ¬</button>`}</div>`; 
        }
        function startLyricsGame() { 
            const roundData = getUniqueItem('lyrics', LYRICS_DATA);
            const player = getFairPlayer(); 
            state.currentGame = { type: 'lyrics', phase: 'playing', data: roundData, player, lyricsRevealed: false, answerRevealed: false }; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function revealLyricsText() { 
            state.currentGame.lyricsRevealed = true; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function revealLyricsAnswer() { 
            state.currentGame.answerRevealed = true; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function lyricsPlayerWins(playerId) { 
            updateScore(playerId, false, 1); 
            startLyricsGame(); 
        }
        function lyricsSkip() { 
            startLyricsGame(); 
        }
        function renderLyricsSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'lyrics') return renderGameStartScreen('ÙƒÙ…Ù„ Ø§Ù„Ø£ØºÙ†ÙŠØ©', 'Ù‡ÙŠØ¸Ù‡Ø± Ù…Ù‚Ø·Ø¹ Ù…Ù† Ø£ØºÙ†ÙŠØ© ÙˆÙÙŠÙ‡ ÙƒÙ„Ù…Ø© Ù†Ø§Ù‚ØµØ©. ÙƒÙ…Ù„Ù‡Ø§ ÙˆØºÙ†ÙŠÙ‡Ø§ ØµØ­!', 'ğŸ¤', 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©', 'startLyricsGame()', 'bg-purple-500'); 
            const game = state.currentGame; 
            if (!game.lyricsRevealed) {
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-purple-600 text-white text-center animate-in"><div class="text-center mb-4"><p class="text-slate-200 mb-1">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰:</p><h2 class="text-2xl font-bold">${escapeHtml(game.player.name)}</h2></div><p class="mb-4 opacity-80 font-bold">${game.data.singer}</p><div class="bg-white/20 p-8 rounded-3xl w-full mb-8 backdrop-blur-sm border border-white/30 relative overflow-hidden"><div class="absolute inset-0 bg-purple-800 blur-md flex items-center justify-center"><span class="text-4xl font-black opacity-50">ğŸµ</span></div><h2 class="text-2xl font-bold leading-relaxed mb-2 relative z-10" style="filter: blur(8px); user-select: none;">"${game.data.part}"</h2><div class="inline-block px-6 py-2 bg-black/20 rounded-lg mt-2 text-yellow-300 font-black text-2xl relative z-10" style="filter: blur(8px);">${game.data.answer}</div></div><button onclick="revealLyricsText()" class="w-full py-4 bg-white text-purple-700 rounded-xl font-bold text-xl shadow-lg">ÙƒØ´Ù Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button></div>`;
            }
            if (!game.answerRevealed) {
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-purple-600 text-white text-center animate-in"><div class="text-center mb-4"><p class="text-slate-200 mb-1">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰:</p><h2 class="text-2xl font-bold">${escapeHtml(game.player.name)}</h2></div><p class="mb-4 opacity-80 font-bold">${game.data.singer}</p><div class="bg-white/20 p-8 rounded-3xl w-full mb-8 backdrop-blur-sm border border-white/30"><h2 class="text-2xl font-bold leading-relaxed mb-2">"${game.data.part}"</h2><div class="inline-block px-6 py-2 bg-black/20 rounded-lg mt-2 text-yellow-300 font-black text-2xl">ØŸØŸØŸØŸØŸ</div></div><button onclick="revealLyricsAnswer()" class="w-full py-4 bg-white text-purple-700 rounded-xl font-bold text-xl shadow-lg">ÙƒØ´Ù Ø§Ù„ÙƒÙ„Ù…Ø©</button></div>`;
            }
            return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-purple-600 text-white text-center animate-in"><div class="text-center mb-4"><p class="text-slate-200 mb-1">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰:</p><h2 class="text-2xl font-bold">${escapeHtml(game.player.name)}</h2></div><p class="mb-4 opacity-80 font-bold">${game.data.singer}</p><div class="bg-white/20 p-8 rounded-3xl w-full mb-8 backdrop-blur-sm border border-white/30"><h2 class="text-2xl font-bold leading-relaxed mb-2">"${game.data.part}"</h2><div class="inline-block px-6 py-2 bg-black/20 rounded-lg mt-2 text-yellow-300 font-black text-2xl">${game.data.answer}</div></div><p class="text-lg text-purple-100 font-bold mb-4">Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ Ø¹Ø±Ù Ø§Ù„Ø­Ù„ØŸ</p><div class="grid grid-cols-2 gap-3 w-full mb-4">${state.players.map(p => `<button onclick="lyricsPlayerWins(${p.id})" class="py-3 bg-white text-purple-700 rounded-xl font-bold text-lg shadow-lg hover:bg-purple-50">${escapeHtml(p.name)}</button>`).join('')}</div><button onclick="lyricsSkip()" class="w-full py-3 bg-slate-500 text-white rounded-xl font-bold mb-3">Ù…Ø­Ø¯Ø´ Ø¹Ø±Ù (ØªØ®Ø·ÙŠ)</button><button onclick="goHome()" class="w-full py-3 bg-purple-800 text-white rounded-xl font-bold">Ø®Ø±ÙˆØ¬</button></div>`; 
        }

        // --- UNSCRAMBLE ---
        function scrambleWord(word) {
            const letters = word.split('');
            // Fisher-Yates shuffle
            for (let i = letters.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [letters[i], letters[j]] = [letters[j], letters[i]];
            }
            return letters.join('');
        }
        function startUnscrambleGame() {
            const item = getUniqueItem('unscramble', SCRAMBLE_DATA);
            const scrambled = scrambleWord(item.word);
            const player = getFairPlayer();
            state.currentGame = { type: 'unscramble', phase: 'playing', category: item.category, word: item.word, scrambled, player, revealed: false };
            playSound('click');
            saveState();
            render();
        }
        function revealUnscrambleAnswer() {
            state.currentGame.revealed = true;
            playSound('click');
            render();
        }
        function unscramblePlayerWins(playerId) {
            updateScore(playerId, false, 1);
            startUnscrambleGame();
        }
        function unscrambleSkip() {
            startUnscrambleGame();
        }
        function renderUnscrambleSetup() {
            if (!state.currentGame || state.currentGame.type !== 'unscramble') return renderGameStartScreen('Ø±ØªØ¨Ù‡Ø§ ØµØ­', 'ÙƒÙ„Ù…Ø© Ø­Ø±ÙˆÙÙ‡Ø§ Ù…ØªÙ„Ø®Ø¨Ø·Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙØ¦Ø© Ù…Ø¹ÙŠÙ†Ø©. Ø­Ø§ÙˆÙ„ ØªØ¹Ø±Ù Ø§Ù„ÙƒÙ„Ù…Ø© ÙˆØªØ±ØªØ¨Ù‡Ø§ ØµØ­!', 'ğŸ”€', 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©', 'startUnscrambleGame()', 'bg-green-600');
            const game = state.currentGame;
            if (!game.revealed) {
                return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-green-600 text-white text-center animate-in"><div class="text-center mb-4"><p class="text-slate-200 mb-1">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰:</p><h2 class="text-2xl font-bold">${escapeHtml(game.player.name)}</h2></div><div class="bg-white/20 p-6 rounded-2xl mb-6 w-full"><p class="text-sm opacity-75 mb-2">Ø§Ù„ÙØ¦Ø©:</p><h3 class="text-2xl font-bold text-yellow-300">${game.category}</h3></div><div class="bg-white/20 p-8 rounded-3xl w-full mb-8 backdrop-blur-sm border border-white/30"><h1 class="text-5xl font-black text-yellow-300 tracking-widest">${game.scrambled}</h1></div><button onclick="revealUnscrambleAnswer()" class="w-full py-4 bg-white text-green-700 rounded-xl font-bold text-xl shadow-lg">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button></div>`;
            }
            return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-green-600 text-white text-center animate-in"><div class="text-center mb-4"><p class="text-slate-200 mb-1">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰:</p><h2 class="text-2xl font-bold">${escapeHtml(game.player.name)}</h2></div><div class="bg-white/20 p-6 rounded-2xl mb-6 w-full"><p class="text-sm opacity-75 mb-2">Ø§Ù„ÙØ¦Ø©:</p><h3 class="text-2xl font-bold text-yellow-300">${game.category}</h3></div><div class="bg-white/20 p-8 rounded-3xl w-full mb-8 backdrop-blur-sm border border-white/30"><h1 class="text-5xl font-black text-yellow-300 tracking-widest mb-4">${game.scrambled}</h1><div class="border-t border-white/30 pt-4"><p class="text-sm opacity-75 mb-2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</p><h2 class="text-4xl font-black text-green-200">${game.word}</h2></div></div><p class="text-lg text-green-100 font-bold mb-4">Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ Ø¹Ø±Ù Ø§Ù„Ø­Ù„ØŸ</p><div class="grid grid-cols-2 gap-3 w-full mb-4">${state.players.map(p => `<button onclick="unscramblePlayerWins(${p.id})" class="py-3 bg-white text-green-700 rounded-xl font-bold text-lg shadow-lg hover:bg-green-50">${escapeHtml(p.name)}</button>`).join('')}</div><button onclick="unscrambleSkip()" class="w-full py-3 bg-slate-500 text-white rounded-xl font-bold mb-3">Ù…Ø­Ø¯Ø´ Ø¹Ø±Ù (ØªØ®Ø·ÙŠ)</button><button onclick="goHome()" class="w-full py-3 bg-green-800 text-white rounded-xl font-bold">Ø®Ø±ÙˆØ¬</button></div>`;
        }

        // --- SPY ---
        const SPY_TIPS = [
            "Ø±Ø§Ù‚Ø¨ Ù„ØºØ© Ø§Ù„Ø¬Ø³Ø¯.. Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ù…ØªÙˆØªØ± ğŸ˜°",
            "ÙÙŠ ÙˆØ§Ø­Ø¯ Ø¨ÙŠØ­Ø§ÙˆÙ„ ÙŠØºÙŠØ± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ ğŸ¤”",
            "Ø¨Øµ ÙÙŠ Ø¹ÙŠÙ† Ø§Ù„Ù„ÙŠ Ø¬Ù†Ø¨Ùƒ ğŸ‘ï¸",
            "Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ø¨ÙŠØ¹Ø±Ù‚ Ø¯Ù„ÙˆÙ‚ØªÙŠ ğŸ’¦",
            "Ù…ÙŠÙ† Ø³Ø§ÙƒØª Ø²ÙŠØ§Ø¯Ø© Ø¹Ù† Ø§Ù„Ù„Ø²ÙˆÙ…ØŸ ğŸ˜¶",
            "Ø«Ù‚ ÙÙŠ Ø­Ø¯Ø³Ùƒ.. Ø¨Ø³ Ù…Ø´ Ø£ÙˆÙŠ ğŸ˜ˆ",
            "Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ø¨ÙŠØ¶Ø­Ùƒ Ø¶Ø­ÙƒØ© ØµÙØ±Ø§ ğŸ˜‚",
            "Ù…ÙŠÙ† Ø¨ÙŠØ¨Ø±Ø¨Ø´ ÙƒØªÙŠØ±ØŸ ğŸ¤¨",
            "Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ø¹Ø§Ù…Ù„ Ù†ÙØ³Ù‡ Ù…Ù† Ø¨Ù†Ù‡Ø§ ğŸ ",
            "Ø±ÙƒØ² ÙÙŠ Ù†Ø¨Ø±Ø© Ø§Ù„ØµÙˆØª.. Ù…Ù‡Ø²ÙˆØ²Ø©ØŸ ğŸ“‰",
            "Ø­Ø¯ Ø¨ÙŠØ­Ø§ÙˆÙ„ ÙŠØªÙˆÙ‡ Ø§Ù„ÙƒÙ„Ø§Ù… Ø¹Ø´Ø§Ù† Ø®Ø§ÙŠÙ ğŸ—£ï¸",
            "Ø§Ù„Ù„ÙŠ ØµÙˆØªÙ‡ Ø¹Ø§Ù„ÙŠ ØºØ§Ù„Ø¨Ø§Ù‹ Ø¨ÙŠÙ…Ø«Ù„ ğŸ­",
            "Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ù†Ø³ÙŠ Ù‡Ùˆ ÙÙŠÙ† Ø£ØµÙ„Ø§Ù‹ ğŸŒ",
            "Ø¨Øµ Ø¹Ù„Ù‰ Ø¥ÙŠØ¯ÙŠÙ‡Ù….. Ù…ÙŠÙ† Ø¨ÙŠÙØ±ÙƒØŸ ğŸ‘",
            "ÙŠØ§ ØªØ±Ù‰ Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ Ø¨Ø§Ø¹Ù†Ø§ØŸ ğŸ’¸",
            "Ø´Ùƒ ÙÙŠ Ø£Ù‚Ø±Ø¨ Ø§Ù„Ù†Ø§Ø³ Ù„ÙŠÙƒ ğŸ‘¯â€â™‚ï¸",
            "Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ø¨ÙŠÙÙƒØ± ÙÙŠ ÙƒØ¯Ø¨Ø© Ø¯Ù„ÙˆÙ‚ØªÙŠ ğŸ’­",
            "Ù…ÙŠÙ† Ø¨ÙŠØ¶Ø­Ùƒ Ù…Ù† ØºÙŠØ± Ø³Ø¨Ø¨ØŸ ğŸ¤£",
            "Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ¨Øµ ÙÙŠ Ø§Ù„Ø³Ù‚Ù Ø¯Ù‡ Ù…Ø´ Ù…Ø±ÙŠØ­ ğŸ™„",
            "Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ø¹Ø§ÙŠØ² Ø§Ù„Ø¬ÙˆÙ„Ø© ØªØ®Ù„Øµ Ø¨Ø³Ø±Ø¹Ø© â±ï¸",
            "Ø³Ø¤Ø§Ù„ Ø«Ø¹Ø¨Ø§Ù†ÙŠ Ù‡ÙŠØ¨ÙŠÙ† ÙƒÙ„ Ø­Ø§Ø¬Ø© ğŸ",
            "Ø§ÙˆØ¹Ù‰ ØªØ¸Ù„Ù… Ø§Ù„Ø¨Ø±ÙŠØ¡.. (Ø£Ùˆ Ø§Ø¸Ù„Ù…Ù‡ Ø¹Ø§Ø¯ÙŠ) âš–ï¸",
            "Ù†Ø¸Ø±Ø§Øª Ø§Ù„Ø¹ÙŠÙˆÙ† ÙØ¶Ø§Ø­Ø© ğŸ‘€",
            "Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ù…Ø´ Ø¹Ø§Ø±Ù Ø¥Ø­Ù†Ø§ Ø¨Ù†ØªÙƒÙ„Ù… Ø¹Ù† Ø¥ÙŠÙ‡ ğŸ¤·â€â™‚ï¸",
            "Ù…ÙŠÙ† ÙˆØ§ÙƒÙ„ Ø³Ø¯ Ø§Ù„Ø­Ù†ÙƒØŸ ğŸ¤",
            "Ø§Ù„Ø­Ø±ÙƒØ© Ø¯ÙŠ Ù…Ø´ Ø­Ø±ÙƒØ© Ù…ÙˆØ§Ø·Ù† Ø´Ø±ÙŠÙ ğŸš¨",
            "Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ø¨ÙŠØ­Ø§ÙˆÙ„ ÙŠÙ‚Ù„Ø¯ÙƒÙ… ğŸ¦œ",
            "Ù…ÙŠÙ† ÙˆØ´Ù‡ Ø£Ø­Ù…Ø±ØŸ ğŸ˜³",
            "Ø®Ù„ÙŠ Ø¨Ø§Ù„Ùƒ Ù…Ù† Ø§Ù„Ù‡Ø§Ø¯ÙŠ.. Ù…ÙŠØ§Ù‡ Ù…Ù† ØªØ­Øª ØªØ¨Ù† ğŸŒŠ",
            "Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ø¨ÙŠÙ‚ÙˆÙ„ ÙŠØ§Ø±Ø¨ Ù…Ø­Ø¯Ø´ ÙŠØ³Ø£Ù„Ù†ÙŠ ğŸ¤²",
            "Ø§Ø±Ù…ÙŠ ÙƒÙ„Ù…Ø© ÙˆØ´ÙˆÙ Ø±Ø¯ Ø§Ù„ÙØ¹Ù„ ğŸ’£",
            "Ù…ÙŠÙ† Ø¹Ù…Ø§Ù„ ÙŠØ¨Øµ ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø©ØŸ âŒš",
            "Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ø¨ÙŠØ¨Øµ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØªÙƒÙ„Ù… Ø¨ØªØ±ÙƒÙŠØ² Ø£ÙˆÙŠ ğŸ§",
            "Ø¥Ø­Ø³Ø§Ø³ÙŠ Ø¨ÙŠÙ‚ÙˆÙ„ Ø¥Ù† Ø§Ù„Ù„ÙŠ Ø¬Ù†Ø¨Ùƒ Ù‡Ùˆ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ ğŸ‘‰",
            "Ù…ÙŠÙ† Ø±ÙŠÙ‚Ù‡ Ù†Ø§Ø´ÙØŸ ğŸ¥¤",
            "Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ø¨ÙŠØ­Ø§ÙˆÙ„ ÙŠØ¨Ø§Ù† Ø·Ø¨ÙŠØ¹ÙŠ Ø¨Ø§Ù„Ø¹Ø§ÙÙŠØ© ğŸ¤–",
            "ÙƒÙ„Ù‡ ØªØ­Øª Ø§Ù„Ø³ÙŠØ·Ø±Ø©.. Ù…Ø§Ø¹Ø¯Ø§ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ ğŸ¤¯",
            "Ø§Ù„Ù‡Ø¬ÙˆÙ… Ø®ÙŠØ± ÙˆØ³ÙŠÙ„Ø© Ù„Ù„Ø¯ÙØ§Ø¹.. Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù„ÙŠ Ø¨ÙŠÙ‡Ø§Ø¬Ù… âš”ï¸",
            "Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ù…Ø¨ÙŠØ­Ø¨Ø´ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© ğŸ“"
        ];
        
        // Use window.tipsInterval to ensure global scope and prevent memory leaks
        window.tipsInterval = null;

        function updateVotingTip() {
            const el = document.getElementById('discussion-tips-text');
            if(el) {
                // Fade out
                el.style.opacity = 0;
                setTimeout(() => {
                    el.innerText = SPY_TIPS[Math.floor(Math.random() * SPY_TIPS.length)];
                    // Fade in
                    el.style.opacity = 1;
                }, 300);
            }
        }

        function startSpyMix() {
            // Combine all categories into one mixed array
            const allWords = Object.values(SPY_CATEGORIES).flat();
            // Shuffle using Fisher-Yates
            for (let i = allWords.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allWords[i], allWords[j]] = [allWords[j], allWords[i]];
            }
            const word = getUniqueItem('spy_mix', allWords);
            const spyIndex = Math.floor(Math.random() * state.players.length);
            state.currentGame = { type: 'spy', phase: 'reveal', category: 'ÙƒÙˆÙƒØªÙŠÙ„ ğŸ”€', word, spyIndex, currentPlayerIndex: 0, revealed: false, timeLeft: 120, votes: {}, votingPlayerIndex: 0 };
            saveState();
            render();
        }
        
        function startSpyGame(cat) { const words = SPY_CATEGORIES[cat] || SPY_CATEGORIES['Ø£Ù…Ø§ÙƒÙ† Ø®Ø±ÙˆØ¬']; const word = getUniqueItem('spy_' + cat, words); const spyIndex = Math.floor(Math.random() * state.players.length); state.currentGame = { type: 'spy', phase: 'reveal', category: cat, word, spyIndex, currentPlayerIndex: 0, revealed: false, timeLeft: 120, votes: {}, votingPlayerIndex: 0 }; saveState(); render(); }
        function revealSpyWord() {
            if (state.currentGame.revealed) return;
            
            state.currentGame.revealed = true;
            playSound('click');
            saveState();

            const cardContent = document.getElementById('spy-card-content');
            const cardBtn = document.getElementById('spy-reveal-btn');
            
            if (cardContent && cardBtn) {
                // Update Card Glow
                cardBtn.classList.remove('from-indigo-500/50', 'via-purple-500/50', 'to-indigo-800/50');
                cardBtn.classList.add('from-emerald-500/50', 'to-emerald-900/50', 'shadow-[0_0_50px_rgba(16,185,129,0.4)]');

                const isSpy = state.currentGame.spyIndex === state.currentGame.currentPlayerIndex;
                
                // Inject Content
                cardContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center text-center h-full w-full animate-enter">
                        ${isSpy ? 
                        `
                            <div class="text-8xl mb-6 drop-shadow-[0_0_15px_rgba(239,68,68,0.5)]">ğŸ•µï¸</div>
                            <h2 class="text-4xl font-black text-red-500 mb-2">Ø£Ù†Øª Ø§Ù„Ø¬Ø§Ø³ÙˆØ³!</h2>
                            <p class="text-slate-300 text-sm">Ø§Ø¹Ù…Ù„ Ù†ÙØ³Ùƒ Ù…Ù† Ø¨Ù†Ù‡Ø§ ğŸ˜‰</p>
                        ` : 
                        `
                            <div class="flex-1 flex flex-col items-center justify-center">
                                <p class="text-indigo-300 text-xs font-bold uppercase tracking-widest mb-6 opacity-70">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù‡ÙŠ</p>
                                <h2 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-indigo-200 leading-tight drop-shadow-lg">${state.currentGame.word}</h2>
                            </div>
                            <p class="text-slate-400 text-xs mt-auto">Ø§Ù‚ÙØ´ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³!</p>
                        `}
                    </div>
                `;
            }
        }
        function nextSpyPlayer() {
            // VALIDATION CHECK
            if (!state.currentGame.revealed) {
                playSound('fail');
                
                // Create Temporary Warning Toast
                const warning = document.createElement('div');
                warning.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-red-600 text-white px-8 py-3 rounded-full font-bold shadow-2xl z-[100] animate-in border-2 border-red-400 whitespace-nowrap';
                warning.innerText = '( Ø§ÙƒØ´Ù Ø§Ù… Ø§Ù„ÙƒØ§Ø±Øª .. ÙÙˆÙˆÙˆÙˆÙ‚ Ø¨Ù‚ÙŠ ğŸ˜¡ )';
                document.body.appendChild(warning);
                
                // Remove after 2 seconds
                setTimeout(() => {
                    warning.style.opacity = '0';
                    warning.style.transition = 'opacity 0.3s';
                    setTimeout(() => warning.remove(), 300);
                }, 2000);
                
                return; // Stop execution
            }

            // Existing Logic...
            if(state.currentGame.currentPlayerIndex < state.players.length - 1) { 
                state.currentGame.currentPlayerIndex++; 
                state.currentGame.revealed = false; 
            } else { 
                state.currentGame.phase = 'discuss'; 
                startSpyTimer(); 
            } 
            render();
        }
        function startSpyTimer() {
            if (gameInterval) clearInterval(gameInterval);
            
            // Initial render to show the timer immediately
            render();

            // Start Tips Rotation for Discussion Phase
            if (window.tipsInterval) {
                clearInterval(window.tipsInterval);
                window.tipsInterval = null;
            }
            setTimeout(updateVotingTip, 100); // Initial tip
            window.tipsInterval = setInterval(updateVotingTip, 3500);

            gameInterval = setInterval(() => {
                state.currentGame.timeLeft--;
                
                // OPTIMIZED: Update DOM directly, NO full re-render
                const timerEl = document.getElementById('spy-timer-display');
                if (timerEl) {
                    timerEl.innerText = getTimer(state.currentGame.timeLeft);
                }

                if (state.currentGame.timeLeft <= 0) {
                    clearInterval(gameInterval);
                    if (window.tipsInterval) {
                        clearInterval(window.tipsInterval);
                        window.tipsInterval = null;
                    }
                    startSpyVoting();
                } else if (state.currentGame.timeLeft <= 10) {
                    playSound('tick');
                }
                
                // Removed saveState() and render() from interval for performance
            }, 1000);
        }
        function startSpyVoting() {
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
            // Fix memory leak: Ensure tips interval is cleared
            if (window.tipsInterval) {
                clearInterval(window.tipsInterval);
                window.tipsInterval = null;
            }
            state.currentGame.phase = 'voting';
            state.currentGame.votingPlayerIndex = 0;
            playSound('fail'); // Alarm sound
            saveState();
            render(); // Render the new voting screen structure
        }
        function voteForSpy(suspectedPlayerId) {
            const voter = state.players[state.currentGame.votingPlayerIndex];
            state.currentGame.votes[voter.id] = suspectedPlayerId;
            if (state.currentGame.votingPlayerIndex < state.players.length - 1) {
                state.currentGame.votingPlayerIndex++;
                playSound('click');
                render();
            } else {
                // Clear tips interval when voting is complete
                if (window.tipsInterval) {
                    clearInterval(window.tipsInterval);
                    window.tipsInterval = null;
                }
                // Calculate results
                const spyId = state.players[state.currentGame.spyIndex].id;
                const voteCounts = {};
                Object.values(state.currentGame.votes).forEach(votedId => {
                    voteCounts[votedId] = (voteCounts[votedId] || 0) + 1;
                });
                
                let spyFound = false;
                if (Object.keys(voteCounts).length > 0) {
                    const maxVotes = Math.max(...Object.values(voteCounts));
                    const mostVoted = Object.keys(voteCounts).find(id => voteCounts[id] === maxVotes);
                    if (mostVoted) {
                        spyFound = parseInt(mostVoted) === spyId;
                    }
                }
                
                if (spyFound) {
                    // All players except spy get +1
                    state.players.forEach(p => {
                        if (p.id !== spyId) updateScore(p.id, false, 1);
                    });
                } else {
                    // Spy gets +2
                    updateScore(spyId, false, 2);
                }
                
                state.currentGame.spyFound = spyFound;
                state.currentGame.phase = 'result';
                playSound(spyFound ? 'success' : 'fail');
                saveState();
                render();
            }
        }
        function restartSpyGame() { startSpyGame(state.currentGame.category); }
        function renderSpySetup() { 
            if(!state.currentGame || state.currentGame.type !== 'spy') {
                const categories = Object.keys(SPY_CATEGORIES);
                return `
                    <div class="p-6 h-screen flex flex-col bg-indigo-50">
                        ${header('ğŸ•µï¸ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³', 'home')}
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">ğŸ•µï¸</div>
                            <h3 class="font-bold text-indigo-800 mb-2">Ø§Ø®ØªØ§Ø± Ø§Ù„ÙØ¦Ø©:</h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4 flex-1 overflow-y-auto content-start pb-32">
                            ${categories.map(cat => `
                                <button onclick="startSpyGame('${cat}')" class="w-full min-h-[80px] flex items-center justify-center py-6 rounded-2xl font-black text-xl shadow-md border-b-4 bg-white border-indigo-500 text-indigo-600 hover:bg-indigo-50 transition active:scale-95 text-center break-words leading-tight">
                                    ${cat}
                                </button>
                            `).join('')}
                        </div>
                        <button onclick="startSpyMix()" class="fixed bottom-6 left-4 right-4 bg-gradient-to-r from-orange-500 via-pink-500 to-purple-600 text-white font-black text-xl py-4 rounded-2xl shadow-[0_4px_15px_rgba(0,0,0,0.3)] hover:scale-105 transition-transform z-50 flex justify-center items-center gap-2 active:scale-95">
                            <span>ğŸ”€</span> ÙƒÙˆÙƒØªÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                        </button>
                    </div>
                `;
            } 
            const game = state.currentGame;
            if(game.phase === 'reveal') { 
                const p = state.players[game.currentPlayerIndex];
                return `
                <div class="h-screen flex flex-col items-center justify-center bg-indigo-900 text-white p-6 overflow-hidden relative">
                    <div class="absolute top-[-10%] left-[-10%] w-64 h-64 bg-indigo-600/20 rounded-full blur-3xl"></div>
                    <div class="absolute bottom-[-10%] right-[-10%] w-64 h-64 bg-purple-600/20 rounded-full blur-3xl"></div>

                    <h1 class="text-4xl font-black mb-8 text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-300 relative z-10">${escapeHtml(p.name)}</h1>
                    
                    <button id="spy-reveal-btn" onclick="revealSpyWord()" class="relative group w-full max-w-sm aspect-[3/4] rounded-[2rem] p-1 bg-gradient-to-br from-indigo-500/50 via-purple-500/50 to-indigo-800/50 shadow-[0_0_40px_rgba(79,70,229,0.3)] transition-all duration-300 hover:scale-[1.02] active:scale-95">
                        <div class="w-full h-full bg-indigo-950/90 backdrop-blur-xl rounded-[1.8rem] flex flex-col items-center justify-center p-6 border border-white/10 relative overflow-hidden" id="spy-card-content">
                            <div class="flex flex-col items-center text-center animate-in">
                                <div class="text-7xl mb-6 opacity-80 group-hover:scale-110 transition-transform duration-500">ğŸ”’</div>
                                <h2 class="text-2xl font-bold text-white mb-2">Ù…Ù‡Ù…Ø© Ø³Ø±ÙŠØ©</h2>
                                <p class="text-indigo-200 opacity-80 text-sm">Ø¯ÙˆØ³ Ù‡Ù†Ø§ Ø¹Ø´Ø§Ù† ØªØ¹Ø±Ù Ø§Ù†Øª Ù…ÙŠÙ†..<br>ÙˆØ§ÙˆØ¹Ù‰ Ø­Ø¯ ÙŠØ¨Øµ Ù…Ø¹Ø§Ùƒ! ğŸ¤«</p>
                                <div class="mt-8 px-6 py-2 rounded-full bg-indigo-500/20 border border-indigo-500/50 text-indigo-300 text-xs font-bold animate-pulse">Ø§Ø¶ØºØ· Ù„Ù„ÙƒØ´Ù</div>
                            </div>
                        </div>
                    </button>

                    <button onclick="nextSpyPlayer()" class="mt-8 w-full max-w-sm py-4 bg-yellow-500 hover:bg-yellow-400 text-slate-900 rounded-2xl font-black text-xl border-b-4 border-yellow-700 active:border-b-0 active:translate-y-1 transition relative z-10 shadow-xl shadow-yellow-900/20">
                        Ø§Ù„ØªØ§Ù„ÙŠ (Ø®Ø¨Ù‘ÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„) ğŸ«£
                    </button>
                </div>`;
            } 
            if(game.phase === 'discuss') {
                return `
                <div class="h-screen flex flex-col p-6 bg-indigo-900 text-white">
                    <h1 class="text-3xl font-bold text-center mt-10 text-indigo-100">Ù†Ø§Ù‚Ø´ÙˆØ§ ÙˆØ§Ø¹Ø±ÙÙˆØ§ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³!</h1>
                    <div id="spy-timer-display" class="text-6xl mt-8 font-black text-yellow-400 mx-auto" style="font-family: 'Cairo', sans-serif; font-variant-numeric: tabular-nums; width: 300px; text-align: center; font-weight: 900;">${getTimer(game.timeLeft)}</div>
                    
                    <div class="flex-1 flex items-center justify-center z-10">
                        <div class="bg-white/5 border border-white/10 p-6 rounded-2xl w-full max-w-sm text-center backdrop-blur-md shadow-lg flex flex-col items-center justify-center min-h-[140px]">
                            <div class="text-indigo-400 text-xs font-bold mb-2 tracking-widest uppercase bg-indigo-950/30 px-3 py-1 rounded-full">ØªÙ„Ù…ÙŠØ­:</div>
                            <p id="discussion-tips-text" class="text-xl font-bold text-indigo-100 transition-all duration-500 flex items-center justify-center leading-relaxed">
                                ${SPY_TIPS[0]}
                            </p>
                        </div>
                    </div>
                    
                    <button onclick="startSpyVoting()" class="w-full bg-red-600 hover:bg-red-700 text-white py-4 rounded-xl font-bold text-lg transition shadow-lg">
                        Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØµÙˆÙŠØª
                    </button>
                </div>`;
            } 
            if(game.phase === 'voting') {
                const voter = state.players[game.votingPlayerIndex];
                return `
                <div class="h-screen flex flex-col items-center justify-center p-6 bg-indigo-900 text-white relative overflow-hidden animate-in gap-10">
                    <div class="text-center relative z-10 w-full">
                        <div class="text-6xl mb-4 drop-shadow-md">ğŸ§</div>
                        <p class="text-indigo-300 font-bold text-sm uppercase tracking-widest mb-2">Ù…ÙŠÙ† Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ ÙÙŠ Ø±Ø£ÙŠÙƒ ÙŠØ§</p>
                        <h1 class="text-5xl font-black text-yellow-400 drop-shadow-[0_4px_10px_rgba(250,204,21,0.3)] leading-tight">
                            ${voter.name}
                        </h1>
                    </div>

                    <div class="w-full max-h-[50vh] overflow-y-auto relative z-10">
                        <p class="text-center text-indigo-400 text-xs mb-3 font-bold">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´ÙƒÙˆÙƒ ÙÙŠÙ‡ ğŸ‘‡</p>
                        <div class="grid grid-cols-2 gap-4">
                            ${state.players.map(p => `
                            <button onclick="voteForSpy(${p.id})" class="py-5 bg-indigo-800 hover:bg-indigo-600 rounded-2xl font-bold text-xl transition-all border-2 border-indigo-700 hover:border-indigo-400 shadow-lg active:scale-95 flex items-center justify-center gap-2 group">
                                <span class="grayscale group-hover:grayscale-0 transition">ğŸ‘¤</span> ${escapeHtml(p.name)}
                            </button>`).join('')}
                        </div>
                    </div>
                </div>`;
            }
            return `<div class="h-screen flex flex-col items-center justify-center bg-slate-900 text-white p-6 text-center"><div class="text-6xl mb-6">${game.spyFound ? 'ğŸ‰' : 'ğŸ•µï¸'}</div><h1 class="text-4xl mb-4 font-bold ${game.spyFound ? 'text-green-400' : 'text-red-400'}">${game.spyFound ? 'Ø¹Ø±ÙÙˆØ§ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³!' : 'Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ ÙÙ„Øª!'}</h1><div class="bg-white/10 p-6 rounded-2xl mb-6 w-full"><p class="text-xl mb-2">Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ ÙƒØ§Ù†:</p><h2 class="text-3xl font-black text-yellow-300">${state.players[game.spyIndex].name}</h2><p class="text-lg mt-4 opacity-80">Ø§Ù„ÙƒÙ„Ù…Ø©: ${game.word}</p></div><div class="mb-6"><p class="text-lg opacity-80">${game.spyFound ? 'ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ù…Ø§Ø¹Ø¯Ø§ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³) Ø£Ø®Ø°ÙˆØ§ +1 Ù†Ù‚Ø·Ø©' : 'Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ø£Ø®Ø° +2 Ù†Ù‚Ø·Ø©'}</p></div><button onclick="restartSpyGame()" class="w-full py-4 bg-indigo-600 rounded-xl font-bold text-xl mb-3">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 rounded-xl font-bold">Ø®Ø±ÙˆØ¬</button></div>`; 
        }

        // --- CHARADES ---
        function startCharadesMix() {
            console.log('ğŸ”€ Mix Button Clicked for [Charades - Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ø§Ù…]');
            
            // Combine all categories into one mixed array
            let allWords = Object.values(CHARADES_DATA).flat();
            
            // Remove duplicates
            allWords = [...new Set(allWords)];
            
            console.log(`âœ… Total Items found: ${allWords.length}`);
            console.log(`ğŸ“ Sample Items: [${allWords.slice(0, 5).join(', ')}...]`);
            
            // Shuffle using Fisher-Yates
            for (let i = allWords.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allWords[i], allWords[j]] = [allWords[j], allWords[i]];
            }
            const word = getUniqueItem('charades_mix', allWords);
            const actor = getFairPlayer();
            state.currentGame = { type: 'charades', phase: 'prepare', category: 'ÙƒÙˆÙƒØªÙŠÙ„ ğŸ”€', word, actor, revealed: false, timeLeft: 60 };
            playSound('click');
            render();
        }
        
        function startCharadesGame(cat) { const words = CHARADES_DATA[cat]; const word = getUniqueItem('charades_' + cat, words); const actor = getFairPlayer(); state.currentGame = { type: 'charades', phase: 'prepare', category: cat, word, actor, revealed: false, timeLeft: 60 }; playSound('click'); render(); }
        function startCharadesRound() { state.currentGame.phase = 'acting'; playSound('click'); saveState(); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = getTimer(state.currentGame.timeLeft); if(state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); charadesFail(); return; } if(state.currentGame.timeLeft <= 10) playSound('tick'); }, 1000); }
        function charadesSuccess() { updateScore(state.currentGame.actor.id, false, 1); startCharadesGame(state.currentGame.category); }
        function charadesFail() { if(state.daresEnabled) showDare(); startCharadesGame(state.currentGame.category); }
        function renderCharadesSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'charades') { 
                const categories = Object.keys(CHARADES_DATA); 
                return `
                    <div class="p-6 h-screen flex flex-col bg-rose-50">
                        ${header('ğŸ­ Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ø§Ù…', 'home')}
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">ğŸ­</div>
                            <h3 class="font-bold text-rose-800 mb-2">Ø§Ø®ØªØ§Ø± Ø§Ù„ÙØ¦Ø©:</h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4 flex-1 overflow-y-auto content-start pb-32">
                            ${categories.map(cat => `
                                <button onclick="startCharadesGame('${cat}')" class="py-6 rounded-2xl font-black text-xl shadow-md border-b-4 bg-white border-rose-500 text-rose-600 hover:bg-rose-50 transition active:scale-95">
                                    ${cat}
                                </button>
                            `).join('')}
                        </div>
                        <button onclick="startCharadesMix()" class="fixed bottom-6 left-4 right-4 bg-gradient-to-r from-orange-500 via-pink-500 to-purple-600 text-white font-black text-xl py-4 rounded-2xl shadow-[0_4px_15px_rgba(0,0,0,0.3)] hover:scale-105 transition-transform z-50 flex justify-center items-center gap-2 active:scale-95">
                            <span>ğŸ”€</span> ÙƒÙˆÙƒØªÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                        </button>
                    </div>
                `; 
            } 
            const game = state.currentGame; 
            if (game.phase === 'prepare') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-rose-600 text-white text-center animate-in"><p class="text-xl opacity-80 mb-2">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰</p><h1 class="text-4xl font-black mb-8">${game.actor.name}</h1><div class="bg-white/10 p-6 rounded-2xl border-2 border-white/20 w-full mb-8 relative overflow-hidden">${!game.revealed ? `<div onclick="state.currentGame.revealed = true; render()" class="absolute inset-0 bg-rose-800 z-10 flex items-center justify-center cursor-pointer hover:bg-rose-700 transition"><span class="text-xl font-bold animate-pulse">Ø¯ÙˆØ³ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø§Ù„ÙƒÙ„Ù…Ø©</span></div>` : ''}<p class="text-sm mb-2 opacity-75">Ù…Ø·Ù„ÙˆØ¨ ØªÙ…Ø«ÙŠÙ„:</p><h2 class="text-3xl font-bold text-yellow-300">${game.word}</h2></div><button onclick="startCharadesRound()" class="w-full py-4 bg-white text-rose-700 rounded-xl font-bold text-xl">Ø¬Ø§Ù‡Ø²! Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¤Ù‚Øª</button></div>`; 
            if (game.phase === 'acting') return `<div class="h-screen flex flex-col p-6 bg-white"><div class="text-center mt-4 mb-8"><p class="text-lg font-bold opacity-80">Ø§Ù„Ù…Ù…Ø«Ù„: <span class="text-rose-600">${game.actor.name}</span></p><h1 class="text-3xl font-black leading-relaxed text-center text-slate-800 mt-2">${game.word}</h1></div><div class="flex-1 flex flex-col justify-center items-center"><div class="text-8xl font-black text-rose-600" id="game-timer">${getTimer(game.timeLeft)}</div></div><div class="space-y-3"><button onclick="charadesSuccess()" class="w-full py-4 bg-green-500 text-white rounded-xl font-bold text-xl shadow-lg">âœ“ Ø¹Ø±ÙÙˆÙ‡Ø§!</button><button onclick="charadesFail()" class="w-full py-3 bg-slate-200 text-slate-600 rounded-xl font-bold">Ù…Ø¹Ø±ÙÙˆØ´ (ØªØ®Ø·ÙŠ)</button></div></div>`; 
        }

        // --- QUOTES ---
        function startQuotesGame() { const quote = getUniqueItem('quotes', QUOTES_DATA); const reader = getFairPlayer(); state.currentGame = { type: 'quotes', phase: 'play', quote, reader, revealed: false }; playSound('click'); render(); }
        function revealQuoteAnswer() { state.currentGame.phase = 'answer'; playSound('click'); render(); }
        function quotePlayerWins(pid) { updateScore(pid, false, 1); startQuotesGame(); }
        function nextQuoteRound() { startQuotesGame(); }
        function renderQuotesSetup() { if (!state.currentGame || state.currentGame.type !== 'quotes') return renderGameStartScreen('Ø§Ù„Ø§ÙÙŠÙ‡Ø§Øª', 'ÙˆØ§Ø­Ø¯ Ù‡ÙŠÙ‚Ø±Ø£ Ø§Ù„Ø§ÙÙŠÙ‡ØŒ ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ Ù„Ø§Ø²Ù… ÙŠØ®Ù…Ù† Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…/Ø§Ù„Ù…Ø³Ø±Ø­ÙŠØ© ÙˆØ§Ù„Ù…Ù…Ø«Ù„.', 'ğŸ¬', 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨', 'startQuotesGame()', 'bg-emerald-600'); const game = state.currentGame; if (game.phase === 'play') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-emerald-700 text-white text-center animate-in"><p class="text-emerald-200 mb-2">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰: <span class="font-bold text-white text-lg">${game.reader.name}</span></p><div class="text-sm bg-black/20 px-3 py-1 rounded-full mb-8">Ø§Ù‚Ø±Ø£ Ø§Ù„Ø§ÙÙŠÙ‡ Ø¨ØµÙˆØª Ø¹Ø§Ù„ÙŠ</div><div class="relative mb-10 w-full">${!game.revealed ? `<div onclick="state.currentGame.revealed = true; render()" class="absolute inset-0 bg-emerald-800 z-10 rounded-xl flex items-center justify-center cursor-pointer hover:bg-emerald-900 transition h-32"><span class="text-xl font-bold animate-pulse">Ø¯ÙˆØ³ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø§Ù„Ø§ÙÙŠÙ‡</span></div>` : `<div class="text-6xl absolute -top-8 -right-4 text-emerald-400 opacity-50">"</div><h2 class="text-3xl font-black leading-relaxed px-4">${game.quote.quote}</h2><div class="text-6xl absolute -bottom-12 -left-4 text-emerald-400 opacity-50">"</div>`}</div>${game.revealed ? `<button onclick="revealQuoteAnswer()" class="w-full py-4 bg-white text-emerald-800 rounded-xl font-bold text-xl shadow-lg mt-8">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>` : ''}</div>`; if (game.phase === 'answer') return `<div class="h-screen flex flex-col p-6 bg-white"><div class="text-center mt-8 mb-8 border-b-2 border-slate-100 pb-8"><h2 class="text-slate-500 mb-2">Ø§Ù„Ø§ÙÙŠÙ‡ ÙƒØ§Ù†:</h2><p class="text-xl font-bold text-slate-800 mb-6">"${game.quote.quote}"</p><div class="space-y-2"><div class="inline-block px-4 py-2 bg-emerald-100 text-emerald-800 rounded-lg font-bold mx-1">ğŸ¬ ${game.quote.work}</div><div class="inline-block px-4 py-2 bg-amber-100 text-amber-800 rounded-lg font-bold mx-1">ğŸ‘¤ ${game.quote.actor}</div></div></div><h3 class="text-center font-bold text-slate-700 mb-4">Ù…ÙŠÙ† Ø¹Ø±ÙÙ‡Ø§ØŸ</h3><div class="grid grid-cols-2 gap-3 flex-1 overflow-y-auto pb-4">${state.players.map(p => `<button onclick="quotePlayerWins(${p.id})" class="p-3 bg-slate-50 border border-slate-200 rounded-lg font-semibold text-slate-700 hover:bg-emerald-50 ${p.id === game.reader.id ? 'opacity-75' : ''}">${escapeHtml(p.name)}${p.id === game.reader.id ? ' (Ø§Ù„Ù‚Ø§Ø±Ø¦)' : ''}</button>`).join('')}</div><div class="mt-4 space-y-2"><button onclick="nextQuoteRound()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">Ù…Ø­Ø¯Ø´ Ø¹Ø±Ù (Ø§Ù„ØªØ§Ù„ÙŠ)</button></div></div>`; }

        // --- FIVE SECOND ---
        function startFiveSecondGame() { const question = getUniqueItem('five_second', FIVE_SECOND_QUESTIONS); const player = getFairPlayer(); state.currentGame = { type: 'fivesecond', phase: 'prepare', question, player, revealed: false, timeLeft: 5 }; playSound('click'); render(); }
        function startFiveSecondRound() { state.currentGame.phase = 'playing'; playSound('click'); saveState(); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); fiveSecondFail(); return; } if (state.currentGame.timeLeft <= 5) playSound('tick'); }, 1000); }
        function fiveSecondSuccess() { updateScore(state.currentGame.player.id, false, 1); startFiveSecondGame(); }
        function fiveSecondFail() { if(state.daresEnabled) showDare(); startFiveSecondGame(); }
        function renderFiveSecondSetup() { 
            if (!state.currentGame || state.currentGame.type !== 'fivesecond') return renderGameStartScreen('Ø®Ù…Ø³Ø© Ø¹Ù„ÙŠÙƒ', 'Ø§Ø°ÙƒØ± Ù£ Ø£Ø´ÙŠØ§Ø¡ ÙÙŠ Ù¥ Ø«ÙˆØ§Ù†ÙŠ. Ù„Ùˆ Ù†Ø¬Ø­Øª ØªØ§Ø®Ø¯ Ù†Ù‚Ø·Ø©ØŒ Ù„Ùˆ ÙØ´Ù„Øª.. ÙŠØ§ ÙˆÙŠÙ„Ù‡!', 'â±ï¸', 'Ø§Ø¨Ø¯Ø£ Ø£ÙˆÙ„ Ø¬ÙˆÙ„Ø©', 'startFiveSecondGame()', 'bg-teal-600'); 
            const game = state.currentGame; 
            if (game.phase === 'prepare') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-teal-600 text-white text-center animate-in"><p class="text-xl opacity-80 mb-2">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰</p><h1 class="text-4xl font-black mb-8">${escapeHtml(game.player.name)}</h1><div class="bg-white/10 p-6 rounded-2xl border-2 border-white/20 w-full mb-8 relative overflow-hidden">${!game.revealed ? `<div onclick="state.currentGame.revealed = true; render()" class="absolute inset-0 bg-teal-800 z-10 flex items-center justify-center cursor-pointer hover:bg-teal-700 transition"><span class="text-xl font-bold animate-pulse">Ø¯ÙˆØ³ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø§Ù„Ø³Ø¤Ø§Ù„</span></div>` : ''}<p class="text-sm mb-2 opacity-75">Ù…Ø·Ù„ÙˆØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰:</p><h2 class="text-3xl font-bold text-yellow-300">${game.question.text}</h2></div><button onclick="startFiveSecondRound()" class="w-full py-4 bg-white text-teal-700 rounded-xl font-bold text-xl" ${!game.revealed ? 'disabled opacity-50' : ''}>Ø¬Ø§Ù‡Ø²! Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©</button></div>`; 
            if (game.phase === 'playing') return `<div class="h-screen flex flex-col p-6 bg-white"><div class="text-center mt-4 mb-8"><p class="text-lg font-bold opacity-80">Ø§Ù„Ù„Ø§Ø¹Ø¨: <span class="text-teal-600">${escapeHtml(game.player.name)}</span></p><h1 class="text-3xl font-black leading-relaxed text-center text-slate-800 mt-2">${game.question.text}</h1></div><div class="flex-1 flex flex-col justify-center items-center"><div class="text-9xl font-black ${game.timeLeft <= 2 ? 'text-red-600 animate-pulse' : 'text-teal-600'}" id="game-timer">${game.timeLeft}</div></div><div class="space-y-3"><button onclick="fiveSecondSuccess()" class="w-full py-4 bg-green-500 text-white rounded-xl font-bold text-xl shadow-lg">âœ“ Ø£Ø­Ø³Ù†Øª! (Ø£Ø¬Ø§Ø¨ ØµØ­)</button><button onclick="fiveSecondFail()" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold shadow-lg">ğŸ’€ ÙØ´Ù„! (Ø¹Ù‚ÙˆØ¨Ø©)</button></div></div>`; 
        }

        // --- BUS ---
        function startBusGame() { 
            const arabicLetters = ['Ø£', 'Ø¨', 'Øª', 'Ø«', 'Ø¬', 'Ø­', 'Ø®', 'Ø¯', 'Ø°', 'Ø±', 'Ø²', 'Ø³', 'Ø´', 'Øµ', 'Ø¶', 'Ø·', 'Ø¹', 'Øº', 'Ù', 'Ù‚', 'Ùƒ', 'Ù„', 'Ù…', 'Ù†', 'Ù‡', 'Ùˆ', 'ÙŠ']; 
            const category = getUniqueItem('bus_categories', BUS_CATEGORIES);
            const letter = arabicLetters[Math.floor(Math.random() * arabicLetters.length)];
            
            state.currentGame = { type: 'bus', phase: 'ready', category, letter, playerIndex: 0, results: [], timeLeft: 10, lastCategory: category.name, lastLetter: letter }; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function startBusTimerNow() { state.currentGame.phase = 'playing'; playSound('click'); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); busPlayerFail(); return; } if (state.currentGame.timeLeft <= 5) playSound('tick'); }, 1000); }
        function generateNewBusRound() {
            const arabicLetters = ['Ø£', 'Ø¨', 'Øª', 'Ø«', 'Ø¬', 'Ø­', 'Ø®', 'Ø¯', 'Ø°', 'Ø±', 'Ø²', 'Ø³', 'Ø´', 'Øµ', 'Ø¶', 'Ø·', 'Ø¹', 'Øº', 'Ù', 'Ù‚', 'Ùƒ', 'Ù„', 'Ù…', 'Ù†', 'Ù‡', 'Ùˆ', 'ÙŠ'];
            const lastCategory = state.currentGame.lastCategory;
            const lastLetter = state.currentGame.lastLetter;
            const currentPlayer = state.players[state.currentGame.playerIndex];
            
            let category, letter;
            // If not first player and same player as last, avoid same category and letter
            if (state.currentGame.playerIndex > 0 && lastCategory && lastLetter) {
                const lastPlayer = state.players[state.currentGame.playerIndex - 1];
                if (currentPlayer.id === lastPlayer.id) {
                    let availableCategories = BUS_CATEGORIES.filter(c => c.name !== lastCategory);
                    let availableLetters = arabicLetters.filter(l => l !== lastLetter);
                    category = availableCategories.length > 0 ? availableCategories[Math.floor(Math.random() * availableCategories.length)] : BUS_CATEGORIES[Math.floor(Math.random() * BUS_CATEGORIES.length)];
                    letter = availableLetters.length > 0 ? availableLetters[Math.floor(Math.random() * availableLetters.length)] : arabicLetters[Math.floor(Math.random() * arabicLetters.length)];
                } else {
                    category = BUS_CATEGORIES[Math.floor(Math.random() * BUS_CATEGORIES.length)];
                    letter = arabicLetters[Math.floor(Math.random() * arabicLetters.length)];
                }
            } else {
                category = BUS_CATEGORIES[Math.floor(Math.random() * BUS_CATEGORIES.length)];
                letter = arabicLetters[Math.floor(Math.random() * arabicLetters.length)];
            }
            
            state.currentGame.category = category;
            state.currentGame.letter = letter;
            state.currentGame.lastCategory = category.name;
            state.currentGame.lastLetter = letter;
        }
        function busPlayerSuccess() { const player = state.players[state.currentGame.playerIndex]; state.currentGame.results.push({ player, success: true }); updateScore(player.id, false, 1); if (state.currentGame.playerIndex < state.players.length - 1) { state.currentGame.playerIndex++; generateNewBusRound(); state.currentGame.timeLeft = 10; state.currentGame.phase = 'ready'; playSound('success'); saveState(); render(); } else { state.currentGame.phase = 'result'; playSound('success'); saveState(); render(); } }
        function busPlayerFail() { const player = state.players[state.currentGame.playerIndex]; state.currentGame.results.push({ player, success: false }); if (state.currentGame.playerIndex < state.players.length - 1) { state.currentGame.playerIndex++; generateNewBusRound(); state.currentGame.timeLeft = 10; state.currentGame.phase = 'ready'; playSound('fail'); saveState(); render(); } else { state.currentGame.phase = 'result'; playSound('fail'); saveState(); render(); } }
        function nextBusRound() { startBusGame(); }
        function renderBusSetup() { if (!state.currentGame || state.currentGame.type !== 'bus') return renderGameStartScreen('Ø£ÙˆØªÙˆØ¨ÙŠØ³ ÙƒÙˆÙ…Ø¨Ù„ÙŠØª', 'ÙƒÙ„ Ø¬ÙˆÙ„Ø© ØªØ¸Ù‡Ø± ÙØ¦Ø© ÙˆØ§Ù„Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„. ÙÙŠ Ù¡Ù  Ø«ÙˆØ§Ù†ÙŠ ÙƒÙ„ Ù„Ø§Ø¹Ø¨ ÙŠÙ‚ÙˆÙ„ ÙƒÙ„Ù…Ø© ØªØ¨Ø¯Ø£ Ø¨Ø§Ù„Ø­Ø±Ù. Ù„Ùˆ Ù†Ø¬Ø­ØªÙˆØ§ ÙƒÙ„ÙƒÙ… +Ù¡ Ù„ÙƒÙ„ Ù†Ø§Ø¬Ø­!', 'ğŸšŒ', 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©', 'startBusGame()', 'bg-purple-600'); const game = state.currentGame; if (game.phase === 'ready') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-purple-600 text-white text-center animate-in"><div class="text-2xl opacity-80 mb-2">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰:</div><div class="text-5xl font-bold mb-10">${state.players[game.playerIndex].name}</div><div onclick="startBusTimerNow()" class="w-40 h-40 bg-purple-500 rounded-full flex items-center justify-center cursor-pointer shadow-lg animate-pulse hover:scale-105 transition border-4 border-white/20"><span class="text-2xl font-bold">Ø¯ÙˆØ³<br>Ø¹Ø´Ø§Ù† ØªØ¨Ø¯Ø£</span></div></div>`; if (game.phase === 'playing') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-purple-600 text-white text-center"><div class="bg-white/20 p-6 rounded-3xl mb-8 w-full"><div class="text-sm opacity-80 mb-2">Ø§Ù„ÙØ¦Ø©</div><div class="text-4xl font-black mb-4">${game.category.name}</div><div class="text-sm opacity-80 mb-2">Ø§Ù„Ø­Ø±Ù</div><div class="text-6xl font-black text-yellow-300">${game.letter}</div></div><div class="mb-6"><div class="text-lg opacity-90 mb-2">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰:</div><div class="text-3xl font-bold">${state.players[game.playerIndex].name}</div></div><div class="text-7xl font-black mb-8" id="game-timer">${game.timeLeft}</div><div class="grid grid-cols-2 gap-3 w-full"><button onclick="busPlayerSuccess()" class="py-3 bg-green-500 rounded-xl font-bold">âœ“ Ù†Ø¬Ø­</button><button onclick="busPlayerFail()" class="py-3 bg-red-500 rounded-xl font-bold">âœ— ÙØ´Ù„</button></div></div>`; if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-purple-900 text-white text-center"><h2 class="text-3xl font-bold mb-6">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¬ÙˆÙ„Ø©!</h2><div class="bg-white/10 p-6 rounded-2xl w-full mb-8">${game.results.map(r => `<div class="flex justify-between items-center py-2 border-b border-white/20"><span>${r.player.name}</span><span class="text-2xl">${r.success ? 'âœ“' : 'âœ—'}</span></div>`).join('')}</div><button onclick="nextBusRound()" class="w-full py-4 bg-purple-500 rounded-xl font-bold text-xl">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 rounded-xl font-bold mt-3">Ø®Ø±ÙˆØ¬</button></div>`; }

        // --- LIAR ---
        function startLiarGame() { const card = getUniqueItem('liar', LIAR_CARDS); const player = getFairPlayer(); state.currentGame = { type: 'liar', phase: 'ready', card, player, selectedFact: null, timeLeft: 15 }; playSound('click'); render(); }
        function startLiarTimerNow() { state.currentGame.phase = 'reading'; playSound('click'); saveState(); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); if (state.currentGame.selectedFact !== null) revealLiarCard(); } if (state.currentGame.timeLeft <= 5) playSound('tick'); }, 1000); }
        function selectLiarFact(index) { state.currentGame.selectedFact = index; playSound('click'); render(); }
        function revealLiarCard() { state.currentGame.phase = 'result'; playSound('click'); saveState(); render(); }
        function liarGameAddPoint() { const p = getFairPlayer(); updateScore(p.id, false, 1); nextLiarRound(); }
        function nextLiarRound() { startLiarGame(); }
        function renderLiarSetup() { if (!state.currentGame || state.currentGame.type !== 'liar') return renderGameStartScreen('Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„ÙƒØ¯Ø§Ø¨', 'ÙƒÙ„ ÙƒØ§Ø±Øª ÙÙŠÙ‡ Ù£ Ø­Ù‚Ø§Ø¦Ù‚ØŒ Ù„ÙƒÙ† ÙˆØ§Ø­Ø¯Ø© ÙƒØ°Ø¨Ø©. Ø§Ù…Ø³Ùƒ Ø§Ù„ÙƒØ°Ø¨Ø© ÙÙŠ Ù¡Ù¥ Ø«Ø§Ù†ÙŠØ©!', 'ğŸƒ', 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©', 'startLiarGame()', 'bg-orange-600'); const game = state.currentGame; if (game.phase === 'ready') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-orange-600 text-white text-center animate-in"><p class="text-xl opacity-80 mb-2">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰</p><h1 class="text-4xl font-black mb-6">${escapeHtml(game.player.name)}</h1><div class="text-6xl mb-6">ğŸƒ</div><h2 class="text-3xl font-bold mb-8">Ø¬Ø§Ù‡Ø² ÙŠØ§ Ø¨Ø·Ù„ØŸ</h2><p class="text-xl opacity-90 mb-10">Ù‡Ø¯ÙŠÙƒ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„.. Ø§Ù‚Ø±Ø£ Ø§Ù„Ù€ 3 Ø­Ù‚Ø§Ø¦Ù‚ Ø¨Ø³Ø±Ø¹Ø©!</p><div onclick="startLiarTimerNow()" class="w-full py-6 bg-white text-orange-700 rounded-2xl font-black text-2xl shadow-xl cursor-pointer hover:bg-orange-50 transition">Ø¯ÙˆØ³ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø§Ù„ÙƒØ§Ø±Øª<br><span class="text-sm font-normal text-slate-500">(Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù‡ÙŠØ¨Ø¯Ø£ ÙÙˆØ±Ø§Ù‹!)</span></div></div>`; if (game.phase === 'reading') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-orange-600 text-white text-center"><div class="text-center mb-4"><p class="text-slate-200 mb-1">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰:</p><h2 class="text-2xl font-bold">${escapeHtml(game.player.name)}</h2></div><h2 class="text-3xl font-bold mb-6">${game.card.topic}</h2><div class="bg-white/20 p-6 rounded-2xl w-full mb-8 space-y-4">${game.card.facts.map((fact, i) => `<button onclick="selectLiarFact(${i})" class="w-full p-4 bg-white/10 hover:bg-white/30 rounded-xl text-right ${game.selectedFact === i ? 'ring-4 ring-yellow-300' : ''}"><span class="font-bold">${i + 1}.</span> ${fact}</button>`).join('')}</div><div class="text-5xl font-black mb-6" id="game-timer">${game.timeLeft}</div><button onclick="revealLiarCard()" class="w-full py-4 bg-white text-orange-700 rounded-xl font-bold text-xl" ${game.selectedFact === null ? 'disabled opacity-50' : ''}>ÙƒØ´Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button></div>`; if (game.phase === 'result') { const lieIndex = 2; const isCorrect = game.selectedFact === lieIndex; return `<div class="h-screen flex flex-col items-center justify-center p-6 ${isCorrect ? 'bg-green-600' : 'bg-red-600'} text-white text-center animate-in"><div class="text-6xl mb-6">${isCorrect ? 'âœ“' : 'âœ—'}</div><h2 class="text-3xl font-bold mb-4">${isCorrect ? 'ØµØ­! Ø£Ø­Ø³Ù†Øª!' : 'ØºÙ„Ø·!'}</h2><p class="text-xl mb-8">Ø§Ù„ÙƒØ°Ø¨Ø© ÙƒØ§Ù†Øª: "${game.card.facts[lieIndex]}"</p>${isCorrect ? `<button onclick="updateScore(${game.player.id}, false, 1); nextLiarRound()" class="w-full py-3 bg-white/20 rounded-xl font-bold mb-3">+Ù¡ Ù†Ù‚Ø·Ø©</button>` : state.daresEnabled ? `<button onclick="showDare()" class="w-full py-3 bg-white/20 rounded-xl font-bold mb-3">ğŸ’€ Ø¹Ù‚Ø§Ø¨</button>` : ''}<button onclick="nextLiarRound()" class="w-full py-4 bg-white text-orange-700 rounded-xl font-bold">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button><button onclick="goHome()" class="w-full py-3 bg-slate-800 rounded-xl font-bold mt-3">Ø®Ø±ÙˆØ¬</button></div>`; } }

        // --- AUCTION ---
        function startAuctionGame() { const category = getUniqueItem('auction', AUCTION_CATEGORIES); state.currentGame = { type: 'auction', phase: 'bidding', category, currentBid: 1, timeLeft: 30 }; playSound('click'); render(); }
        function raiseBid() { state.currentGame.currentBid++; playSound('click'); render(); }
        function auctionPass() { state.currentGame.phase = 'select_winner'; state.currentGame.finalBid = state.currentGame.currentBid; playSound('click'); saveState(); render(); }
        function selectAuctionWinner(playerId) { state.currentGame.winnerId = playerId; state.currentGame.phase = 'answering_ready'; state.currentGame.timeLeft = 30; playSound('click'); render(); }
        function startAuctionTimerNow() { state.currentGame.phase = 'answering'; playSound('click'); saveState(); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); auctionFail(); return; } if (state.currentGame.timeLeft <= 10) playSound('tick'); }, 1000); }
        function auctionSuccess() { updateScore(state.currentGame.winnerId, false, state.currentGame.finalBid); startAuctionGame(); }
        function auctionFail() { if (state.daresEnabled) showDare(); startAuctionGame(); }
        function renderAuctionSetup() { if (!state.currentGame || state.currentGame.type !== 'auction') return renderGameStartScreen('Ø§Ù„Ù…Ø²Ø§Ø¯', 'Ø§Ù„ÙØ±ÙŠÙ‚ ÙŠØ±Ø§Ù‡Ù† Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù„ÙŠ ÙŠÙ‚Ø¯Ø± ÙŠÙ‚ÙˆÙ„Ù‡Ø§. Ø§Ù„Ù…Ø²Ø§Ø¯ Ù„Ù„Ø£Ø¹Ù„Ù‰ØŒ ÙˆØ§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙØ§ÙŠØ² Ù„Ø§Ø²Ù… ÙŠÙ†ÙØ°!', 'ğŸ”¨', 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©', 'startAuctionGame()', 'bg-cyan-600'); const game = state.currentGame; if (game.phase === 'bidding') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-cyan-600 text-white text-center"><div class="bg-white/20 p-6 rounded-2xl mb-8 w-full"><div class="text-sm opacity-80 mb-2">Ø§Ù„ÙØ¦Ø©:</div><h2 class="text-3xl font-bold">${game.category.name}</h2></div><div class="text-lg opacity-90 mb-4">Ø£Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ù…Ø²Ø§Ø¯:</div><div class="text-8xl font-black text-yellow-300 mb-8">${game.currentBid}</div><div class="grid grid-cols-2 gap-3 w-full"><button onclick="raiseBid()" class="py-4 bg-white/20 rounded-xl font-bold text-xl">+Ù¡ Ø¹Ù„ÙŠ</button><button onclick="auctionPass()" class="py-4 bg-red-500 rounded-xl font-bold text-xl">Ø¨Ø§Ø³!</button></div></div>`; if (game.phase === 'select_winner') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-cyan-600 text-white text-center animate-in"><div class="text-6xl mb-6">ğŸ”¨</div><h2 class="text-3xl font-bold mb-4">Ø§Ù„Ù…Ø²Ø§Ø¯ Ø®Ù„Øµ!</h2><p class="text-xl opacity-90 mb-2">Ù…Ø·Ù„ÙˆØ¨ <span class="font-black text-yellow-300 text-2xl">${game.finalBid}</span> Ø¥Ø¬Ø§Ø¨Ø©</p><p class="text-lg mb-6 mt-6">Ù…ÙŠÙ† Ø±Ø³Ù‰ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ù…Ø²Ø§Ø¯ØŸ</p><div class="grid grid-cols-2 gap-3 w-full max-h-[50vh] overflow-y-auto">${state.players.map(p => `<button onclick="selectAuctionWinner(${p.id})" class="py-4 bg-white/20 rounded-xl font-bold text-lg hover:bg-white/30 transition">${escapeHtml(p.name)}</button>`).join('')}</div></div>`; if (game.phase === 'answering_ready') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-cyan-600 text-white text-center animate-in"><div class="text-6xl mb-6">ğŸ”¨</div><h2 class="text-3xl font-bold mb-4">Ø¬Ø§Ù‡Ø²ÙŠÙ†ØŸ</h2><p class="text-xl opacity-90 mb-2">Ø§Ù„ÙØ§Ø¦Ø²: <span class="font-black text-yellow-300">${state.players.find(p => p.id === game.winnerId)?.name}</span></p><p class="text-lg opacity-80 mb-4">Ù…Ø·Ù„ÙˆØ¨ <span class="font-black text-yellow-300 text-2xl">${game.finalBid}</span> Ø¥Ø¬Ø§Ø¨Ø©</p><div onclick="startAuctionTimerNow()" class="w-full py-6 mt-8 bg-white text-cyan-700 rounded-2xl font-black text-2xl shadow-xl cursor-pointer hover:bg-cyan-50 transition">Ø¯ÙˆØ³ Ø¹Ø´Ø§Ù† ØªØ¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯Ø§Ø¯</div></div>`; if (game.phase === 'answering') return `<div class="h-screen flex flex-col p-6 bg-cyan-50"><div class="text-center mt-8 mb-8"><h2 class="text-cyan-700 text-lg">Ø§Ù„ÙØ¦Ø©: <span class="font-bold">${game.category.name}</span></h2><div class="text-5xl font-black text-cyan-600 mt-4">Ù„Ø§Ø²Ù… ${game.finalBid} Ø¥Ø¬Ø§Ø¨Ø©!</div></div><div class="flex-1 flex justify-center items-center"><div class="text-8xl font-black text-cyan-600" id="game-timer">${game.timeLeft}</div></div><div class="space-y-3"><button onclick="auctionSuccess()" class="w-full py-4 bg-green-500 text-white rounded-xl font-bold text-xl">âœ“ Ù†Ø¬Ø­!</button><button onclick="auctionFail()" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold">âœ— ÙØ´Ù„!</button></div></div>`; }

        // --- GIBBERISH ---
        function startGibberishGame() { 
            const phrase = getUniqueItem('gibberish', GIBBERISH_DATA);
            const player = getFairPlayer();
            state.currentGame = { type: 'gibberish', phase: 'ready', phrase, player, timeLeft: 30 }; 
            playSound('click'); 
            saveState();
            render(); 
        }
        function startGibberishTimerNow() { state.currentGame.phase = 'playing'; playSound('click'); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); revealGibberishAnswer(); } if (state.currentGame.timeLeft <= 10) playSound('tick'); }, 1000); }
        function revealGibberishAnswer() { state.currentGame.phase = 'answer'; playSound('click'); saveState(); render(); }
        function nextGibberishRound() { startGibberishGame(); }
        function renderGibberishSetup() { if (!state.currentGame || state.currentGame.type !== 'gibberish') return renderGameStartScreen('ÙÙƒ Ø§Ù„Ø´ÙØ±Ø©', 'Ø¬Ù…Ù„ ØºØ±ÙŠØ¨Ø©! Ø§Ù‚Ø±Ø£Ù‡Ø§ Ø¨ØµÙˆØª Ø¹Ø§Ù„ÙŠ ÙƒØ°Ø§ Ù…Ø±Ø© Ù„Ø­Ø¯ Ù…Ø§ ØªÙÙ‡Ù… Ø§Ù„Ù…Ø¹Ù†Ù‰ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ!', 'ğŸ—£ï¸', 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©', 'startGibberishGame()', 'bg-pink-600'); const game = state.currentGame; if (game.phase === 'ready') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-pink-600 text-white text-center animate-in"><p class="text-xl opacity-80 mb-2">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰</p><h1 class="text-4xl font-black mb-8">${escapeHtml(game.player.name)}</h1><div class="text-6xl mb-6">ğŸ—£ï¸</div><h2 class="text-3xl font-bold mb-8">Ø¬Ø§Ù‡Ø² ØªÙÙƒ Ø§Ù„Ø´ÙØ±Ø©ØŸ</h2><div onclick="startGibberishTimerNow()" class="w-full py-6 bg-white text-pink-700 rounded-2xl font-black text-2xl shadow-xl cursor-pointer hover:bg-pink-50 transition">Ø¯ÙˆØ³ Ø¹Ø´Ø§Ù† ØªØ¨Ø¯Ø£<br><span class="text-sm font-normal text-slate-500">(Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù‡ÙŠØ¨Ø¯Ø£ ÙÙˆØ±Ø§Ù‹!)</span></div></div>`; if (game.phase === 'playing') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-pink-600 text-white text-center"><div class="text-center mb-4"><p class="text-slate-200 mb-1">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰:</p><h2 class="text-2xl font-bold">${escapeHtml(game.player.name)}</h2></div><div class="text-sm opacity-80 mb-4">Ø§Ù‚Ø±Ø£Ù‡Ø§ Ø¨ØµÙˆØª Ø¹Ø§Ù„ÙŠ!</div><div class="bg-white/20 p-8 rounded-3xl mb-8"><h1 class="text-4xl font-black">${game.phrase.gibberish}</h1></div><div class="text-6xl font-black mb-8" id="game-timer">${game.timeLeft}</div><button onclick="revealGibberishAnswer()" class="w-full py-4 bg-white text-pink-700 rounded-xl font-bold text-xl">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button></div>`; if (game.phase === 'answer') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-pink-900 text-white text-center"><div class="bg-white/10 p-6 rounded-2xl mb-8"><div class="text-sm opacity-80 mb-2">ÙƒØ§Ù†Øª:</div><div class="text-2xl font-bold mb-4">${game.phrase.gibberish}</div><div class="text-sm opacity-80 mb-2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</div><div class="text-3xl font-black text-yellow-300">${game.phrase.answer}</div></div><button onclick="nextGibberishRound()" class="w-full py-4 bg-pink-500 rounded-xl font-bold text-xl mb-3">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 rounded-xl font-bold">Ø®Ø±ÙˆØ¬</button></div>`; }

        // --- HUM ---
        function startHumGame() { const song = getUniqueItem('hum', HUM_SONGS); const player = getFairPlayer(); state.currentGame = { type: 'hum', phase: 'prepare', song, player, revealed: false, timeLeft: 45 }; playSound('click'); saveState(); render(); }
        function startHumRound() { state.currentGame.phase = 'humming'; playSound('click'); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); humFail(); return; } if (state.currentGame.timeLeft <= 10) playSound('tick'); }, 1000); }
        function humSuccess() { updateScore(state.currentGame.player.id, false, 1); startHumGame(); }
        function humFail() { if (state.daresEnabled) showDare(); startHumGame(); }
        function renderHumSetup() { if (!state.currentGame || state.currentGame.type !== 'hum') return renderGameStartScreen('Ø·Ø±Ø¨Ù†ÙŠ Ø´ÙƒØ±Ø§Ù‹', 'Ù‡Ù…Ù‡Ù… Ø§Ù„Ù„Ø­Ù† Ø¨Ø³! Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„ÙƒÙ„Ù…Ø§Øª. "ØªÙˆ ØªÙˆ Ø±Ùˆ ØªÙˆ" ÙÙ‚Ø·!', 'ğŸµ', 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©', 'startHumGame()', 'bg-yellow-600'); const game = state.currentGame; if (game.phase === 'prepare') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-yellow-600 text-white text-center"><p class="text-xl opacity-80 mb-2">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰</p><h1 class="text-4xl font-black mb-8">${escapeHtml(game.player.name)}</h1><div class="bg-white/10 p-6 rounded-2xl border-2 border-white/20 w-full mb-8 relative overflow-hidden">${!game.revealed ? `<div onclick="state.currentGame.revealed = true; render()" class="absolute inset-0 bg-yellow-700 z-10 flex items-center justify-center cursor-pointer hover:bg-yellow-800 transition"><span class="text-xl font-bold animate-pulse">Ø¯ÙˆØ³ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø§Ù„Ø£ØºÙ†ÙŠØ©</span></div>` : ''}<p class="text-sm mb-2 opacity-75">Ø§Ù„Ø£ØºÙ†ÙŠØ©:</p><h2 class="text-3xl font-bold text-yellow-300">${game.song.song}</h2><p class="text-sm mt-2 opacity-75">Ø§Ù„ØµØ¹ÙˆØ¨Ø©: ${game.song.difficulty}</p></div><button onclick="startHumRound()" class="w-full py-4 bg-white text-yellow-700 rounded-xl font-bold text-xl" ${!game.revealed ? 'disabled opacity-50' : ''}>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù‡Ù…Ù‡Ù…Ø©!</button></div>`; if (game.phase === 'humming') return `<div class="h-screen flex flex-col p-6 bg-yellow-50"><div class="text-center mt-8 mb-8"><h2 class="text-slate-500">Ø§Ù„Ù…Ù‡Ù…Ù‡Ù…: <span class="font-bold text-yellow-700">${escapeHtml(game.player.name)}</span></h2><h1 class="text-3xl font-black text-slate-800 mt-2">${game.song.song}</h1></div><div class="flex-1 flex justify-center items-center"><div class="text-8xl font-black text-yellow-600" id="game-timer">${game.timeLeft}</div></div><div class="space-y-3"><button onclick="humSuccess()" class="w-full py-4 bg-green-500 text-white rounded-xl font-bold text-xl">âœ“ Ø¹Ø±ÙÙˆÙ‡Ø§!</button><button onclick="humFail()" class="w-full py-3 bg-slate-200 text-slate-600 rounded-xl font-bold">Ù…Ø¹Ø±ÙÙˆØ´</button></div></div>`; }

        // --- LIKELY ---
        function startLikelyGame() { const question = getUniqueItem('likely', MOST_LIKELY); state.currentGame = { type: 'likely', phase: 'ready', question, timeLeft: 5 }; playSound('click'); saveState(); render(); }
        function startLikelyTimerNow() { state.currentGame.phase = 'showing'; playSound('click'); saveState(); render(); if (gameInterval) clearInterval(gameInterval); gameInterval = setInterval(() => { state.currentGame.timeLeft--; const t = document.getElementById('game-timer'); if(t) t.innerText = state.currentGame.timeLeft; if (state.currentGame.timeLeft <= 0) { clearInterval(gameInterval); state.currentGame.phase = 'result'; playSound('fail'); saveState(); render(); } else if (state.currentGame.timeLeft <= 5) playSound('tick'); }, 1000); }
        function likelySelectPlayer(playerId) { 
            // Fix: Add scoring logic
            // Selected player gets -1 point (penalty)
            updateScore(playerId, false, -1);
            
            // All OTHER players get +1 point (reward)
            state.players.forEach(player => {
                if (player.id !== playerId) {
                    updateScore(player.id, false, 1);
                }
            });
            
            // Show dare if enabled (for the selected player)
            if (state.daresEnabled) showDare();
            
            // Move to next round
            nextLikelyRound(); 
        }
        function nextLikelyRound() { startLikelyGame(); }
        function renderLikelySetup() { if (!state.currentGame || state.currentGame.type !== 'likely') return renderGameStartScreen('Ù…ÙŠÙ† Ø§Ù„ÙƒØ§Ø±Ø«Ø©ØŸ', 'Ø³Ø¤Ø§Ù„ ÙŠØ¸Ù‡Ø±. ÙÙŠ Ù¥ Ø«ÙˆØ§Ù†ÙŠ ÙƒÙ„ÙƒÙ… ØªØ´Ø§ÙˆØ±ÙˆØ§ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ. Ø§Ù„Ù„ÙŠ Ø§Ù„ÙƒÙ„ Ø´Ø§ÙˆØ± Ø¹Ù„ÙŠÙ‡.. Ø¹Ù‚Ø§Ø¨!', 'ğŸ‘‰', 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©', 'startLikelyGame()', 'bg-red-600'); const game = state.currentGame; if (game.phase === 'ready') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-red-600 text-white text-center animate-in"><div class="text-6xl mb-6">ğŸ‘‰</div><h2 class="text-3xl font-bold mb-8">Ø¬Ø§Ù‡Ø²ÙŠÙ†ØŸ</h2><div onclick="startLikelyTimerNow()" class="w-full py-6 bg-white text-red-700 rounded-2xl font-black text-2xl shadow-xl cursor-pointer hover:bg-red-50 transition">Ø¯ÙˆØ³ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø§Ù„Ø³Ø¤Ø§Ù„<br><span class="text-sm font-normal text-slate-500">(5 Ø«ÙˆØ§Ù†ÙŠ Ø¨Ø³!)</span></div></div>`; if (game.phase === 'showing') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-red-600 text-white text-center"><div class="bg-white/20 p-8 rounded-3xl mb-8 w-full"><h1 class="text-3xl font-black leading-relaxed">${game.question}</h1></div><div class="text-8xl font-black mb-8" id="game-timer">${game.timeLeft}</div><p class="text-xl opacity-90">Ø´Ø§ÙˆØ±ÙˆØ§ Ø¯Ù„ÙˆÙ‚ØªÙŠ! ğŸ‘‰</p></div>`; if (game.phase === 'result') return `<div class="h-screen flex flex-col items-center justify-center p-6 bg-red-900 text-white text-center"><div class="bg-white/10 p-6 rounded-2xl mb-6 w-full"><h3 class="text-sm opacity-75 mb-2">Ø§Ù„Ø³Ø¤Ø§Ù„ ÙƒØ§Ù†:</h3><h1 class="text-2xl font-black leading-relaxed">${game.question}</h1></div><h2 class="text-3xl font-bold mb-8">Ø§ØªÙÙ‚ÙˆØ§ Ø¹Ù„Ù‰ Ù…ÙŠÙ†ØŸ</h2><div class="grid grid-cols-2 gap-3 w-full mb-8">${state.players.map(p => `<button onclick="likelySelectPlayer(${p.id})" class="p-4 bg-white/20 rounded-xl font-bold hover:bg-white/30">${escapeHtml(p.name)}</button>`).join('')}</div><button onclick="nextLikelyRound()" class="w-full py-3 bg-red-500 rounded-xl font-bold">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button><button onclick="goHome()" class="w-full py-3 bg-slate-700 rounded-xl font-bold mt-3">Ø®Ø±ÙˆØ¬</button></div>`; }

        // Update mute button appearance based on state (Glass Bar Design)
        function updateMuteButton() {
            const btn = document.getElementById('muteBtn');
            if (btn) {
                if (state.isMuted) {
                    btn.className = 'w-10 h-10 flex items-center justify-center rounded-full bg-red-500/60 hover:scale-110 hover:bg-red-500/80 transition-all shadow-sm text-white';
                    btn.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>';
                } else {
                    btn.className = 'w-10 h-10 flex items-center justify-center rounded-full bg-white/50 hover:scale-110 hover:bg-white/70 transition-all shadow-sm text-gray-800';
                    btn.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>';
                }
            }
        }
        
        // ===== INIT =====
        // Auto-load on page load using DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            loadState(); // Load saved state from localStorage (includes players array)
            render(); // Trigger render to display the loaded data
            updateMuteButton(); // Update mute button appearance
        });
    </script>
</body>
</html>
